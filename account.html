<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="cjf-build" content="account-card-2025-12-16" />
  <title>Account | CJF Rentals</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="assets/style.css" />
    <style>
    :root {
      --page-bg: #f6f7fb;
      --card-bg: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --accent: #2563eb;
      --radius: 18px;
      --shadow: 0 20px 45px rgba(15, 23, 42, 0.12);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Manrope", sans-serif;
      background: var(--page-bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
    }
    .no-scroll { overflow: hidden; }

    a { color: var(--accent); text-decoration: none; }

    .page-shell {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 24px;
      padding-bottom: 80px;
    }

    /* Header */
    .topbar {
      position: sticky;
      top: 0;
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid #e5e7eb;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 800;
      font-size: 16px;
    }
    .brand > span { display: inline-flex !important; }
    .brand .brand-mark,
    .brand .logo {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      background: #0f172a;
      color: #fff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
    }

    .menu-button {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      background: #fff;
      font-size: 18px;
    }

    /* Profile */
    .profile-card {
      padding: 0;
      background: transparent;
      box-shadow: none;
      border: none;
      margin-top: 16px;
    }

    /* Account header card (match public host profile card) */
    .account-host-card {
      background: var(--card-bg);
      border-radius: 16px;
      border: 1px solid var(--stroke);
      padding: 24px;
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 24px;
      align-items: center;
      box-shadow: var(--shadow);
    }

    .host-avatar-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    .avatar-shell {
      position: relative;
      width: 96px;
      height: 96px;
      border-radius: 12px;
      border: 3px solid var(--accent);
      overflow: hidden;
      cursor: pointer;
    }

    #avatarImage {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 12px;
    }

    #avatarUpload {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.45);
      color: #fff;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s;
      border-radius: 12px;
    }

    .avatar-shell:hover #avatarUpload { opacity: 1; }

    .host-verified {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 14px;
      color: var(--accent);
      font-weight: 600;
    }

    .host-info {
      display: grid;
      gap: 12px;
    }

    .host-header-text h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 800;
    }

    .host-header-text p {
      margin: 4px 0 0;
      color: var(--muted);
      font-size: 16px;
    }

    .host-rating {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }

    .stars { color: var(--accent); font-size: 14px; }
    .rating-count { color: var(--muted); }

    .host-location {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: var(--muted);
    }

    .host-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--stroke);
    }

    .stat-item { display: grid; gap: 4px; text-align: center; }
    .stat-value { font-size: 24px; font-weight: 800; color: var(--accent); }
    .stat-label { font-size: 12px; color: var(--muted); text-transform: uppercase; }

    .host-actions { display: grid; gap: 12px; }

    .host-name {
      font-size: 24px;
      font-weight: 800;
      margin: 6px 0 2px;
    }

    .host-subtitle {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
    }

    .host-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: flex-start;
      margin-top: 8px;
    }

    .badge {
      padding: 6px 12px;
      background: #f1f5f9;
      border: 1px solid #e2e8f0;
      border-radius: 999px;
      font-weight: 700;
      font-size: 13px;
      color: #334155;
    }

    .badge.verified {
      background: #eef2ff;
      border-color: #c7d2fe;
      color: #4338ca;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
    }

    /* old stats-card removed (stats are inside account-host-card now) */

    .subscription-card {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .plan-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      background: #eef2ff;
      border: 1px solid #c7d2fe;
      border-radius: 12px;
      font-weight: 700;
      color: #312e81;
    }

    .plan-actions { display: flex; gap: 10px; flex-wrap: wrap; }

    .vehicles-section { display: flex; flex-direction: column; gap: 14px; }

    .section-header {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    .section-title { margin: 0; font-size: 20px; font-weight: 800; }
    .subtext { color: var(--muted); font-size: 14px; margin: 0; }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 14px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 14px;
      border: 1px solid transparent;
      text-decoration: none;
      min-height: 44px;
      cursor: pointer;
    }

    .btn-primary { background: var(--accent); color: #fff; }
    .btn-secondary { background: #f8fafc; color: var(--text); border-color: #e2e8f0; }
    .btn-ghost { background: transparent; color: var(--text); border-color: #e2e8f0; }
    .btn-danger { background: #fef2f2; color: #b91c1c; border-color: #fecdd3; }
    .btn-full { width: 100%; }

    .vehicles-grid { display: flex; flex-direction: column; gap: 16px; }

    .vehicle-card {
      border: 1px solid #e2e8f0;
      border-radius: var(--radius);
      background: var(--card-bg);
      overflow: hidden;
      box-shadow: var(--shadow);
      cursor: pointer;
    }

    .vehicle-card:focus-visible {
      outline: 3px solid rgba(37, 99, 235, 0.35);
      outline-offset: 2px;
    }

    .vehicle-media { position: relative; width: 100%; padding-top: 56%; background: #e5e7eb; overflow: hidden; }
    .vehicle-media img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; }
    .vehicle-type-badge { position: absolute; top: 12px; left: 12px; background: rgba(255,255,255,0.9); border-radius: 10px; padding: 6px 10px; font-weight: 700; font-size: 12px; }
    .vehicle-availability-badge { position: absolute; top: 12px; right: 12px; border-radius: 10px; padding: 6px 10px; font-weight: 800; font-size: 12px; border: 1px solid rgba(15,23,42,0.12); }
    .vehicle-availability-badge.available { background: rgba(34, 197, 94, 0.12); color: #166534; border-color: rgba(34, 197, 94, 0.22); }
    .vehicle-availability-badge.rented { background: rgba(239, 68, 68, 0.12); color: #991b1b; border-color: rgba(239, 68, 68, 0.22); }
    .vehicle-availability-badge.paused { background: rgba(100, 116, 139, 0.12); color: #334155; border-color: rgba(100, 116, 139, 0.22); }

    .vehicle-content { padding: 14px; display: flex; flex-direction: column; gap: 10px; }
    .vehicle-title { margin: 0; font-size: 18px; font-weight: 800; }
    .vehicle-location { margin: 0; color: var(--muted); font-size: 13px; }

    .vehicle-tags { display: flex; flex-wrap: wrap; gap: 8px; }
    .feature-tag {
      padding: 6px 10px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      color: #475569;
    }

    .vehicle-price { font-size: 20px; font-weight: 800; }
    .vehicle-price .period { font-size: 13px; color: var(--muted); font-weight: 600; }

    .vehicle-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .reviews-card { display: grid; gap: 14px; }
    #reviewsEmpty { text-align: center; }
    .empty-icon { font-size: 24px; color: #f59e0b; }

    .review-invite {
      border: 1px solid #e2e8f0;
      background: #fff;
      border-radius: 16px;
      padding: 16px;
      display: grid;
      gap: 12px;
    }
    .review-invite-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      align-items: end;
    }
    .review-invite input, .review-invite select {
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #e2e8f0;
      font-size: 14px;
      background: #f8fafc;
      width: 100%;
    }
    .review-invite-actions { display: flex; gap: 10px; flex-wrap: wrap; }
    .review-invite-output { display: grid; gap: 8px; }
    .review-invite-row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
    }
    .reviews-list { display: grid; gap: 12px; }
    .review-item {
      border: 1px solid #e2e8f0;
      border-radius: 14px;
      padding: 12px 14px;
      background: #fff;
    }
    .review-item-top { display:flex; justify-content: space-between; gap: 10px; align-items: baseline; }
    .review-item-name { font-weight: 800; }
    .review-item-meta { color: #64748b; font-size: 12px; margin-top: 2px; }
    .review-item-stars { color: #f59e0b; white-space: nowrap; font-size: 14px; }
    .review-item-text { margin-top: 10px; font-size: 14px; line-height: 1.45; }
    .pill-inline { display:inline-flex; align-items:center; gap:6px; padding: 4px 10px; border-radius: 999px; border: 1px solid #e2e8f0; background: #f8fafc; font-size: 12px; font-weight: 700; color: #0f172a; }
    @media (max-width: 640px) {
      .review-invite-grid { grid-template-columns: 1fr; }
      .review-invite-row { grid-template-columns: 1fr; }
    }

    /* Menu / backdrop */
    .backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.45);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      z-index: 300;
    }
    .backdrop.show { opacity: 1; pointer-events: auto; }

    .menu-panel {
      position: fixed;
      top: 0; right: -320px; bottom: 0;
      width: 280px;
      background: #fff;
      box-shadow: -10px 0 30px rgba(15,23,42,0.2);
      z-index: 400;
      transition: right 0.25s ease;
      padding: 20px;
      overflow-y: auto;
    }
    .menu-panel.open { right: 0; }
    .menu-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .menu-title { font-weight: 800; }
    .menu-close { background:none; border:1px solid #e2e8f0; width:32px; height:32px; border-radius:8px; }
    .menu-list { list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:10px; }

    /* Cover editor overlay */
    .cover-editor-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 1200;
    }
    .cover-editor {
      width: min(960px, 100%);
      max-height: 90vh;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 24px 60px rgba(0,0,0,0.35);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .cover-editor-header,
    .cover-editor-footer {
      padding: 14px 16px;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      background: #fff;
    }
    .cover-editor-footer { border-top: 1px solid #e2e8f0; border-bottom: none; }
    .cover-editor-body { padding: 16px; display: flex; flex-direction: column; gap: 14px; }
    .cover-preview-frame { position: relative; width: 100%; height: min(60vh, 520px); min-height: 320px; border-radius: 12px; overflow: hidden; background: #0f172a; }
    .cover-preview-frame img { width: 100%; height: 100%; object-fit: cover; cursor: grab; touch-action: none; }
    .cover-preview-frame.dragging img { cursor: grabbing; }
    .cover-header-mask { position: absolute; inset: 0; pointer-events: none; background: linear-gradient(180deg, rgba(0,0,0,0.4) 0%, rgba(0,0,0,0) 60%); }
    .cover-controls { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }

    @media (min-width: 768px) {
      .page-shell { padding: 24px 20px 100px; gap: 28px; }
      .profile-card { padding: 0; }
      .vehicles-grid { flex-direction: row; display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); }
    }

    @media (max-width: 768px) {
      .account-host-card { grid-template-columns: 1fr; text-align: center; }
      .host-badges { justify-content: center; }
      .host-stats { grid-template-columns: 1fr; }
    }

    /* Modal / forms */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 1000; }
    .modal-overlay.show { opacity: 1; pointer-events: auto; }
    .modal { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; padding: 24px; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 1001; }
    .modal.show { opacity: 1; pointer-events: auto; }
    .modal-panel { width: 100%; max-width: 700px; max-height: 90vh; background: #fff; border-radius: 16px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); display: flex; flex-direction: column; }
    .modal-header { padding: 20px 24px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
    .modal-close { background: none; border: none; width: 32px; height: 32px; border-radius: 6px; font-size: 20px; cursor: pointer; }
    .modal-body { padding: 24px; overflow: auto; flex: 1; }

    .upload-section { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px; }
    .upload-box { border: 2px dashed #cbd5e1; border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden; }
    .upload-box:hover { border-color: #3b82f6; background: #f8fafc; }
    .upload-box img { width: 100%; height: 120px; object-fit: cover; border-radius: 8px; margin-bottom: 12px; }
    .upload-box.avatar img { border-radius: 50%; width: 120px; height: 120px; margin: 0 auto 12px; }
    .upload-label { font-size: 14px; font-weight: 600; color: #475569; display: block; margin-bottom: 8px; }
    .upload-hint { font-size: 12px; color: #94a3b8; }

    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .form-field { display: flex; flex-direction: column; gap: 6px; }
    .form-field label { font-size: 13px; font-weight: 700; color: #475569; }
    .form-field input, .form-field textarea, .form-field select {
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #e2e8f0;
      font-size: 14px;
      background: #f8fafc;
    }
    textarea { min-height: 100px; }

    .modal-footer { padding: 16px 24px; border-top: 1px solid #e2e8f0; display: flex; gap: 12px; justify-content: flex-end; }

    @media (max-width: 640px) {
      .upload-section { grid-template-columns: 1fr; }
      .form-grid { grid-template-columns: 1fr; }
      .menu-button { width: 36px; height: 36px; }
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
</head>
<body>
  <!-- Sticky Site Header -->
  <meta name="cjf-build" content="account-card-2025-12-16" />
  <header class="topbar">
    <a class="brand" href="index.html">
      <span class="brand-mark">CJF</span>
      <span class="brand-name" id="welcomeGreeting" style="color:#0f172a;">Welcome</span>
    </a>
    <button class="menu-button" id="menuToggle" aria-label="Open menu">☰</button>
  </header>

  <div class="backdrop" id="backdrop"></div>
  <nav class="menu-panel" id="menuPanel" role="dialog" aria-label="Navigation">
    <div class="menu-header">
      <span class="menu-title">Navigation</span>
      <button class="menu-close" id="menuClose" aria-label="Close menu"></button>
    </div>
    <ul class="menu-list" id="nav-list">
      <!-- Menu items built dynamically by navBuilder.js -->
    </ul>
  </nav>

    <main class="page-shell">
    <section class="profile-card">
      <div class="account-host-card">
        <div class="host-avatar-container">
          <div class="avatar-shell" id="avatarContainer">
            <img id="avatarImage" src="" alt="Host avatar" />
            <div id="avatarUpload" style="display:none;">Change</div>
          </div>
          <div class="host-verified" id="accountVerificationBadge" style="display:none;">Verified</div>
        </div>

        <div class="host-info">
          <div class="host-header-text">
            <h1 id="hostName">Loading...</h1>
            <p id="hostOwnerTypeText">Vehicle Owner</p>
          </div>

          <div class="host-rating">
            <span class="stars" id="hostStars">★★★★★</span>
            <span class="rating-count">
              <span id="hostRatingValue">5.0</span>
              (<span id="hostReviewCount">0</span> reviews)
            </span>
          </div>

          <div class="host-location" id="hostLocationRow" style="display:none;">
            <span id="hostLocationText"></span>
          </div>

          <div class="host-badges" id="hostBadges">
            <span class="badge verified" id="verifiedHostBadge">Verified Host</span>
            <span class="badge">Worldwide Platform</span>
          </div>

          <div class="host-stats">
            <div class="stat-item">
              <div class="stat-value" id="statVehicles">0</div>
              <div class="stat-label">Vehicles</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="statYears">-</div>
              <div class="stat-label">Member Since</div>
            </div>
          </div>
        </div>

        <div class="host-actions">
          <button class="btn btn-primary" id="editProfileBtn" type="button">Edit Profile</button>
        </div>
      </div>
    </section>

    <section class="card subscription-card">
      <div class="section-header">
        <div>
          <h2 class="section-title">Hosting plan</h2>
          <p class="subtext">Manage your active vehicle limits.</p>
        </div>
        <a href="upgrade.html" class="btn btn-primary" id="upgradeLink" style="display:none;">Manage plan</a>
      </div>
      <div class="plan-chip" id="planStatus">Loading plan...</div>
    </section>

    <section class="card vehicles-section">
      <div class="section-header">
        <div>
          <h2 class="section-title" id="vehiclesSectionTitle">My Vehicles</h2>
          <p class="subtext">Manage your active listings.</p>
        </div>
        <a href="add-vehicle.html" class="btn btn-primary" id="addVehicleBtn">+ Add new vehicle</a>
      </div>
      <div class="vehicles-grid" id="vehiclesGrid"></div>
    </section>

    <section class="card reviews-card">
      <div class="section-header">
        <div>
          <h2 class="section-title">Reviews</h2>
          <p class="subtext">Generate a verified link customers can use to leave a review.</p>
        </div>
      </div>

      <div class="review-invite" id="reviewInvite">
        <div class="review-invite-grid">
          <div class="form-field">
            <label for="reviewVehicleSelect">Vehicle (optional)</label>
            <select id="reviewVehicleSelect">
              <option value="">Any vehicle</option>
            </select>
          </div>
          <div class="form-field">
            <label for="reviewCustomerLabel">Customer label (optional)</label>
            <input id="reviewCustomerLabel" type="text" placeholder="e.g. John (Dec 10 rental)" />
          </div>
        </div>

        <div class="review-invite-actions">
          <button class="btn btn-primary" id="generateReviewLinkBtn" type="button">Generate review link</button>
        </div>

        <div class="review-invite-output" id="reviewInviteOutput" style="display:none;">
          <div class="review-invite-row">
            <input id="reviewInviteLink" type="text" readonly />
            <button class="btn btn-secondary" id="copyReviewLinkBtn" type="button">Copy</button>
          </div>
          <p class="subtext" id="reviewInviteMeta"></p>
        </div>
      </div>

      <div class="reviews-list" id="reviewsList" style="display:none;"></div>

      <div id="reviewsEmpty">
        <div class="empty-icon">★</div>
        <div style="font-weight:700; font-size:16px; margin-top:6px;">No reviews yet</div>
        <div style="color:#64748b; font-size:13px; margin-top:4px;">Complete your first rental to start building trust.</div>
      </div>
    </section>
  </main>

  <!-- Edit Profile Modal -->
  <div id="profileModalOverlay" class="modal-overlay"></div>
  <div id="profileModal" class="modal">
    <div class="modal-panel">
      <div class="modal-header">
        <h2>Edit Profile</h2>
        <button class="modal-close" id="modalClose" aria-label="Close">×</button>
      </div>
      <div class="modal-body">
        <div class="upload-section">
          <label class="upload-box avatar" for="avatarInput">
            <img id="avatarPreview" src="" alt="" style="display:none;" />
            <span class="upload-label">Profile Photo</span>
            <span class="upload-hint">Click to upload</span>
            <input type="file" id="avatarInput" accept="image/*" style="display:none;" />
          </label>
        </div>
        <form class="form-grid" id="profileForm">
          <div class="form-field">
            <label>First Name</label>
            <input type="text" id="firstName" required />
          </div>
          <div class="form-field">
            <label>Last Name</label>
            <input type="text" id="lastName" required />
          </div>
          <div class="form-field">
            <label>Business / Role</label>
            <input type="text" id="role" placeholder="e.g., Business Owner" />
          </div>
          <div class="form-field">
            <label>Phone</label>
            <input type="tel" id="phone" />
          </div>
          <div class="form-field">
            <label>Email</label>
            <input type="email" id="email" required />
          </div>
          <div class="form-field">
            <label>City</label>
            <input type="text" id="city" />
          </div>
          <div class="form-field">
            <label>State</label>
            <input type="text" id="state" />
          </div>
          <div class="form-field">
            <label>Country</label>
            <input type="text" id="country" />
          </div>
          <div class="form-field full">
            <label>About / Bio</label>
            <textarea id="about" rows="4" placeholder="Tell guests about yourself and your hosting experience..."></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" id="modalCancel">Cancel</button>
        <button class="btn btn-primary" id="modalSave">Save Changes</button>
      </div>
    </div>
  </div>

  <audio id="accountPreviewAudio" src="assets/preview.mp3" preload="auto" hidden></audio>

  <!-- Firebase CDN FIRST -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
  <!-- Then our custom scripts -->
  <script src="assets/firebase.js?v=3"></script>
  <script src="assets/auth.js?v=3"></script>
  <script src="assets/vehicleStore.js?v=3"></script>
  <script src="assets/navBuilder.js?v=3"></script>
  <script>
    // Play `assets/preview.mp3` once when a host opens the account page (best-effort autoplay).
    let accountPreviewPlayed = false;
    function shouldPlayAccountPreview() {
      try {
        if (window.AuthManager && typeof AuthManager.isHost === 'function') return AuthManager.isHost();
      } catch {}
      return !!window.firebaseAuth?.currentUser;
    }
    function playAccountPreviewOnce() {
      if (accountPreviewPlayed) return;
      if (!shouldPlayAccountPreview()) return;
      const audio = document.getElementById('accountPreviewAudio');
      if (!audio) return;

      accountPreviewPlayed = true;
      try { audio.currentTime = 0; } catch {}

      try {
        const p = audio.play();
        if (p && typeof p.catch === 'function') {
          p.catch(() => {
            // Autoplay blocked: play on first user interaction instead.
            const onFirstGesture = () => { try { audio.play(); } catch {} };
            document.addEventListener('pointerdown', onFirstGesture, { once: true });
            document.addEventListener('keydown', onFirstGesture, { once: true });
          });
        }
      } catch {}
    }

    // Menu toggle
    const menuPanel = document.getElementById('menuPanel');
    const backdrop = document.getElementById('backdrop');
    const menuToggle = document.getElementById('menuToggle');
    const menuClose = document.getElementById('menuClose');

    menuToggle?.addEventListener('click', () => {
      menuPanel.classList.add('open');
      backdrop.classList.add('show');
    });

    menuClose?.addEventListener('click', () => {
      menuPanel.classList.remove('open');
      backdrop.classList.remove('show');
    });

    backdrop?.addEventListener('click', () => {
      menuPanel.classList.remove('open');
      backdrop.classList.remove('show');
    });

    // Auth state
    if (document.readyState !== 'loading' && typeof AuthManager !== 'undefined' && typeof AuthManager.updateUIForRole === 'function') {
      AuthManager.updateUIForRole();
    }
    document.addEventListener('DOMContentLoaded', () => {
      if (typeof AuthManager !== 'undefined' && typeof AuthManager.updateUIForRole === 'function') {
        AuthManager.updateUIForRole();
      }
    });

    // Also listen for auth state changes from auth.js
    document.addEventListener('authStateChanged', () => {
      if (typeof AuthManager !== 'undefined' && typeof AuthManager.updateUIForRole === 'function') {
        AuthManager.updateUIForRole();
      }
    });

    // Profile data management
    let currentUser = null;
    let profileData = null;
    let authCheckComplete = false;
    // Cover photo removed
    const PLAN_LIMITS = { free: 2, starter: 5, pro: Number.MAX_SAFE_INTEGER };
    const PLAN_LABELS = { free: 'Free (2 vehicles)', starter: 'Starter (5 vehicles)', pro: 'Pro (Unlimited)' };

    async function getUserPlanKey() {
      const db = window.firebaseDb || null;
      const uid = window.firebaseAuth?.currentUser?.uid || null;
      if (db && uid) {
        try {
          const snap = await db.collection('users').doc(uid).get();
          if (snap.exists && snap.data().plan) {
            const plan = snap.data().plan.toLowerCase();
            return PLAN_LIMITS[plan] ? plan : 'free';
          }
        } catch (e) {
          console.warn('Plan fetch failed, defaulting to free', e.message);
        }
      }
      return 'free';
    }

    async function refreshPlanStatus(countFromList) {
      const planStatusEl = document.getElementById('planStatus');
      const upgradeLink = document.getElementById('upgradeLink');
      const addBtn = document.getElementById('addVehicleBtn');
      if (!planStatusEl || !addBtn) return;

      const isAdminUser = (() => {
        try {
          if (window.AuthManager && typeof AuthManager.isAdmin === 'function') return AuthManager.isAdmin();
        } catch {}
        const email = (window.firebaseAuth?.currentUser?.email || '').toLowerCase().trim();
        return email === 'cjfvehicles@gmail.com';
      })();

      if (isAdminUser) {
        planStatusEl.textContent = 'Admin: Unlimited vehicles (free)';
        addBtn.classList.remove('btn-disabled');
        addBtn.href = 'add-vehicle.html';
        addBtn.textContent = '+ Add new vehicle';
        if (upgradeLink) upgradeLink.style.display = 'none';
        return;
      }

      const planKey = await getUserPlanKey();
      const limit = PLAN_LIMITS[planKey] ?? 2;
      const vehicles = typeof countFromList === 'number' ? countFromList : (parseInt(document.getElementById('statVehicles')?.textContent || '0', 10) || 0);

      // Fetch lifetime created to enforce free cap
      let lifetimeCreated = 0;
      try {
        const uid = firebase.auth().currentUser.uid;
        const snap = await firebase.firestore().collection('users').doc(uid).get();
        const remote = snap.exists ? (snap.data().vehiclesCreated || 0) : 0;
        const local = parseInt(localStorage.getItem(`CJF_VEHICLES_CREATED_${uid}`) || '0', 10) || 0;
        lifetimeCreated = Math.max(remote, local);
      } catch {}

      const usedText = limit === Number.MAX_SAFE_INTEGER ? `${vehicles} active (Unlimited plan)` : `${vehicles} / ${limit} active`;
      planStatusEl.textContent = `Plan: ${PLAN_LABELS[planKey] || 'Free'} — ${usedText}`;

      const freeExhausted = planKey === 'free' && lifetimeCreated >= 2;
      const overActive = limit !== Number.MAX_SAFE_INTEGER && vehicles >= limit;
      if (freeExhausted || overActive) {
        addBtn.classList.add('btn-disabled');
        addBtn.href = 'upgrade.html';
        addBtn.textContent = 'Upgrade to add more';
        addBtn.style.pointerEvents = 'auto';
        if (upgradeLink) upgradeLink.style.display = 'inline-flex';
        if (freeExhausted) planStatusEl.textContent = 'You used your 2 free postings. Upgrade to add more vehicles.';
      } else {
        addBtn.classList.remove('btn-disabled');
        addBtn.href = 'add-vehicle.html';
        addBtn.textContent = '+ Add new vehicle';
        if (upgradeLink) upgradeLink.style.display = 'none';
      }
    }

    async function loadProfile() {
      // Wait for Firebase Auth to initialize
      if (!window.firebaseAuth) {
        console.log('Waiting for Firebase Auth to initialize...');
        setTimeout(loadProfile, 100);
        return;
      }

      // Use onAuthStateChanged for reliable auth detection
      if (!authCheckComplete) {
        authCheckComplete = true;
        window.firebaseAuth.onAuthStateChanged(async (user) => {
          // CRITICAL: If force sign-out is pending, treat as logged out
          const forceSignOut = localStorage.getItem('_forceSignOut') === 'true';
          
          if (forceSignOut) {
            console.log(' Force sign-out detected on account page - redirecting to signin');
            window.location.href = 'signin.html';
            return;
          }
          
          if (!user) {
            console.log('No user authenticated, redirecting to signin...');
            // Clear the intentional sign-out flag since we're redirecting now
            localStorage.removeItem('_userSignedOutIntentionally');
            window.location.href = 'signin.html';
            return;
          }
          
          playAccountPreviewOnce();
          currentUser = user.uid;
          await initializeProfile(user.uid);
        });
        return;
      }
    }

    async function initializeProfile(uid) {
      currentUser = uid;

      // Show upload buttons only for own profile
      document.getElementById('avatarUpload').style.display = 'flex';
      document.getElementById('addVehicleBtn').style.display = 'block';

      // Load profile from Firestore
      const db = window.firebaseDb;
      if (db) {
        try {
          const doc = await db.collection('users').doc(uid).get();
          if (doc.exists) {
            profileData = doc.data();
            displayProfile(profileData);
          } else {
            // Create default profile
            profileData = {
              firstName: 'Host',
              lastName: 'User',
              role: 'Business Owner',
              displayName: 'Host User',
              name: 'Host User',
              phone: '',
              email: window.firebaseAuth.currentUser.email || '',
              city: '',
              state: '',
              country: '',
              about: '',
              avatar: null,
              createdAt: new Date().toISOString()
            };
            await db.collection('users').doc(uid).set(profileData);
            displayProfile(profileData);
          }
        } catch (e) {
          console.error('Failed to load profile:', e);
        }
      }

      // Load vehicles
      await loadVehicles();
      // Load recent reviews (if any)
      await loadHostReviews(uid);
    }

    function displayProfile(data) {
      console.log(' displayProfile called with:', data);
      const fullName = `${data.firstName || ''} ${data.lastName || ''}`.trim() || 'Host User';
      const welcomeEl = document.getElementById('welcomeGreeting');
      if (welcomeEl) welcomeEl.textContent = `Welcome, ${fullName}`;

      document.getElementById('hostName').textContent = fullName;
      const ownerType = (data.role || '').trim() || 'Vehicle Owner';
      document.getElementById('hostOwnerTypeText').textContent = ownerType;

      const location = [data.city, data.state, data.country].filter(Boolean).join(', ');
      const locationRow = document.getElementById('hostLocationRow');
      const locationText = document.getElementById('hostLocationText');
      if (locationText) locationText.textContent = location || '';
      if (locationRow) locationRow.style.display = location ? 'flex' : 'none';

      // Avatar
      const avatarImg = document.getElementById('avatarImage');
      if (data.avatar) {
        console.log(' Setting avatar src to:', data.avatar);
        console.log(' Avatar img element:', avatarImg);
        avatarImg.src = data.avatar;
        avatarImg.onerror = () => console.error(' Avatar failed to load. URL:', data.avatar);
        avatarImg.onload = () => console.log(' Avatar loaded successfully');
      } else {
        const fallbackUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(fullName)}&size=200&background=3b82f6&color=fff`;
        console.log(' No avatar in data, using fallback:', fallbackUrl);
        avatarImg.src = fallbackUrl;
      }

      // Verification badge (match public host profile logic)
      const verified = !!(data.email && data.phone);
      document.getElementById('accountVerificationBadge').style.display = verified ? 'flex' : 'none';
      const verifiedBadge = document.getElementById('verifiedHostBadge');
      if (verifiedBadge) verifiedBadge.style.display = verified ? 'inline-flex' : 'none';

      // Rating (match public host profile fields)
      const ratingAvg = Number(data.ratingAvg || data.avgRating || data.rating || 0);
      const ratingCount = Number(data.ratingCount || data.reviewCount || data.reviewsCount || 0);
      document.getElementById('hostRatingValue').textContent = (ratingAvg > 0 ? ratingAvg : 5).toFixed(1);
      document.getElementById('hostReviewCount').textContent = String(ratingCount || 0);

      // Member since
      let createdYear = '—';
      if (data.createdAt) {
        const ts = data.createdAt.seconds ? data.createdAt.seconds * 1000 : data.createdAt;
        const dt = new Date(ts);
        if (!Number.isNaN(dt.getTime())) createdYear = String(dt.getFullYear());
      }
      document.getElementById('statYears').textContent = createdYear;
    }

  async function loadVehicles() {
    const uid = window.firebaseAuth?.currentUser?.uid;
    if (!uid || !window.VehicleStore) return;

    try {
      const vehicles = await window.VehicleStore.getUserVehicles();
      document.getElementById('statVehicles').textContent = vehicles.length;
      populateReviewInviteVehicles(vehicles);

        // Display vehicles
      const grid = document.getElementById('vehiclesGrid');
      grid.innerHTML = '';

      if (vehicles.length === 0) {
        grid.innerHTML = '<p style="grid-column: 1/-1; text-align:center; color: #64748b; padding: 40px;">No vehicles yet. <a href="add-vehicle.html" style="color: #3b82f6;">Add your first vehicle</a></p>';
        return;
      }

        // Render vehicle cards
      vehicles.forEach(vehicle => {
        const card = createVehicleCard(vehicle);
        grid.appendChild(card);
      });
      await refreshPlanStatus(vehicles.length);

    } catch (e) {
      console.error('Failed to load vehicles:', e);
    }
  }

    function populateReviewInviteVehicles(vehicles) {
      const select = document.getElementById('reviewVehicleSelect');
      if (!select) return;
      const safe = Array.isArray(vehicles) ? vehicles : [];
      const current = select.value || '';

      const labelFor = (v) => {
        const title = `${v.year || ''} ${v.make || ''} ${v.model || ''}`.trim();
        return title || v.title || v.name || v.id || 'Vehicle';
      };

      // Cache labels for review rendering (vehicleId -> name)
      window.__reviewVehicleLabelById = Object.fromEntries(
        safe
          .filter(v => v && v.id)
          .map(v => [String(v.id), labelFor(v)])
      );

      select.innerHTML = '<option value="">Any vehicle</option>' + safe
        .map(v => `<option value="${String(v.id || '')}">${labelFor(v)}</option>`)
        .join('');

      if ([...select.options].some(o => o.value === current)) select.value = current;
    }

    const REVIEW_INVITE_API_BASES = window.location.hostname === 'localhost'
      ? ['/api']
      : ['/api', 'https://cjf-api-864727255016.us-east1.run.app/api'];

    const reviewInviteFetch = async (path, options = {}) => {
      let lastErr = null;
      for (const base of REVIEW_INVITE_API_BASES) {
        const url = `${base}${path}`;
        try {
          const resp = await fetch(url, options);
          if (resp.ok) return resp;
          const body = await resp.text().catch(() => '');
          lastErr = new Error(`HTTP ${resp.status}: ${body || resp.statusText}`);
        } catch (e) {
          lastErr = e;
        }
      }
      throw lastErr || new Error('Request failed');
    };

    const escapeHtml = (value) => String(value)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');

    const copyToClipboard = async (text) => {
      try {
        await navigator.clipboard.writeText(text);
        return true;
      } catch {
        try {
          const ta = document.createElement('textarea');
          ta.value = text;
          ta.style.position = 'fixed';
          ta.style.left = '-9999px';
          document.body.appendChild(ta);
          ta.select();
          const ok = document.execCommand('copy');
          document.body.removeChild(ta);
          return ok;
        } catch {
          return false;
        }
      }
    };

    async function generateReviewInvite() {
      const btn = document.getElementById('generateReviewLinkBtn');
      const out = document.getElementById('reviewInviteOutput');
      const linkEl = document.getElementById('reviewInviteLink');
      const metaEl = document.getElementById('reviewInviteMeta');
      const vehicleSel = document.getElementById('reviewVehicleSelect');
      const labelEl = document.getElementById('reviewCustomerLabel');

      if (!btn || !out || !linkEl || !metaEl) return;

      const user = window.firebaseAuth?.currentUser;
      if (!user) {
        alert('Please sign in again.');
        window.location.href = 'signin.html';
        return;
      }

      btn.disabled = true;
      const prevText = btn.textContent;
      btn.textContent = 'Generating...';

      try {
        const idToken = await user.getIdToken();
        const vehicleId = vehicleSel?.value ? String(vehicleSel.value) : null;
        const customerLabel = (labelEl?.value || '').trim() || null;

        const resp = await reviewInviteFetch('/review-tokens', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${idToken}`,
            'Accept': 'application/json'
          },
          body: JSON.stringify({ vehicleId, customerLabel })
        });

        const data = await resp.json().catch(() => null);
        if (!data?.success || !data?.token) {
          throw new Error(data?.error || 'Failed to generate a review link.');
        }

        const token = String(data.token);
        const link = `${window.location.origin}/review.html?token=${encodeURIComponent(token)}`;
        linkEl.value = link;
        out.style.display = 'grid';

        let expiresText = '';
        try { expiresText = data.expiresAt ? new Date(data.expiresAt).toLocaleString() : ''; } catch {}
        metaEl.textContent = expiresText ? `Expires: ${expiresText}` : 'Link generated.';
      } catch (e) {
        console.error('Review link generation failed:', e);
        alert(e?.message || 'Failed to generate review link.');
      } finally {
        btn.disabled = false;
        btn.textContent = prevText;
      }
    }

    document.getElementById('generateReviewLinkBtn')?.addEventListener('click', generateReviewInvite);
    document.getElementById('copyReviewLinkBtn')?.addEventListener('click', async () => {
      const link = document.getElementById('reviewInviteLink')?.value || '';
      if (!link) return;
      const ok = await copyToClipboard(link);
      if (!ok) alert('Copy failed. Please select the link and copy manually.');
    });

    function renderStars(rating) {
      const r = Math.max(0, Math.min(5, Math.round(Number(rating) || 0)));
      return '★'.repeat(r) + '☆'.repeat(5 - r);
    }

    function safeDate(iso) {
      try { return iso ? new Date(iso).toLocaleDateString() : ''; } catch { return ''; }
    }

    async function loadHostReviews(hostId) {
      const listEl = document.getElementById('reviewsList');
      const emptyEl = document.getElementById('reviewsEmpty');
      if (!listEl) return;

      listEl.style.display = 'none';
      listEl.innerHTML = '';

      if (!hostId) return;

      try {
        const resp = await reviewInviteFetch(`/hosts/${encodeURIComponent(String(hostId))}/reviews?limit=50`, {
          headers: { 'Accept': 'application/json' }
        });
        const data = await resp.json().catch(() => null);
        const reviews = data?.success ? (data.data || []) : [];
        const list = Array.isArray(reviews) ? reviews : [];

        if (!resp.ok || list.length === 0) {
          if (emptyEl) emptyEl.style.display = 'block';
          return;
        }

        if (emptyEl) emptyEl.style.display = 'none';
        listEl.style.display = 'grid';

        const vehicleLabels = window.__reviewVehicleLabelById || {};

        list.forEach((rev) => {
          const wrap = document.createElement('div');
          wrap.className = 'review-item';

          const name = (rev?.displayName || 'Anonymous').toString();
          const when = safeDate(rev?.createdAt);
          const verified = rev?.verified === true;
          const stars = renderStars(rev?.rating);
          const comment = (rev?.comment || '').toString().trim();
          const vehicleId = rev?.vehicleId ? String(rev.vehicleId) : '';
          const vehicleLabel = vehicleId && vehicleLabels[vehicleId] ? vehicleLabels[vehicleId] : '';

          wrap.innerHTML = `
            <div class="review-item-top">
              <div>
                <div class="review-item-name">${name}</div>
                <div class="review-item-meta">
                  ${when ? when : ''}
                  ${vehicleLabel ? ` • ${vehicleLabel}` : ''}
                </div>
              </div>
              <div class="review-item-stars" aria-label="Rating">${stars}</div>
            </div>
            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;">
              ${verified ? '<span class="pill-inline">Verified</span>' : ''}
            </div>
            <div class="review-item-text">${comment ? escapeHtml(comment) : '<span class="muted">No written feedback provided.</span>'}</div>
          `;

          listEl.appendChild(wrap);
        });
      } catch (e) {
        console.warn('Failed to load host reviews:', e?.message || e);
        if (emptyEl) emptyEl.style.display = 'block';
      }
    }

    function createVehicleCard(vehicle) {
      const card = document.createElement('div');
      card.className = 'vehicle-card';

      const image = vehicle.image || (vehicle.photos && vehicle.photos[0]) || 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22400%22 height=%22300%22%3E%3Crect fill=%22%23ddd%22 width=%22400%22 height=%22300%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-family=%22sans-serif%22 font-size=%2224%22 fill=%22%23999%22%3ENo Image%3C/text%3E%3C/svg%3E';
      const category = vehicle.category || vehicle.vehicleType || 'Vehicle';
      const fuel = vehicle.fuel || vehicle.fuelType || 'Gas';
      const year = vehicle.year || '';
      const make = vehicle.make || '';
      const model = vehicle.model || '';
      const city = vehicle.city || '';
      const state = vehicle.state || '';
      const country = vehicle.country || '';
      const price = vehicle.price || 0;
      const frequency = (vehicle.frequency || 'day').toLowerCase();

      const location = [city, state, country].filter(Boolean).join(', ');
      const availability = String(vehicle.availability || '').toLowerCase() === 'rented' ? 'rented' : 'available';
      const isPaused = String(vehicle.status || 'active') !== 'active';

      // Determine ownership for host-only controls
      const currentUid = window.firebaseAuth?.currentUser?.uid;
      const isOwner = !!(currentUid && (vehicle.ownerId === currentUid || vehicle.hostId === currentUid));

      const hostActionsHtml = `
          <div class="vehicle-actions">
            <button class="btn btn-secondary btn-full" data-action="edit" data-id="${vehicle.id}">Edit vehicle</button>
            <button class="btn btn-secondary btn-full" data-action="pause" data-id="${vehicle.id}">${String(vehicle.status || 'active') === 'active' ? 'Pause listing' : 'Unpause listing'}</button>
            <button class="btn btn-secondary btn-full" data-action="availability" data-id="${vehicle.id}">${availability === 'rented' ? 'Mark available' : 'Mark rented'}</button>
            <button class="btn btn-danger btn-full" data-action="delete" data-id="${vehicle.id}">Delete listing</button>
          </div>`;

      const publicActionsHtml = `
          <div class="vehicle-actions">
            <a href="tel:${profileData?.phone || ''}" class="btn btn-primary btn-full">Call Host</a>
            <a href="vehicle.html?id=${vehicle.id}" class="btn btn-secondary btn-full">View Details</a>
          </div>`;

      card.innerHTML = `
        <div class="vehicle-media">
          <img src="${image}" alt="${year} ${make} ${model}" />
          <div class="vehicle-type-badge">${category}</div>
          <div class="vehicle-availability-badge ${isPaused ? 'paused' : availability}">${isPaused ? 'Paused' : (availability === 'rented' ? 'Rented' : 'Available')}</div>
        </div>
        <div class="vehicle-content">
          <h3 class="vehicle-title">${year} ${make} ${model}</h3>
          <p class="vehicle-location">${location || 'Location not specified'}</p>
          <div class="vehicle-tags">
            <span class="feature-tag">${fuel}</span>
            ${vehicle.insuranceIncluded ? '<span class="feature-tag">Insurance Included</span>' : ''}
          </div>
          <div class="vehicle-price">
            $${price} <span class="period">/ ${frequency}</span>
          </div>
          ${isOwner ? hostActionsHtml : publicActionsHtml}
        </div>
      `;

      // Make the whole card open the vehicle details page (while allowing buttons/links to work).
      const detailsHref = `vehicle.html?id=${encodeURIComponent(String(vehicle.id))}`;
      card.setAttribute('role', 'link');
      card.tabIndex = 0;
      card.setAttribute('aria-label', `View ${`${year} ${make} ${model}`.trim() || 'vehicle'} details`);
      const shouldIgnore = (target) => !!target?.closest?.('button, a, input, textarea, select, label');
      const openDetails = () => { window.location.href = detailsHref; };
      card.addEventListener('click', (e) => { if (!shouldIgnore(e.target)) openDetails(); });
      card.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          if (shouldIgnore(e.target)) return;
          e.preventDefault();
          openDetails();
        }
      });

      // Wire up host-only controls (UI hooks only; backend wiring can be added later)
      if (isOwner) {
        const editBtn = card.querySelector('[data-action="edit"]');
        const pauseBtn = card.querySelector('[data-action="pause"]');
        const availabilityBtn = card.querySelector('[data-action="availability"]');
        const deleteBtn = card.querySelector('[data-action="delete"]');

        editBtn?.addEventListener('click', (e) => {
          e.preventDefault();
          window.location.href = `add-vehicle.html?edit=${vehicle.id}`;
        });

        pauseBtn?.addEventListener('click', (e) => {
          e.preventDefault();
          const currentlyActive = String(vehicle.status || 'active') === 'active';
          const nextStatus = currentlyActive ? 'hidden' : 'active';
          pauseBtn.disabled = true;
          pauseBtn.textContent = 'Saving...';
          VehicleStore.setVehicleStatus(vehicle.id, nextStatus)
            .then((ok) => {
              if (!ok) throw new Error('Status update failed');
              vehicle.status = nextStatus;
              pauseBtn.textContent = nextStatus === 'active' ? 'Pause listing' : 'Unpause listing';
              const badge = card.querySelector('.vehicle-availability-badge');
              if (badge) {
                const currentAvailability = String(vehicle.availability || '').toLowerCase() === 'rented' ? 'rented' : 'available';
                badge.classList.remove('available', 'rented', 'paused');
                badge.classList.add(nextStatus === 'active' ? currentAvailability : 'paused');
                badge.textContent = nextStatus === 'active' ? (currentAvailability === 'rented' ? 'Rented' : 'Available') : 'Paused';
              }
            })
            .catch((err) => {
              console.error('Status toggle failed:', err);
              alert('Could not update listing status. Please try again.');
              pauseBtn.textContent = String(vehicle.status || 'active') === 'active' ? 'Pause listing' : 'Unpause listing';
            })
            .finally(() => {
              pauseBtn.disabled = false;
            });
        });

        availabilityBtn?.addEventListener('click', (e) => {
          e.preventDefault();
          const current = String(vehicle.availability || '').toLowerCase() === 'rented' ? 'rented' : 'available';
          const next = current === 'rented' ? 'available' : 'rented';
          availabilityBtn.disabled = true;
          availabilityBtn.textContent = 'Saving...';
          VehicleStore.setVehicleAvailability(vehicle.id, next)
            .then((ok) => {
              if (!ok) throw new Error('Availability update failed');
              vehicle.availability = next;
              availabilityBtn.textContent = next === 'rented' ? 'Mark available' : 'Mark rented';
              const badge = card.querySelector('.vehicle-availability-badge');
              if (badge && String(vehicle.status || 'active') === 'active') {
                badge.classList.remove('available', 'rented', 'paused');
                badge.classList.add(next);
                badge.textContent = next === 'rented' ? 'Rented' : 'Available';
              }
            })
            .catch((err) => {
              console.error('Availability toggle failed:', err);
              alert('Could not update availability. Please try again.');
              availabilityBtn.textContent = current === 'rented' ? 'Mark available' : 'Mark rented';
            })
            .finally(() => {
              availabilityBtn.disabled = false;
            });
        });

        deleteBtn?.addEventListener('click', (e) => {
          e.preventDefault();
          const confirmed = window.confirm('Delete this listing? This cannot be undone.');
          if (confirmed) {
            deleteBtn.disabled = true;
            deleteBtn.textContent = 'Deleting...';
            VehicleStore.deleteVehicle(vehicle.id)
              .then(() => {
                console.log(` Vehicle ${vehicle.id} deleted`);
                card.remove();
              })
              .catch((err) => {
                console.error(' Delete failed:', err);
                alert('Delete failed. Please try again.');
              })
              .finally(() => {
                deleteBtn.disabled = false;
                deleteBtn.textContent = 'Delete listing';
              });
          }
        });
      }

      return card;
    }

    // Modal management
    const modal = document.getElementById('profileModal');
    const overlay = document.getElementById('profileModalOverlay');
    const modalClose = document.getElementById('modalClose');
    const modalCancel = document.getElementById('modalCancel');
    const modalSave = document.getElementById('modalSave');

    function showModal() {
      modal.classList.add('show');
      overlay.classList.add('show');
      document.body.classList.add('no-scroll');

      // Pre-fill form
      if (profileData) {
        document.getElementById('firstName').value = profileData.firstName || '';
        document.getElementById('lastName').value = profileData.lastName || '';
        document.getElementById('role').value = profileData.role || '';
        document.getElementById('phone').value = profileData.phone || '';
        document.getElementById('email').value = profileData.email || '';
        document.getElementById('city').value = profileData.city || '';
        document.getElementById('state').value = profileData.state || '';
        document.getElementById('country').value = profileData.country || '';
        document.getElementById('about').value = profileData.about || '';

        if (profileData.avatar) {
          document.getElementById('avatarPreview').src = profileData.avatar;
          document.getElementById('avatarPreview').style.display = 'block';
        }
      }
    }

    function hideModal() {
      modal.classList.remove('show');
      overlay.classList.remove('show');
      document.body.classList.remove('no-scroll');
    }

    // Open modal on avatar click
    document.getElementById('avatarContainer')?.addEventListener('click', showModal);
    document.getElementById('editProfileBtn')?.addEventListener('click', (e) => {
      e.preventDefault();
      showModal();
    });
    modalClose?.addEventListener('click', hideModal);
    modalCancel?.addEventListener('click', hideModal);
    overlay?.addEventListener('click', hideModal);

    // Image preview
    document.getElementById('avatarInput')?.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          document.getElementById('avatarPreview').src = e.target.result;
          document.getElementById('avatarPreview').style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    });

    // Save profile
    modalSave?.addEventListener('click', async () => {
      const uid = window.firebaseAuth?.currentUser?.uid || currentUser;
      if (!uid) {
        alert('Please sign in again before uploading photos.');
        return;
      }

      modalSave.disabled = true;
      modalSave.textContent = 'Saving...';

      try {
        const storage = window.firebaseStorage;
        const db = window.firebaseDb;
        const auth = window.firebaseAuth;
        
        // Force auth token refresh to ensure uploads have valid auth
        if (auth?.currentUser) {
          await auth.currentUser.getIdToken(true);
          console.log(' Auth token refreshed');
        }
        
        console.log(' Uploading as uid:', uid, 'storage available?', !!storage, 'db?', !!db);

        let avatarURL = profileData?.avatar || null;

        // Upload avatar if changed
        const avatarFile = document.getElementById('avatarInput').files[0];
        console.log(' Avatar file input:', avatarFile);
        if (avatarFile && storage) {
          try {
            console.log(' Uploading avatar as uid:', uid);
            const ref = storage.ref().child(`users/${uid}/avatar-${Date.now()}.jpg`);
            const snap = await ref.put(avatarFile);
            avatarURL = await snap.ref.getDownloadURL();
            console.log(' Avatar uploaded:', avatarURL);
          } catch (e) {
            console.error(' Avatar upload failed:', e.message);
            throw new Error(`Avatar upload failed: ${e.message}`);
          }
        } else {
          console.log(' No avatar file or storage not available');
        }

        // Save to Firestore
        const updatedData = {
          firstName: document.getElementById('firstName').value.trim(),
          lastName: document.getElementById('lastName').value.trim(),
          role: document.getElementById('role').value.trim(),
          displayName: `${document.getElementById('firstName').value.trim()} ${document.getElementById('lastName').value.trim()}`.trim(),
          name: `${document.getElementById('firstName').value.trim()} ${document.getElementById('lastName').value.trim()}`.trim(),
          phone: document.getElementById('phone').value.trim(),
          email: document.getElementById('email').value.trim(),
          city: document.getElementById('city').value.trim(),
          state: document.getElementById('state').value.trim(),
          country: document.getElementById('country').value.trim(),
          about: document.getElementById('about').value.trim(),
          avatar: avatarURL,
          updatedAt: new Date().toISOString()
        };
        console.log(' Saving updated data with avatar:', updatedData);

        await db.collection('users').doc(uid).set(updatedData, { merge: true });
        console.log(' Profile saved to Firestore:', updatedData);
        profileData = updatedData;
        console.log(' Profile data updated in memory:', profileData);
        displayProfile(profileData);
        console.log(' Display function called');
        hideModal();
        alert('Profile saved successfully!');

      } catch (e) {
        console.error('Profile save error:', e);
        alert('Failed to save profile: ' + e.message);
      } finally {
        modalSave.disabled = false;
        modalSave.textContent = 'Save Changes';
      }
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', loadProfile);
    if (document.readyState !== 'loading') loadProfile();
  </script>

</body>
</html>
