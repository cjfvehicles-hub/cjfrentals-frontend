<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title id="hostPageTitle">Host Profile | CJF</title>
	<meta id="hostMetaDesc" name="description" content="View host profile and fleet" />
	<meta property="og:title" id="hostOgTitle" content="Host Profile | CJF" />
	<meta property="og:description" id="hostOgDesc" content="View host profile and fleet" />
	<meta property="og:image" id="hostOgImage" content="" />
	<meta property="og:type" content="website" />
	<link rel="preconnect" href="https://fonts.googleapis.com" />
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
	<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&display=swap" rel="stylesheet" />
	<link rel="stylesheet" href="assets/style.css" />
	<style>
		/* Public Host Profile Page */
		.host-profile-page { 
			min-height: 100vh; 
			/* Account for fixed header (see assets/style.css .header) */
			padding: 78px 0 0;
		}

		/* Cover Photo */
		.profile-cover {
			width: 100%;
			height: clamp(180px, 26vh, 260px);
			object-fit: cover;
			background: #f0f0f0;
		}

		/* Profile Header Container */
		.profile-container {
			max-width: 1200px;
			margin: 0 auto;
			padding: 0 20px;
		}

		/* Host Card Section */
		.host-card-section {
			margin-top: 16px;
			position: relative;
			z-index: 10;
			margin-bottom: 28px;
		}

		.host-card {
			background: white;
			border-radius: 16px;
			border: 1px solid var(--stroke);
			padding: 24px;
			display: grid;
			grid-template-columns: auto 1fr auto;
			gap: 24px;
			align-items: center;
			box-shadow: 0 2px 8px rgba(0,0,0,0.08);
		}

		/* Avatar */
		.host-avatar-container {
			display: flex;
			flex-direction: column;
			align-items: center;
			gap: 12px;
		}

		.host-avatar {
			width: 96px;
			height: 96px;
			border-radius: 12px;
			object-fit: cover;
			border: 3px solid var(--accent);
		}

		.host-verified {
			display: flex;
			align-items: center;
			gap: 4px;
			font-size: 14px;
			color: #4CAF50;
			font-weight: 600;
		}

		/* Host Info */
		.host-info {
			display: grid;
			gap: 16px;
		}

		.host-header-text h1 {
			margin: 0;
			font-size: 28px;
			font-weight: 700;
		}

		.host-header-text p {
			margin: 4px 0 0;
			color: #666;
			font-size: 16px;
		}

		.host-rating {
			display: flex;
			align-items: center;
			gap: 8px;
			font-size: 14px;
		}

		.stars {
			color: #ffc107;
			font-size: 14px;
		}

		.rating-count {
			color: #666;
		}

		.host-location {
			display: flex;
			align-items: center;
			gap: 8px;
			font-size: 14px;
			color: #666;
		}

		.host-stats {
			display: grid;
			grid-template-columns: repeat(3, 1fr);
			gap: 16px;
			padding-top: 16px;
			border-top: 1px solid var(--stroke);
		}

		.stat-item {
			display: grid;
			gap: 4px;
			text-align: center;
		}

		.stat-value {
			font-size: 24px;
			font-weight: 700;
			color: var(--accent);
		}

		.stat-label {
			font-size: 12px;
			color: #666;
			text-transform: uppercase;
		}

		/* Host Actions */
		.host-actions {
			display: grid;
			gap: 12px;
			min-width: 220px;
		}

		.host-actions .button {
			width: 100%;
		}

		.contact-options-toggle {
			display: flex;
			justify-content: space-between;
			align-items: center;
			gap: 12px;
		}

		.contact-chev {
			width: 10px;
			height: 10px;
			border-right: 2px solid currentColor;
			border-bottom: 2px solid currentColor;
			transform: rotate(45deg);
			opacity: .85;
			flex: 0 0 auto;
		}

		.contact-options-toggle[aria-expanded="true"] .contact-chev {
			transform: rotate(-135deg);
		}

		.contact-options-panel {
			border: 1px solid var(--stroke);
			border-radius: 12px;
			background: #fff;
			padding: 12px;
			display: grid;
			gap: 10px;
		}

		.contact-options-actions {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 10px;
		}

		.contact-disclaimer {
			font-size: 12.5px;
			line-height: 1.35;
			color: #666;
		}

		/* Fleet Section */
		.fleet-section {
			margin: 40px 0;
		}

		.fleet-header {
			margin-bottom: 32px;
			display: grid;
			gap: 8px;
		}

		.fleet-header h2 {
			margin: 0;
			font-size: 24px;
			font-weight: 700;
		}

		.fleet-header p {
			color: #666;
			margin: 0;
		}

		.vehicles-grid {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
			gap: 16px;
		}

		.vehicle-card {
			background: white;
			border-radius: 12px;
			overflow: hidden;
			border: 1px solid var(--stroke);
			transition: all 0.3s ease;
			cursor: pointer;
		}

		.vehicle-card:hover {
			border-color: var(--accent);
			box-shadow: 0 8px 24px rgba(0,0,0,0.12);
		}

		.vehicle-image {
			width: 100%;
			height: 200px;
			object-fit: cover;
			background: #f0f0f0;
		}

		.vehicle-info {
			padding: 16px;
			display: grid;
			gap: 8px;
		}

		.vehicle-title {
			font-weight: 600;
			font-size: 16px;
			margin: 0;
		}

		.vehicle-location {
			font-size: 14px;
			color: #666;
			margin: 0;
		}

		.vehicle-price {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-top: 12px;
			padding-top: 12px;
			border-top: 1px solid var(--stroke);
		}

		.vehicle-price-amount {
			font-weight: 700;
			color: var(--accent);
		}

		.vehicle-frequency {
			font-size: 12px;
			color: #666;
		}

		.empty-state {
			text-align: center;
			padding: 60px 20px;
			background: #f8fafc;
			border-radius: 12px;
		}

		.empty-state p {
			color: #666;
			font-size: 16px;
		}

		/* Reviews Section */
		.reviews-section {
			margin: 60px 0;
		}

		.reviews-header {
			margin-bottom: 32px;
			display: grid;
			gap: 8px;
		}

		.reviews-header h2 {
			margin: 0;
			font-size: 24px;
			font-weight: 700;
		}

		.review-card {
			position: relative;
			overflow: hidden;
			background: linear-gradient(135deg, rgba(79, 70, 229, 0.06), rgba(14, 165, 233, 0.04));
			border: 1px solid rgba(99, 102, 241, 0.22);
			border-radius: 12px;
			padding: 20px;
			margin-bottom: 16px;
			box-shadow: 0 10px 22px rgba(15, 23, 42, 0.06);
			transition: transform 0.15s ease, box-shadow 0.15s ease;
		}

		.review-card::before {
			content: "";
			position: absolute;
			left: 0;
			top: 0;
			bottom: 0;
			width: 6px;
			background: linear-gradient(180deg, var(--accent), #06b6d4);
		}

		.review-card:hover {
			transform: translateY(-1px);
			box-shadow: 0 14px 28px rgba(15, 23, 42, 0.10);
		}

		.review-card[data-rating="5"]::before { background: linear-gradient(180deg, #16a34a, #22c55e); }
		.review-card[data-rating="4"]::before { background: linear-gradient(180deg, #22c55e, #a3e635); }
		.review-card[data-rating="3"]::before { background: linear-gradient(180deg, #f59e0b, #fbbf24); }
		.review-card[data-rating="2"]::before { background: linear-gradient(180deg, #f97316, #fb7185); }
		.review-card[data-rating="1"]::before,
		.review-card[data-rating="0"]::before { background: linear-gradient(180deg, #ef4444, #f43f5e); }

		.review-header {
			display: flex;
			justify-content: space-between;
			align-items: start;
			margin-bottom: 12px;
		}

		.review-author {
			font-weight: 600;
			font-size: 16px;
			color: #0f172a;
		}

		.review-date {
			font-size: 12px;
			color: #999;
		}

		.review-rating {
			display: inline-flex;
			align-items: center;
			gap: 6px;
			padding: 6px 10px;
			border-radius: 999px;
			background: rgba(255, 255, 255, 0.75);
			border: 1px solid rgba(99, 102, 241, 0.18);
			color: #f59e0b;
			font-size: 14px;
			margin-bottom: 8px;
		}

		.review-text {
			color: #333;
			line-height: 1.6;
			margin: 0;
		}

		.no-reviews {
			text-align: center;
			padding: 40px;
			background: #f8fafc;
			border-radius: 12px;
			color: #666;
		}

		/* Responsive */
		@media (max-width: 768px) {
			.host-card {
				grid-template-columns: 1fr;
				text-align: center;
				justify-items: center;
			}
			.host-card-section { margin-top: 16px; }
			.host-avatar { width: 80px; height: 80px; }
			.vehicles-grid { grid-template-columns: 1fr; }
			.host-stats { grid-template-columns: 1fr; }
			.host-info { justify-items: center; }
			.host-rating { justify-content: center; }
			.host-location { justify-content: center; }
			.host-actions { width: 100%; min-width: 0; }
			.contact-options-actions { grid-template-columns: 1fr; }
		}

		.review-text { position: relative; }
		.review-delete-btn { float: right; margin-left: 10px; padding: 6px 10px; font-size: 13px; }
	</style>

	<!-- Firebase and Auth Scripts (required for public profile data loading) -->
	<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
	<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
	<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
	<script src="assets/firebase.js"></script>
	<script src="assets/auth.js"></script>
	<script src="assets/vehicleStore.js"></script>
</head>
<body>
	<header class="header">
		<div class="header-inner">
				<a class="brand" href="index.html">
					<span class="brand-mark">CJF</span>
					<span>CJF Rentals</span>
				</a>
			<button class="menu-button" id="menuToggle" aria-label="Open menu">☰</button>
		</div>
	</header>
	<div class="backdrop" id="backdrop"></div>
	<nav class="menu-panel" id="menuPanel" aria-label="Site menu">
		<div class="brand" style="justify-content: space-between; align-items: center;">
			<span>Navigation</span>
			<button class="menu-close" id="menuClose" aria-label="Close menu"></button>
		</div>
		<ul class="menu-list">
			<li class="menu-account"><a href="account.html">My Account</a></li>
			<li class="menu-signin"><a href="signin.html">Sign In</a></li>
			<li class="menu-logout" style="display:none;"><a href="index.html">Sign Out</a></li>
			<li><a href="index.html">Browse Vehicles</a></li>
			<li><a href="terms.html">Terms &amp; Conditions</a></li>
			<li><a href="contact.html">Contact</a></li>
		</ul>
	</nav>

	<main class="host-profile-page">
		<!-- Host Card -->
		<div class="host-card-section">
			<div class="profile-container">
				<div class="host-card">
					<!-- Avatar -->
					<div class="host-avatar-container">
						<img id="hostAvatarImg" class="host-avatar" src="data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22120%22 height=%22120%22%3E%3Crect fill=%22%23ddd%22 width=%22120%22 height=%22120%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-family=%22sans-serif%22 font-size=%2216%22 fill=%22%23999%22%3EHost%3C/text%3E%3C/svg%3E" alt="Host Avatar" />
						<div class="host-verified" id="verificationBadge" style="display:none;">Verified</div>
					</div>

					<!-- Host Info -->
					<div class="host-info">
						<div class="host-header-text">
							<h1 id="hostNameText">Loading...</h1>
							<p id="hostOwnerTypeText">Vehicle Owner</p>
						</div>

						<div class="host-rating">
							<span class="stars" id="hostStars">★★★★★</span>
							<span class="rating-count">
								<span id="hostRatingValue">5.0</span> 
								(<span id="hostReviewCount">0</span> reviews)
							</span>
						</div>

						<div class="host-location" id="hostLocationRow" style="display:none;">
							<span id="hostLocationText">Location</span>
						</div>

						<div class="host-stats">
							<div class="stat-item">
								<div class="stat-value" id="vehicleCount">0</div>
								<div class="stat-label">Vehicles</div>
							</div>
							<div class="stat-item">
								<div class="stat-value" id="joiningYear">2024</div>
								<div class="stat-label">Member Since</div>
							</div>
						</div>
					</div>

					<!-- Actions -->
					<div class="host-actions">
						<button class="button contact-options-toggle" id="contactOptionsBtn" type="button" aria-expanded="false" aria-controls="contactOptionsPanel">
							<span>View Contact Options</span>
							<span class="contact-chev" aria-hidden="true"></span>
						</button>
						<div id="contactOptionsPanel" class="contact-options-panel" hidden>
							<div class="contact-options-actions">
								<button class="button ghost" id="emailHostBtn" type="button">Email</button>
								<button class="button ghost" id="callHostBtn" type="button">Phone</button>
							</div>
							<div class="contact-disclaimer">CJF Rentals is an advertising platform. Arrangements, availability, and payments are handled directly with the host.</div>
						</div>
						<button class="button ghost" id="visitWebsiteBtn" style="display:none;">Visit Website</button>
					</div>
				</div>
			</div>
		</div>

		<!-- Fleet Section -->
		<div class="profile-container">
			<section class="fleet-section">
				<div class="fleet-header">
					<h2>Fleet</h2>
					<p id="fleetDescription">Browse all available vehicles from this host</p>
				</div>

				<div id="vehiclesContainer" class="vehicles-grid">
					<!-- Vehicle cards populated by JS -->
				</div>

				<div id="emptyFleetMsg" class="empty-state" style="display:none;">
					<p>This host has no active vehicles at the moment.</p>
				</div>
			</section>

			<!-- Reviews Section -->
			<section class="reviews-section">
				<div class="reviews-header">
					<h2>Reviews</h2>
				</div>

				<div id="reviewsContainer">
					<!-- Reviews populated by JS -->
				</div>

				<div id="emptyReviewsMsg" class="no-reviews" style="display:none;">
					<p>No reviews yet. Be the first to review this host!</p>
				</div>
			</section>
		</div>
	</main>

	<div class="toast" id="toast" role="status" aria-live="polite"></div>

	<script>
		// Menu toggle functionality
		const menuPanel = document.getElementById('menuPanel');
		const backdrop = document.getElementById('backdrop');
		const openBtn = document.getElementById('menuToggle');
		const closeBtn = document.getElementById('menuClose');

		const openMenu = () => {
			menuPanel.classList.add('open');
			backdrop.classList.add('show');
		};

		const closeMenu = () => {
			menuPanel.classList.remove('open');
			backdrop.classList.remove('show');
		};

		openBtn?.addEventListener('click', openMenu);
		closeBtn?.addEventListener('click', closeMenu);
		backdrop?.addEventListener('click', closeMenu);

		// Centralized menu UI update for auth state
		function updateNavigationUIFromAuth() {
			if (window.AuthManager && typeof AuthManager.updateUIForRole === 'function') {
				AuthManager.updateUIForRole();
			}
		}
		document.addEventListener('ccr:signedOut', updateNavigationUIFromAuth);
		document.addEventListener('ccr:signedIn', updateNavigationUIFromAuth);
		document.addEventListener('DOMContentLoaded', updateNavigationUIFromAuth);
		if (document.readyState !== 'loading') updateNavigationUIFromAuth();
		
		// Wire menu Sign In click handler to open login UI (no auto-login)
		const menuSignIn = document.querySelector('.menu-signin');
		if (menuSignIn) {
			menuSignIn.addEventListener('click', (e) => {
				e.preventDefault();
				window.location.href = 'account.html#signin';
				closeMenu();
			});
		}

		const showToast = (message) => {
			const toastEl = document.getElementById('toast');
			if (toastEl) {
				toastEl.textContent = message;
				toastEl.classList.add('show');
				setTimeout(() => toastEl.classList.remove('show'), 2800);
			}
		};

		async function getFirebaseIdToken() {
			try {
				const user = window.firebaseAuth?.currentUser;
				if (!user || typeof user.getIdToken !== 'function') return null;
				return await user.getIdToken();
			} catch (e) {
				return null;
			}
		}

		function canAdminDeleteReviews() {
			try {
				const SPECIAL_ADMIN_EMAIL = 'cjfvehicles@gmail.com';
				const rawUser = localStorage.getItem('CJF_CURRENT_USER');
				const localUser = rawUser ? JSON.parse(rawUser) : null;
				const email = String((window.firebaseAuth?.currentUser?.email || localUser?.email || '')).toLowerCase();
				if (!email || email !== SPECIAL_ADMIN_EMAIL) return false;
				const rawMode = localStorage.getItem('CJF_ADMIN_MODE');
				const adminMode = rawMode === null ? true : rawMode === 'true';
				return adminMode === true;
			} catch (e) {
				return false;
			}
		}

		function injectAdminDeleteButtons({ hostId }) {
			const enabled = canAdminDeleteReviews();
			const container = document.getElementById('reviewsContainer');
			if (!container) return;
			container.querySelectorAll('.review-card[data-review-id]').forEach((card) => {
				const reviewId = card.getAttribute('data-review-id');
				if (!reviewId) return;
				const body = card.querySelector('.review-text');
				if (!body) return;
				const existing = body.querySelector('.review-delete-btn');
				if (!enabled) {
					if (existing) existing.remove();
					return;
				}
				if (existing) return;

				const delBtn = document.createElement('button');
				delBtn.className = 'button ghost review-delete-btn';
				delBtn.type = 'button';
				delBtn.textContent = 'Delete';
				delBtn.addEventListener('click', async (e) => {
					e.preventDefault();
					e.stopPropagation();
					const ok = window.confirm('Delete this review?');
					if (!ok) return;
					delBtn.disabled = true;
					try {
						const result = await deleteHostReview({ hostId, reviewId });
						if (!result?.success) {
							delBtn.disabled = false;
							showToast(result?.error || 'Delete failed');
							return;
						}
						card.remove();
						showToast('Review deleted');
						const countEl = document.getElementById('hostReviewCount');
						if (countEl) {
							const current = Number.parseInt(countEl.textContent, 10);
							if (Number.isFinite(current) && current > 0) {
								countEl.textContent = String(current - 1);
							}
						}
						const emptyReviewsMsg = document.getElementById('emptyReviewsMsg');
						if (container.querySelectorAll('.review-card').length === 0) {
							if (emptyReviewsMsg) emptyReviewsMsg.style.display = 'block';
						}
					} catch (err) {
						delBtn.disabled = false;
						showToast(err?.message || 'Delete failed');
					}
				});
				body.insertBefore(delBtn, body.firstChild);
			});
		}

		async function deleteHostReview({ hostId, reviewId }) {
			const token = await getFirebaseIdToken();
			if (!token) {
				showToast('Sign in as admin to delete reviews');
				return { success: false, error: 'Not authenticated' };
			}

			const resp = await fetch(`/api/hosts/${encodeURIComponent(String(hostId))}/reviews/${encodeURIComponent(String(reviewId))}`, {
				method: 'DELETE',
				headers: {
					'Accept': 'application/json',
					'Authorization': `Bearer ${token}`
				}
			});
			const data = await resp.json().catch(() => null);
			if (!resp.ok || !data?.success) {
				return { success: false, error: data?.error || `Delete failed (${resp.status})` };
			}
			return { success: true };
		}

		// Load host profile from URL parameter
		async function loadHostProfile() {
			try {
				// Get hostId from URL
				const params = new URLSearchParams(window.location.search);
				const hostId = params.get('id');

				if (!hostId) {
					document.querySelector('.host-profile-page').innerHTML = `
						<div style="padding: 40px; text-align: center;">
							<h2>Host Profile Not Found</h2>
							<p>No host ID provided.</p>
							<a href="index.html" style="color: var(--accent);">Back to Home</a>
						</div>
					`;
					return;
				}

				// Get vehicles from this host (public-safe)
				let allVehicles = [];
				try {
					if (window.VehicleStore && typeof VehicleStore.getActiveVehicles === 'function') {
						allVehicles = await VehicleStore.getActiveVehicles();
					} else if (typeof window.getActiveVehicles === 'function') {
						allVehicles = await window.getActiveVehicles();
					} else {
						console.warn('VehicleStore not available; showing empty fleet');
					}
				} catch (e) {
					console.warn('Vehicle load failed; showing empty fleet:', e?.message || e);
					allVehicles = [];
				}
				const hostVehicles = (Array.isArray(allVehicles) ? allVehicles : []).filter(v => {
					const owner = (v && (v.hostId || v.ownerId)) ? String(v.hostId || v.ownerId) : '';
					const isMine = owner && owner === String(hostId);
					const isActive = (v && (v.status === 'active' || !v.status));
					return isMine && isActive;
				});

				// Get host profile (Firestore only; if missing, show placeholder)
				let hostProfile = null;
				if (window.firebaseDb) {
					try {
						const snap = await firebaseDb.collection('users').doc(String(hostId)).get();
						if (snap.exists) {
							hostProfile = { id: hostId, ...snap.data() };
						}
					} catch (e) {
						console.warn('Host fetch failed:', e.message);
					}
				}
				if (!hostProfile) {
					hostProfile = {
						name: 'Host',
						ownerType: 'Host',
						city: '',
						state: '',
						country: '',
						email: '',
						phone: '',
						avatar: null,
						joined: 'recently'
					};
				}

				// Update page title/meta
				const hostName = hostProfile.displayName || hostProfile.name || hostProfile.firstName || 'Host';
				document.getElementById('hostPageTitle').textContent = `${hostName} - Host Profile | CJF`;
				document.getElementById('hostOgTitle').content = `${hostName} - Host Profile`;
				document.getElementById('hostMetaDesc').content = `View ${hostName}'s fleet and contact details.`;
				document.getElementById('hostOgDesc').content = `Browse ${hostName}'s vehicles.`;

				// Populate host card
				document.getElementById('hostNameText').textContent = hostName;
				document.getElementById('hostOwnerTypeText').textContent = hostProfile.ownerType || hostProfile.hostType || 'Vehicle Owner';
				const locationParts = [hostProfile.city, hostProfile.state, hostProfile.country].filter(Boolean);
				const locationText = locationParts.join(', ');
				const locationRow = document.getElementById('hostLocationRow');
				const locationEl = document.getElementById('hostLocationText');
				if (locationEl) locationEl.textContent = locationText;
				if (locationRow) locationRow.style.display = locationText ? 'flex' : 'none';
				
				// Host avatar
				const hostAvatar = hostProfile.avatar || hostProfile.photoURL ||
					'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="%23e0e7ff"/><circle cx="50" cy="35" r="20" fill="%236366f1"/><path d="M 30 70 Q 50 60 70 70 Q 70 85 50 90 Q 30 85 30 70" fill="%236366f1"/></svg>';
				document.getElementById('hostAvatarImg').src = hostAvatar;

				// OG image (no cover photo on public profile)
				const ogImage = (hostVehicles[0]?.photos?.[0]) || hostAvatar || '';
				document.getElementById('hostOgImage').content = ogImage;

				// Verification badge
				const verified = !!(hostProfile.email && hostProfile.phone);
				document.getElementById('verificationBadge').style.display = verified ? 'flex' : 'none';

				// Stats
				document.getElementById('vehicleCount').textContent = hostVehicles.length;
				let createdYear = '—';
				if (hostProfile.createdAt) {
					const ts = hostProfile.createdAt.seconds ? hostProfile.createdAt.seconds * 1000 : hostProfile.createdAt;
					createdYear = new Date(ts).getFullYear();
				}
				document.getElementById('joiningYear').textContent = createdYear;

				// Rating
				const ratingVal = Number(hostProfile.rating || hostProfile.ratingAvg || hostProfile.avgRating || 5).toFixed(1);
				const reviews = hostProfile.ratingCount || hostProfile.reviewCount || hostProfile.reviewsCount || 0;
				document.getElementById('hostRatingValue').textContent = ratingVal;
				document.getElementById('hostReviewCount').textContent = reviews;
				document.getElementById('hostStars').textContent = '★★★★★';

				// Contact (explicit choice required)
				const email = (hostProfile.email || '').toString().trim();
				const phone = (hostProfile.phone || '').toString().trim();
				const optionsBtn = document.getElementById('contactOptionsBtn');
				const panel = document.getElementById('contactOptionsPanel');
				const emailBtn = document.getElementById('emailHostBtn');
				const callBtn = document.getElementById('callHostBtn');

				const setPanelOpen = (open) => {
					panel.hidden = !open;
					optionsBtn.setAttribute('aria-expanded', open ? 'true' : 'false');
				};

				const emailAvailable = !!email;
				const phoneAvailable = !!phone;
				emailBtn.disabled = !emailAvailable;
				callBtn.disabled = !phoneAvailable;

				if (!emailAvailable && !phoneAvailable) {
					optionsBtn.disabled = true;
					optionsBtn.textContent = 'Contact info unavailable';
					setPanelOpen(false);
				} else {
					optionsBtn.onclick = () => setPanelOpen(panel.hidden);
					setPanelOpen(false);
				}

				emailBtn.onclick = () => {
					if (!emailAvailable) return;
					window.location.href = `mailto:${email}`;
				};
				callBtn.onclick = () => {
					if (!phoneAvailable) return;
					window.location.href = `tel:${phone}`;
				};
				const websiteBtn = document.getElementById('visitWebsiteBtn');
				if (websiteBtn) {
					if (hostProfile.website) {
						websiteBtn.style.display = 'block';
						websiteBtn.onclick = () => window.open(hostProfile.website, '_blank');
					} else {
						websiteBtn.style.display = 'none';
					}
				}

				// Populate vehicles grid
				const vehiclesContainer = document.getElementById('vehiclesContainer');
				vehiclesContainer.innerHTML = '';

				if (!hostVehicles.length) {
					vehiclesContainer.innerHTML = '<p style="color:#6b7280;">This host has no active vehicles.</p>';
				} else {
					hostVehicles.forEach(vehicle => {
						const vehicleCard = document.createElement('div');
						vehicleCard.className = 'vehicle-card';
						vehicleCard.onclick = () => {
							window.location.href = `vehicle.html?id=${vehicle.id}`;
						};

						const photo = vehicle.photos && vehicle.photos[0] ? vehicle.photos[0] : 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22280%22 height=%22200%22%3E%3Crect fill=%22%23ddd%22 width=%22280%22 height=%22200%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-family=%22sans-serif%22 font-size=%2220%22 fill=%22%23999%22%3EVehicle%3C/text%3E%3C/svg%3E';

						vehicleCard.innerHTML = `
							<img src="${photo}" alt="${vehicle.year} ${vehicle.make} ${vehicle.model}" class="vehicle-image" />
							<div class="vehicle-info">
								<h3 class="vehicle-title">${vehicle.year} ${vehicle.make} ${vehicle.model}</h3>
								<p class="vehicle-location">${vehicle.city || ''}${vehicle.state ? ', ' + vehicle.state : ''}</p>
								<div class="vehicle-price">
									<span class="vehicle-price-amount">$${vehicle.price || 0}</span>
									<span class="vehicle-frequency">/${(vehicle.frequency || 'day').toLowerCase()}</span>
								</div>
								${String(vehicle.availability || '').toLowerCase() === 'rented' ? '<div style="margin-top:8px;"><span style="display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background: rgba(239,68,68,0.12); color:#991b1b; border:1px solid rgba(239,68,68,0.22); font-weight:800; font-size:12px;">Rented</span></div>' : ''}
							</div>
						`;

						vehiclesContainer.appendChild(vehicleCard);
					});
				}

				// Show/hide empty state
				document.getElementById('emptyFleetMsg').style.display = hostVehicles.length === 0 ? 'block' : 'none';
				document.getElementById('fleetDescription').textContent = `All vehicles from ${hostName}`;

				// Load reviews
				const reviewsContainer = document.getElementById('reviewsContainer');
				const emptyReviewsMsg = document.getElementById('emptyReviewsMsg');
				const renderStars = (rating) => {
					const r = Math.max(0, Math.min(5, Number(rating) || 0));
					return '★★★★★'.slice(0, r) + '☆☆☆☆☆'.slice(0, 5 - r);
				};
				const safeDate = (iso) => {
					try {
						return iso ? new Date(iso).toLocaleDateString() : '';
					} catch (e) {
						return '';
					}
				};

				reviewsContainer.innerHTML = '';
				if (emptyReviewsMsg) emptyReviewsMsg.style.display = 'none';
				try {
					const resp = await fetch(`/api/hosts/${encodeURIComponent(String(hostId))}/reviews?limit=20`, {
						headers: { 'Accept': 'application/json' }
					});
					const data = await resp.json().catch(() => null);
					const list = data?.success ? (data.data || []) : [];
					if (!resp.ok || !Array.isArray(list) || list.length === 0) {
						if (emptyReviewsMsg) emptyReviewsMsg.style.display = 'block';
					} else {
						list.forEach((rev) => {
							const numericRating = Math.max(0, Math.min(5, Math.round(Number(rev?.rating) || 0)));
							const card = document.createElement('div');
							card.className = 'review-card';
							card.setAttribute('data-rating', String(numericRating));
							if (rev?.id) card.setAttribute('data-review-id', String(rev.id));

							const header = document.createElement('div');
							header.className = 'review-header';

							const left = document.createElement('div');
							const author = document.createElement('div');
							author.className = 'review-author';
							author.textContent = (rev?.displayName || 'Anonymous').toString();
							const date = document.createElement('div');
							date.className = 'review-date';
							date.textContent = safeDate(rev?.createdAt);
							left.appendChild(author);
							left.appendChild(date);

							const rating = document.createElement('div');
							rating.className = 'review-rating';
							rating.textContent = renderStars(rev?.rating);

							header.appendChild(left);
							header.appendChild(rating);

							const body = document.createElement('div');
							body.className = 'review-text';
							const bodyText = document.createElement('span');
							bodyText.textContent = (rev?.comment || '').toString() || 'No written feedback provided.';

							body.appendChild(bodyText);
							card.appendChild(header);
							card.appendChild(body);

							reviewsContainer.appendChild(card);
						});
						// Inject admin controls after render (auth may finish after DOMContentLoaded)
						injectAdminDeleteButtons({ hostId });
					}
				} catch (e) {
					console.warn('Failed to load reviews:', e?.message || e);
					if (emptyReviewsMsg) emptyReviewsMsg.style.display = 'block';
				}

				// Re-check admin state later, on auth changes, and on focus (admin mode toggle lives on other pages)
				setTimeout(() => injectAdminDeleteButtons({ hostId }), 800);
				document.addEventListener('authStateChanged', () => injectAdminDeleteButtons({ hostId }));
				window.addEventListener('focus', () => injectAdminDeleteButtons({ hostId }));

				const safeUpdateMenuAuth = (typeof window.updateMenuAuth === 'function') ? window.updateMenuAuth : null;
				if (safeUpdateMenuAuth) {
					safeUpdateMenuAuth();
				} else if (window.AuthManager && typeof AuthManager.updateUIForRole === 'function') {
					AuthManager.updateUIForRole();
				}

			} catch (error) {
				console.error('Failed to load host profile:', error);
				showToast('Error loading host profile');
			}
		}

		// Load profile on page load
		document.addEventListener('DOMContentLoaded', loadHostProfile);
	</script>
</body>
</html>

