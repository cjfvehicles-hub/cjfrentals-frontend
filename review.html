<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Share feedback | CJF Rentals</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="assets/style.css" />
  <style>
    :root {
      --bg: #f6f7f9;
      --card-bg: #fff;
      --accent: #0f172a;
      --stroke: #e2e8f0;
      --sunny: #dcfce7;
      --sunny-text: #166534;
      --pill-text: #1f7a3a;
    }
    body {
      margin: 0;
      font-family: "Manrope", sans-serif;
      background: var(--bg);
      color: var(--accent);
      min-height: 100vh;
    }
    .review-shell {
      max-width: 720px;
      margin: 0 auto;
      padding: 48px 24px 96px;
    }
    .review-card {
      background: var(--card-bg);
      border-radius: 28px;
      padding: 32px;
      box-shadow: 0 24px 40px rgba(15, 23, 42, 0.08);
      border: 1px solid var(--stroke);
      display: flex;
      flex-direction: column;
      gap: 28px;
    }
    .header-block .badge-pill {
      display: inline-flex;
      align-items: center;
      padding: 6px 14px;
      border-radius: 999px;
      background: #d1fae5;
      color: #166534;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      max-width: fit-content;
    }
    .header-block h1 {
      margin: 12px 0 6px;
      font-size: clamp(22px, 3vw, 32px);
      line-height: 1.2;
    }
    .subtitle-line {
      margin: 0;
      color: #475569;
      font-size: 14px;
    }
    .section-label {
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      margin-bottom: 10px;
      color: #475569;
    }
    .section-block {
      border-top: 1px solid var(--stroke);
      padding-top: 20px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    .rating-stars {
      display: flex;
      gap: 12px;
    }
    .rating-stars .star {
      width: 52px;
      height: 52px;
      border-radius: 16px;
      border: 1px solid var(--stroke);
      background: #f8fafc;
      font-size: 24px;
      font-weight: 700;
      color: #d1d5db;
      display: grid;
      place-items: center;
      cursor: pointer;
      transition: transform 0.15s ease, border-color 0.15s ease, color 0.15s ease;
    }
    .rating-stars .star.selected {
      border-color: #2563eb;
      color: #1d4ed8;
      transform: translateY(-2px);
      background: #e0e7ff;
    }
    .rating-hint {
      font-size: 13px;
      color: #6b7280;
    }
    .rating-feedback {
      font-size: 14px;
      color: var(--accent);
      min-height: 20px;
    }
    textarea, .input-field {
      width: 100%;
      border: 1px solid var(--stroke);
      border-radius: 12px;
      padding: 12px 14px;
      font-size: 15px;
      font-family: inherit;
      background: #fbfcfd;
      min-height: 48px;
    }
    textarea {
      min-height: 130px;
      resize: vertical;
    }
    .textarea-note {
      font-size: 13px;
      color: #9ca3af;
    }
    .section-divider {
      height: 1px;
      background: var(--stroke);
      margin: 0;
    }
    .collapsible-trigger {
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0;
      font-size: 16px;
      font-weight: 700;
      color: var(--accent);
      cursor: pointer;
    }
    .collapsible-trigger .chevron {
      transition: transform 0.2s ease;
    }
    .collapsible-trigger.expanded .chevron {
      transform: rotate(180deg);
    }
    .collapsible-panel {
      margin-top: 12px;
      border: 1px solid var(--stroke);
      border-radius: 16px;
      padding: 16px;
      display: none;
      gap: 14px;
      background: #f9fafb;
    }
    .collapsible-panel.visible {
      display: grid;
    }
    .identity-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }
    .identity-grid .full {
      grid-column: 1 / -1;
    }
    .helper-text {
      font-size: 13px;
      color: #6b7280;
    }
    .submit-area {
      position: relative;
    }
    .submit-area button {
      width: 100%;
      padding: 14px;
      font-size: 16px;
      border-radius: 14px;
      border: none;
      background: #0f172a;
      color: #fff;
      font-weight: 700;
      cursor: pointer;
      transition: opacity 0.2s ease;
    }
    .submit-area button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .success-panel {
      border-radius: 18px;
      padding: 24px;
      border: 1px solid var(--sunny);
      background: var(--sunny);
      color: var(--sunny-text);
      display: none;
      align-items: center;
      gap: 10px;
    }
    .success-panel.visible {
      display: flex;
    }
    .success-panel span {
      font-size: 24px;
    }
    .rules-note {
      font-size: 13px;
      color: #475569;
      margin: 0;
    }
    @media (max-width: 768px) {
      .review-shell {
        padding: 28px 16px 96px;
      }
      .review-card {
        padding: 24px;
      }
      .identity-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-inner">
      <a class="brand" href="index.html">
        <span class="brand-mark">CJF</span>
        <span>CJF Rentals</span>
      </a>
      <button class="menu-button" id="menuToggle" aria-label="Open menu">Menu</button>
    </div>
  </header>

  <div class="backdrop" id="backdrop"></div>
  <nav class="menu-panel" id="menuPanel" aria-label="Site menu">
    <div class="menu-header">
      <span class="menu-title">Navigation</span>
      <button class="menu-close" id="menuClose" aria-label="Close menu">Close</button>
    </div>
    <ul class="menu-list">
      <li><a href="index.html">Browse Vehicles</a></li>
      <li><a href="host-profile.html">Host Profile</a></li>
      <li><a href="host-dashboard.html">Host Dashboard</a></li>
      <li><a href="terms.html">Terms &amp; Conditions</a></li>
      <li><a href="contact.html">Contact</a></li>
    </ul>
  </nav>

  <main class="review-shell">
    <section class="review-card" id="reviewCard">
      <div class="header-block">
        <span class="badge-pill">Verified review</span>
        <h1>Share feedback for your host</h1>
        <p class="subtitle-line" id="verificationLine">Your link is verified.</p>
        <p class="subtitle-line" id="linkExpiry">Expires: ...</p>
      </div>

      <form id="reviewForm" class="form-stack">
        <div class="section-block">
          <div class="section-label">Overall satisfaction</div>
          <div class="rating-stars" role="radiogroup" aria-label="Star rating" id="ratingStars">
            <button type="button" class="star" data-value="1" aria-label="1 star">★</button>
            <button type="button" class="star" data-value="2" aria-label="2 stars">★</button>
            <button type="button" class="star" data-value="3" aria-label="3 stars">★</button>
            <button type="button" class="star" data-value="4" aria-label="4 stars">★</button>
            <button type="button" class="star" data-value="5" aria-label="5 stars">★</button>
          </div>
          <div class="rating-hint">Tap a star to rate.</div>
          <div class="rating-feedback" id="ratingFeedback"></div>
        </div>

        <div class="section-block">
          <div class="section-label">Your feedback (optional)</div>
          <textarea id="reviewComment" class="input-field" maxlength="500" placeholder="What went well? What could be improved?"></textarea>
          <div class="helper-text" id="charCount">0/500</div>
        </div>

        <div class="section-block">
          <button type="button" class="collapsible-trigger" id="identityToggle">
            <span>Add your name (optional)</span>
            <span class="chevron">⌄</span>
          </button>
          <div class="collapsible-panel" id="identityPanel">
            <input id="displayName" class="input-field" placeholder="Display name (optional)" />
            <div class="identity-grid">
              <input id="firstName" class="input-field" placeholder="First name" />
              <input id="lastName" class="input-field" placeholder="Last name" />
            </div>
            <input id="reviewEmail" type="email" class="input-field full" placeholder="Email (optional)" />
          </div>
        </div>

        <div class="section-block">
          <div class="section-label">Quick check</div>
          <input id="captchaInput" class="input-field" placeholder="Answer: 7 + 2" />
          <span class="helper-text">This helps prevent spam.</span>
          <div class="rating-feedback" id="captchaFeedback"></div>
        </div>

        <div class="section-block submit-area">
          <button type="submit" id="submitReviewBtn" disabled>Submit review</button>
        </div>
      </form>

      <div id="successPanel" class="success-panel">
        <span>✅</span>
        <div>
          <strong>Thanks — your review was submitted.</strong>
          <p class="rules-note">Reviews are submitted by customers after direct interactions. No account required.</p>
        </div>
      </div>
    </section>
  </main>

  <script>
    const menuPanel = document.getElementById('menuPanel');
    const backdrop = document.getElementById('backdrop');
    const openBtn = document.getElementById('menuToggle');
    const closeBtn = document.getElementById('menuClose');
    const openMenu = () => { menuPanel?.classList.add('open'); backdrop?.classList.add('show'); };
    const closeMenu = () => { menuPanel?.classList.remove('open'); backdrop?.classList.remove('show'); };
    openBtn?.addEventListener('click', openMenu);
    closeBtn?.addEventListener('click', closeMenu);
    backdrop?.addEventListener('click', closeMenu);
  </script>
  <script src="assets/navBuilder.js"></script>
  <script>
    (function() {
      const token = new URLSearchParams(window.location.search).get('token');
      const instructionsEl = document.getElementById('verificationLine');
      const expiryEl = document.getElementById('linkExpiry');
      const form = document.getElementById('reviewForm');
      const ratingButtons = document.querySelectorAll('#ratingStars .star');
      const submitBtn = document.getElementById('submitReviewBtn');
      const responseEl = document.getElementById('successPanel');
      const feedbackEl = document.getElementById('ratingFeedback');
      const captchaFeedback = document.getElementById('captchaFeedback');
      const captchaEl = document.getElementById('captchaInput');
      const commentEl = document.getElementById('reviewComment');
      const charCount = document.getElementById('charCount');
      const identityToggle = document.getElementById('identityToggle');
      const identityPanel = document.getElementById('identityPanel');
      const firstEl = document.getElementById('firstName');
      const lastEl = document.getElementById('lastName');
      const nameEl = document.getElementById('displayName');
      const emailEl = document.getElementById('reviewEmail');
      const successPanel = document.getElementById('successPanel');
      const reviewForEl = document.getElementById('reviewCard');
      let ratingValue = null;
      let countdown = 10;
      let countdownInterval = null;

      const showCaptchaFeedback = (message, isError = false) => {
        captchaFeedback.textContent = message;
        captchaFeedback.style.color = isError ? '#b91c1c' : '#0f172a';
      };

      const enableSubmit = () => {
        const captchaCorrect = Number(captchaEl?.value?.trim()) === 9;
        submitBtn.disabled = !(ratingValue && captchaCorrect && countdown <= 0);
      };

      const setRating = (value) => {
        ratingValue = value;
        ratingButtons.forEach(btn => {
          btn.classList.toggle('selected', Number(btn.dataset.value) === value);
        });
        feedbackEl.textContent = `You selected: ${value}/5`;
        enableSubmit();
      };

      ratingButtons.forEach(button => {
        button.addEventListener('click', () => {
          setRating(Number(button.dataset.value));
        });
      });

      captchaEl?.addEventListener('input', () => {
        const correct = Number(captchaEl.value.trim()) === 9;
        if (correct) {
          showCaptchaFeedback('Quick check solved.');
        } else {
          showCaptchaFeedback('');
        }
        enableSubmit();
      });

      commentEl?.addEventListener('input', () => {
        if (charCount) {
          charCount.textContent = `${commentEl.value.length}/500`;
        }
      });

      const startCountdown = () => {
        if (!countdownInterval) {
          countdown = 10;
          countdownInterval = setInterval(() => {
            if (countdown <= 0) {
              clearInterval(countdownInterval);
              countdownInterval = null;
              enableSubmit();
            }
            countdown -= 1;
          }, 1000);
        }
      };

      identityToggle?.addEventListener('click', () => {
        const expanded = identityPanel.classList.toggle('visible');
        identityToggle.classList.toggle('expanded', expanded);
      });

      form?.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!ratingValue) {
          feedbackEl.textContent = 'Please choose a rating.';
          feedbackEl.style.color = '#b91c1c';
          return;
        }
        if (Number(captchaEl.value.trim()) !== 9) {
          showCaptchaFeedback('Please answer correctly to submit.', true);
          return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting…';
        try {
          const resp = await fetch('/api/reviews/submit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              token,
              rating: ratingValue,
              comment: commentEl.value.trim(),
              displayName: nameEl.value.trim() || 'Anonymous',
              firstName: firstEl.value.trim() || null,
              lastName: lastEl.value.trim() || null,
              email: emailEl.value.trim() || null
            })
          });
          const payload = await resp.json();
          if (!resp.ok || !payload.success) {
            showCaptchaFeedback(payload.error || 'Unable to submit review.', true);
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit review';
            return;
          }
          form.style.display = 'none';
          successPanel.classList.add('visible');
          submitBtn.textContent = 'Submit review';
        } catch (error) {
          showCaptchaFeedback('Submission failed. Try again later.', true);
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit review';
        }
      });

      const validateToken = async () => {
        if (!token) {
          instructionsEl.textContent = 'Please ask your host for a valid link.';
          return;
        }
        try {
          const resp = await fetch(`/api/review-tokens/${token}`);
          const data = await resp.json();
          if (!resp.ok || !data?.success) {
            instructionsEl.textContent = data?.error || 'This link is no longer valid.';
            return;
          }
          expiryEl.textContent = `Expires ${new Date(data.data.expiresAt).toLocaleString()}`;
          instructionsEl.textContent = 'Your link is verified.';
          form.style.display = 'flex';
          startCountdown();
        } catch (error) {
          instructionsEl.textContent = 'Unable to verify the link right now.';
        }
      };

      validateToken();
    })();
  </script>
</body>
</html>
