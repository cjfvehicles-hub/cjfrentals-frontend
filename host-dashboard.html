<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Host Dashboard | CJF</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="assets/style.css" />
</head>
<body>
  <header class="header">
    <div class="header-inner">
      <a class="brand" href="index.html"><span class="brand-mark">CJF</span><span>CJF Rentals</span></a>
      <button class="menu-button" id="menuToggle" aria-label="Open menu">Menu</button>
    </div>
  </header>
  <div class="backdrop" id="backdrop"></div>
  <nav class="menu-panel" id="menuPanel" role="dialog" aria-label="Navigation">
    <div class="menu-header">
      <span class="menu-title">Navigation</span>
      <button class="menu-close" aria-label="Close menu">Close</button>
    </div>
    <ul class="menu-list" id="nav-list">
      <!-- Menu items built dynamically by navBuilder.js -->
    </ul>
  </nav>

  <main class="page">
    <section class="card" style="gap:12px;">
      <div class="grid" style="gap:6px;">
        <div class="pill">Host dashboard (private)</div>
        <h1 style="font-size: clamp(24px, 3.6vw, 32px);">Control center</h1>
        <p class="muted">Profile edit, avatar/cover uploads, vehicle management, subscription controls, reviews.</p>
      </div>
      <div class="grid two">
        <div class="card" style="padding:12px;">
          <strong>Profile</strong>
          <div class="form-grid">
            <div><label>Avatar</label><input type="file" class="input" /></div>
            <div><label>Cover photo</label><input type="file" class="input" /></div>
            <div><label>Name</label><input class="input" /></div>
            <div><label>Phone</label><input class="input" /></div>
            <div><label>Email</label><input type="email" class="input" /></div>
            <div><label>Address</label><input class="input" /></div>
            <button class="button" type="button">Save profile</button>
          </div>
        </div>
        <div class="card" style="padding:12px;">
          <strong>Subscription</strong>
          <p class="muted">Status: Locked until plan chosen.</p>
          <div class="grid" style="gap:10px;">
            <button class="button" type="button">Upgrade plan</button>
            <button class="button ghost" type="button">Cancel subscription</button>
            <button class="button ghost" type="button">Downgrade (next cycle)</button>
          </div>
          <div class="pill">Posting button LOCKED until plan active</div>
        </div>
      </div>
    </section>

    <section>
      <div class="grid" style="gap:6px;">
        <div class="pill">Vehicles</div>
        <h2>Manage vehicles</h2>
      </div>
      <div class="grid three">
        <article class="card vehicle-card">
          <div class="vehicle-meta">Active • within plan limit</div>
          <strong>Range Rover Velar</strong>
          <div class="vehicle-meta">$240 daily</div>
          <div style="display:flex; gap:8px; flex-wrap: wrap;">
            <a class="button" href="add-vehicle.html">Edit</a>
            <button class="button ghost" type="button">Delete</button>
          </div>
        </article>
        <article class="card vehicle-card">
          <div class="vehicle-meta">Active • within plan limit</div>
          <strong>Mercedes E-Class</strong>
          <div class="vehicle-meta">$180 daily</div>
          <div style="display:flex; gap:8px; flex-wrap: wrap;">
            <a class="button" href="add-vehicle.html">Edit</a>
            <button class="button ghost" type="button">Delete</button>
          </div>
        </article>
        <article class="card vehicle-card">
          <div class="vehicle-meta">Slot available</div>
          <strong>Posting locked until plan</strong>
          <div class="vehicle-meta">Select plan to unlock</div>
          <button class="button" type="button">Upgrade plan</button>
        </article>
      </div>
      <a class="button" href="add-vehicle.html">Add vehicle</a>
    </section>

    <section class="card" style="gap:10px;">
      <div class="pill">Reviews</div>
      <p class="muted">View all reviews for host vehicles; respond if needed.</p>
      <div class="grid">
        <div class="card" style="padding:12px;">
          <div class="vehicle-meta">Velar • 5★ • 2024-02-15</div>
          <p>Excellent service.</p>
          <button class="button ghost" type="button">Respond</button>
        </div>
      </div>
    </section>

    <section class="card" style="gap:10px;" data-host-only id="reviewLinkSection">
      <div class="pill">Review links</div>
      <p class="muted">Generate a secure one-time review link after a completed interaction and copy it for the customer.</p>
      <div class="form-grid">
        <div class="form-field">
          <label for="reviewVehicleId">Vehicle ID (optional)</label>
          <input class="input" id="reviewVehicleId" placeholder="e.g. vehicle-abc123" />
        </div>
        <div class="form-field">
          <label for="reviewCustomerLabel">Label (optional)</label>
          <input class="input" id="reviewCustomerLabel" placeholder="Guest name, booking ref, etc." />
        </div>
        <button class="button" id="generateReviewLinkBtn" type="button">Generate review link</button>
      </div>
      <div id="reviewLinkResult" style="display:none; flex-direction:column; gap:8px;">
        <p class="muted" style="margin:0;">Share this link with the guest (no sign-in required):</p>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <input class="input" id="generatedReviewLink" readonly />
          <button class="button ghost" id="copyReviewLinkBtn" type="button">Copy</button>
        </div>
        <p id="reviewLinkMeta" class="muted" style="margin:0;"></p>
      </div>
      <p class="muted" style="margin:0;">Links expire in 14 days and can only be used once.</p>
    </section>

    <section class="card" style="gap:10px;">
      <div class="pill">Account controls</div>
      <div class="grid two">
        <button class="button ghost" type="button">Deactivate account</button>
        <button class="button ghost" type="button">Delete account</button>
      </div>
    </section>
  </main>

  <script>
    const menuPanel = document.getElementById('menuPanel');
    const backdrop = document.getElementById('backdrop');
    const openBtn = document.getElementById('menuToggle');
    const closeBtn = document.getElementById('menuClose');
    const openMenu = () => { menuPanel.classList.add('open'); backdrop.classList.add('show'); };
    const closeMenu = () => { menuPanel.classList.remove('open'); backdrop.classList.remove('show'); };
    function updateNavigationUIFromAuth() {
      AuthManager.updateUIForRole();
    }
    document.addEventListener('ccr:signedOut', updateNavigationUIFromAuth);
    document.addEventListener('ccr:signedIn', updateNavigationUIFromAuth);
    document.addEventListener('DOMContentLoaded', updateNavigationUIFromAuth);
    if (document.readyState !== 'loading') updateNavigationUIFromAuth();
    
    // Wire menu Sign In click handler to open login UI (no auto-login)
    const menuSignIn = document.querySelector('.menu-signin');
    if (menuSignIn) {
      menuSignIn.addEventListener('click', (e) => {
        e.preventDefault();
        window.location.href = 'account.html#signin';
        closeMenu();
      });
    }
    openBtn?.addEventListener('click', openMenu);
    closeBtn?.addEventListener('click', closeMenu);
    backdrop?.addEventListener('click', closeMenu);
  </script>

  <!-- Firebase and Auth Scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="assets/firebase.js"></script>
  <script src="assets/auth.js"></script>
  <script src="assets/navBuilder.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const genBtn = document.getElementById('generateReviewLinkBtn');
      const copyBtn = document.getElementById('copyReviewLinkBtn');
      const linkInput = document.getElementById('generatedReviewLink');
      const resultPanel = document.getElementById('reviewLinkResult');
      const meta = document.getElementById('reviewLinkMeta');
      const vehicleInput = document.getElementById('reviewVehicleId');
      const labelInput = document.getElementById('reviewCustomerLabel');

      const setMeta = (text, isError = false) => {
        if (!meta) return;
        meta.textContent = text;
        meta.style.color = isError ? '#b91c1c' : '#0f172a';
      };

      genBtn?.addEventListener('click', async () => {
        if (!AuthManager?.getCurrentUser) {
          setMeta('Sign in as a host to generate review links.', true);
          return;
        }
        const user = AuthManager.getCurrentUser();
        if (!user) {
          setMeta('Sign in as a host to generate review links.', true);
          return;
        }
        const payload = {};
        const vehicleId = vehicleInput?.value.trim();
        const customerLabel = labelInput?.value.trim();
        if (vehicleId) payload.vehicleId = vehicleId;
        if (customerLabel) payload.customerLabel = customerLabel;

        genBtn.disabled = true;
        genBtn.textContent = 'Generating...';
        try {
          const response = await fetch('/api/review-tokens', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${user.id}`
            },
            body: JSON.stringify(payload)
          });
          const data = await response.json();
          if (!response.ok || !data?.success) {
            setMeta(data?.error || 'Unable to create review link', true);
            return;
          }
          if (resultPanel) {
            resultPanel.style.display = 'flex';
          }
          if (linkInput) {
            const url = `${window.location.origin}/review.html?token=${encodeURIComponent(data.token)}`;
            linkInput.value = url;
            linkInput.select();
          }
          const expiresAt = data.expiresAt ? new Date(data.expiresAt).toLocaleString() : 'in 14 days';
          setMeta(`Review token expires ${expiresAt}`);
        } catch (error) {
          console.error('Review token error', error);
          setMeta('Failed to generate link. Try again later.', true);
        } finally {
          genBtn.disabled = false;
          genBtn.textContent = 'Generate review link';
        }
      });

      copyBtn?.addEventListener('click', () => {
        if (!linkInput || !linkInput.value) return;
        linkInput.select();
        document.execCommand('copy');
        setMeta('Review link copied');
      });
    });
  </script>
</body>
</html>
