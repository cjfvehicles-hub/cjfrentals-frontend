<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vehicle | CJF</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="assets/style.css" />
  <style>
    :root {
      --panel: #ffffff;
      --muted: #6b7280;
      --pill: #f2f4f7;
      --stroke: #e5e7eb;
      --shadow: 0 10px 30px rgba(0,0,0,0.08);
    }
    body {
      background: #f8fafc;
      color: #0f172a;
    }
    .page {
      max-width: 1180px;
      margin: 0 auto 80px;
      padding: 90px 18px 40px;
    }
    .hero-gallery {
      background: var(--panel);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 16px;
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 12px;
    }
    .main-photo {
      position: relative;
      overflow: hidden;
      border-radius: 14px;
      background: #eef1f5;
      min-height: 280px;
    }
    .main-photo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .thumbs {
      display: grid;
      gap: 10px;
      grid-template-rows: repeat(3, 1fr);
    }
    .thumb {
      position: relative;
      border-radius: 12px;
      overflow: hidden;
      background: #eef1f5;
      cursor: pointer;
      min-height: 90px;
    }
    .thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .view-all {
      position: absolute;
      right: 12px;
      bottom: 12px;
      background: rgba(15, 23, 42, 0.72);
      color: #fff;
      border: none;
      padding: 10px 14px;
      border-radius: 999px;
      cursor: pointer;
      backdrop-filter: blur(6px);
      font-weight: 600;
    }
    .pill-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      background: var(--pill);
      color: var(--muted);
      font-weight: 600;
      font-size: 13px;
    }
    .section-card {
      background: var(--panel);
      border-radius: 18px;
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      padding: 22px;
    }
    .section-title {
      font-size: 22px;
      margin: 0 0 10px;
    }
    .grid-two {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 18px;
    }
    .spec-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
    }
    .spec {
      padding: 12px 14px;
      border-radius: 12px;
      background: var(--pill);
      color: #111827;
      font-weight: 600;
    }
    .chip {
      display: inline-block;
      padding: 8px 12px;
      border-radius: 999px;
      background: var(--pill);
      margin: 6px 6px 0 0;
      font-weight: 600;
      color: #111827;
    }
    .details-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 18px;
    }
    @media (min-width: 1024px) {
      .details-grid.has-notes { grid-template-columns: 2fr 1fr; }
    }
    .feature-block { display: grid; gap: 12px; }
    .feature-chip-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      padding-top: 4px;
    }
    .feature-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 9px 12px;
      border-radius: 999px;
      background: #f3f4f6;
      color: #111827;
      font-weight: 650;
      font-size: 14px;
      line-height: 1;
      white-space: nowrap;
      border: 1px solid rgba(17, 24, 39, 0.06);
      transition: background-color .15s ease, border-color .15s ease;
    }
    @media (hover:hover) {
      .feature-chip:hover {
        background: #eef2ff;
        border-color: rgba(99, 102, 241, 0.25);
      }
    }
    .feature-chip-icon {
      width: 18px;
      height: 18px;
      border-radius: 6px;
      background: rgba(99, 102, 241, 0.12);
      color: #4f46e5;
      display: grid;
      place-items: center;
      font-size: 12px;
      font-weight: 900;
      flex: 0 0 auto;
    }
    .feature-toggle-row { display: flex; justify-content: flex-start; }
    .feature-toggle-row .btn { padding: 10px 12px; }
    .host-notes {
      display: grid;
      gap: 8px;
    }
    .host-notes-title {
      margin: 0;
      font-size: 16px;
      font-weight: 800;
      color: #0f172a;
    }
    .host-notes-text {
      margin: 0;
      color: #334155;
      line-height: 1.65;
      font-size: 14.5px;
    }
    .host-card {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 14px;
      align-items: center;
    }
    .avatar {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: #0f172a;
      color: #fff;
      display: grid;
      place-items: center;
      font-weight: 800;
      font-size: 20px;
      text-transform: uppercase;
    }
    .btn-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .btn {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid var(--stroke);
      background: #0f172a;
      color: #fff;
      cursor: pointer;
      font-weight: 700;
    }
    .btn.secondary {
      background: #fff;
      color: #0f172a;
    }
    .rules {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
    }
    .rule {
      padding: 12px;
      border: 1px solid var(--stroke);
      border-radius: 12px;
      background: #f9fafb;
      font-weight: 600;
    }
    .guideline-chip-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: flex-start;
      padding-top: 2px;
    }
    .guideline-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: #f3f4f6;
      color: #111827;
      font-weight: 650;
      font-size: 14px;
      line-height: 1;
      border: 1px solid rgba(17, 24, 39, 0.06);
      white-space: nowrap;
    }
    .guideline-dot {
      width: 18px;
      height: 18px;
      border-radius: 6px;
      background: rgba(2, 132, 199, 0.10);
      color: #0369a1;
      display: grid;
      place-items: center;
      font-size: 14px;
      font-weight: 900;
      flex: 0 0 auto;
      line-height: 1;
    }
    .guideline-toggle-row { display: flex; justify-content: flex-start; margin-top: 12px; }
    .guideline-toggle-row .btn { padding: 10px 12px; }
    .map-box {
      height: 260px;
      border-radius: 14px;
      background: linear-gradient(135deg, #e2e8f0, #f8fafc);
      border: 1px solid var(--stroke);
      display: grid;
      place-items: center;
      color: var(--muted);
      font-weight: 600;
    }
    .lightbox-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
      padding: 18px;
    }
    .lightbox-backdrop.show { display: flex; }
    .lightbox-panel {
      background: #fff;
      border-radius: 16px;
      width: min(960px, 100%);
      height: min(90vh, 760px);
      display: grid;
      grid-template-rows: auto 1fr;
      box-shadow: 0 30px 80px rgba(0,0,0,0.2);
      overflow: hidden;
    }
    .lightbox-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      border-bottom: 1px solid var(--stroke);
      font-weight: 700;
    }
    .lightbox-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .icon-btn {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      border: 1px solid var(--stroke);
      background: #f8fafc;
      cursor: pointer;
      font-weight: 700;
    }
    .lightbox-body {
      position: relative;
      background: #0f172a;
      display: grid;
      place-items: center;
    }
    .lightbox-body img {
      max-height: 100%;
      max-width: 100%;
      object-fit: contain;
      background: #fff;
    }
    .nav-arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 46px;
      height: 46px;
      border-radius: 50%;
      border: none;
      background: rgba(0,0,0,0.6);
      color: #fff;
      font-size: 22px;
      cursor: pointer;
    }
    .nav-arrow.left { left: 16px; }
    .nav-arrow.right { right: 16px; }
    @media (max-width: 767px) {
      /* Mobile: swipe instead of arrows */
      .nav-arrow { display: none; }
    }
    .sidebar-card {
      background: var(--panel);
      border-radius: 16px;
      border: 1px solid var(--stroke);
      padding: 18px;
      box-shadow: var(--shadow);
    }
    .muted { color: var(--muted); }
    .stack { display: grid; gap: 12px; }
    .stack.tight { gap: 8px; }
    .divider {
      height: 1px;
      background: var(--stroke);
      border: 0;
      margin: 2px 0;
    }
    .sidebar-kicker {
      font-weight: 800;
      letter-spacing: .02em;
      text-transform: uppercase;
      font-size: 12px;
      color: var(--muted);
    }
    .price-amount {
      font-size: 28px;
      line-height: 1.1;
      font-weight: 900;
    }
    .fineprint {
      font-size: 12.5px;
      line-height: 1.35;
    }
    .contact-toggle {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      width: 100%;
    }
    .chev {
      width: 10px;
      height: 10px;
      border-right: 2px solid currentColor;
      border-bottom: 2px solid currentColor;
      transform: rotate(45deg);
      opacity: .8;
      flex: 0 0 auto;
    }
    .contact-toggle[aria-expanded="true"] .chev {
      transform: rotate(-135deg);
    }
    .contact-panel {
      border: 1px solid var(--stroke);
      border-radius: 12px;
      background: #fff;
      padding: 12px;
      display: grid;
      gap: 12px;
    }
    .contact-rows {
      display: grid;
      gap: 8px;
    }
    .contact-row {
      display: grid;
      grid-template-columns: 78px 1fr;
      gap: 10px;
      align-items: start;
      font-size: 14px;
    }
    .contact-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 900px) {
      .price-amount { font-size: 26px; }
      .contact-actions { grid-template-columns: 1fr; }
    }
    .review-list { display: grid; gap: 12px; }
    .review {
      border: 1px solid var(--stroke);
      border-radius: 12px;
      padding: 12px;
      background: #f9fafb;
    }
    @media (max-width: 900px) {
      .page { padding-top: 78px; }
      .hero-gallery { grid-template-columns: 1fr; }
      .thumbs { grid-template-columns: repeat(3, 1fr); grid-template-rows: 1fr; }
      .grid-two { grid-template-columns: 1fr; }
      .lightbox-panel { height: 86vh; }
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="assets/firebase.js"></script>
  <script src="assets/auth.js"></script>
  <script src="assets/vehicleStore.js"></script>
  <script src="assets/safetyPopup.js"></script>
  <script src="assets/navBuilder.js"></script>
</head>
<body>
  <header class="header">
    <div class="header-inner">
      <a class="brand" href="index.html">
        <span class="brand-mark">CJF</span><span>CJF Rentals</span>
      </a>
      <button class="menu-button" id="menuToggle" aria-label="Open menu">☰</button>
    </div>
  </header>
  <div class="backdrop" id="backdrop"></div>
  <nav class="menu-panel" id="menuPanel" role="dialog" aria-label="Navigation">
    <div class="menu-header">
      <span class="menu-title">Navigation</span>
      <button class="menu-close" id="menuClose" aria-label="Close menu">X</button>
    </div>
    <ul class="menu-list" id="nav-list"></ul>
  </nav>

  <main class="page">
    <section class="hero-gallery" id="gallerySection">
      <div class="main-photo" id="mainPhotoBox">
        <img id="mainPhoto" alt="Vehicle photo" />
        <button class="view-all" id="viewAllBtn">View all photos</button>
      </div>
      <div class="thumbs" id="thumbList"></div>
    </section>

    <section class="section-card" style="margin-top:18px;">
      <div class="grid-two">
        <div class="stack">
          <div class="pill">Vehicle</div>
          <h1 id="vehicleTitle" style="margin:0;">Loading...</h1>
          <p class="muted" id="vehicleLocation"></p>
          <div id="quickSpecs" class="spec-grid"></div>
        </div>
        <div class="sidebar-card stack">
          <div>
            <div class="sidebar-kicker">Advertised Price</div>
            <div class="price-amount" id="priceBlock">$0</div>
            <div class="muted fineprint">Advertised by the host. Taxes/fees and availability may vary—confirm details before booking.</div>
          </div>
          <hr class="divider" />
          <div>
            <div class="sidebar-kicker">Contact</div>
            <button class="btn contact-toggle" id="contactOptionsBtn" type="button" aria-expanded="false" aria-controls="contactOptionsPanel">
              <span>View Contact Options</span>
              <span class="chev" aria-hidden="true"></span>
            </button>
            <div id="contactOptionsPanel" class="contact-panel" hidden>
              <div class="contact-rows">
                <div class="contact-row">
                  <div class="muted" style="font-weight:700;">Email</div>
                  <div id="contactEmail">-</div>
                </div>
                <div class="contact-row">
                  <div class="muted" style="font-weight:700;">Phone</div>
                  <div id="contactPhone">-</div>
                </div>
              </div>
              <div class="contact-actions">
                <button class="btn secondary" id="emailHostBtn" type="button">Email</button>
                <button class="btn secondary" id="callHostBtn" type="button">Phone</button>
              </div>
              <div class="muted fineprint">CJF Rentals is an advertising platform. Arrangements, availability, and payments are handled directly with the host.</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="section-card" style="margin-top:18px;">
      <h2 class="section-title">Hosted by</h2>
      <div class="host-card">
        <div class="avatar" id="hostAvatar">HU</div>
        <div>
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <span id="hostName" style="font-weight:800; font-size:18px;">Loading host...</span>
            <span class="pill-badge" id="hostBadge">Verified</span>
          </div>
          <div class="muted" id="hostMeta">Host - - vehicles - Joined -</div>
          <div class="btn-row">
            <button class="btn secondary" id="messageHostBtn">Message Host</button>
            <button class="btn" id="viewFleetBtn">View host's other vehicles</button>
          </div>
        </div>
      </div>
    </section>

    <section class="section-card" style="margin-top:18px;">
      <h2 class="section-title">Vehicle Details</h2>
      <div class="details-grid" id="detailsGrid">
        <div class="feature-block">
          <div class="muted" style="font-weight:700;">Features</div>
          <div id="featureChips" class="feature-chip-list" aria-label="Vehicle features"></div>
          <div class="feature-toggle-row">
            <button class="btn secondary" id="toggleFeaturesBtn" type="button" style="display:none;">Show all features</button>
          </div>
        </div>
        <aside class="host-notes" id="hostNotesBlock" hidden>
          <h3 class="host-notes-title">Host Notes</h3>
          <p class="host-notes-text" id="hostNotesText"></p>
        </aside>
      </div>
    </section>

    <section class="section-card" id="guidelinesSection" style="margin-top:18px;">
      <h2 class="section-title">Host Guidelines</h2>
      <p class="muted" style="margin:0 0 10px;">These guidelines are set by the vehicle owner.</p>
      <div id="guidelineChips" class="guideline-chip-list" aria-label="Host guidelines"></div>
      <div class="guideline-toggle-row">
        <button class="btn secondary" id="toggleGuidelinesBtn" type="button" style="display:none;">Show all guidelines</button>
      </div>
      <div class="rules" id="rulesList" style="display:none;"></div>
    </section>

    <section class="section-card" style="margin-top:18px;">
      <h2 class="section-title">Location &amp; pickup</h2>
      <div class="grid-two">
        <div class="stack">
          <div id="pickupInfo">-</div>
          <div id="deliveryInfo" class="muted"></div>
          <div id="altPickup" class="muted"></div>
        </div>
        <div class="map-box" id="mapBox">Map coming soon</div>
      </div>
    </section>

    <section class="section-card" style="margin-top:18px;">
      <h2 class="section-title">Similar vehicles you may like</h2>
      <div class="grid three" id="similarGrid"></div>
    </section>
  </main>

  <div class="lightbox-backdrop" id="lightbox">
    <div class="lightbox-panel" role="dialog" aria-label="Photo viewer">
            <div class="lightbox-header">
        <button class="icon-btn" id="lbBackBtn"><</button>
        <div id="lbCounter">1 of 1</div>
        <div class="lightbox-actions">
          <button class="icon-btn" id="lbCloseBtn">X</button>
        </div>
      </div>
      <div class="lightbox-body">
        <button class="nav-arrow left" id="lbPrev"><</button>
        <img id="lbImage" alt="Vehicle photo large" />
        <button class="nav-arrow right" id="lbNext">></button>
      </div>
    </div>
  </div>

  <script>
    // Menu wiring
    const menuPanel = document.getElementById('menuPanel');
    const backdrop = document.getElementById('backdrop');
    const openBtn = document.getElementById('menuToggle');
    const closeBtn = document.getElementById('menuClose');
    const openMenu = () => { menuPanel.classList.add('open'); backdrop.classList.add('show'); };
    const closeMenu = () => { menuPanel.classList.remove('open'); backdrop.classList.remove('show'); };
    openBtn.addEventListener('click', openMenu);
    closeBtn.addEventListener('click', closeMenu);
    backdrop.addEventListener('click', closeMenu);

    // Helpers
    const qs = (sel) => document.querySelector(sel);
    const setText = (el, text) => { if (el) el.textContent = text; };
    const safeList = (arr) => Array.isArray(arr) ? arr.filter(Boolean) : [];
    const asTrimmedString = (value) => (value === null || value === undefined) ? '' : String(value).trim();

    function normalizeContactValue(value) {
      const t = asTrimmedString(value);
      if (!t) return '';
      if (t === '-' || t === '---') return '';
      if (t.toLowerCase() === 'loading...') return '';
      return t;
    }

    function updateContactControls() {
      const optionsBtn = qs('#contactOptionsBtn');
      const panel = qs('#contactOptionsPanel');
      const emailBtn = qs('#emailHostBtn');
      const callBtn = qs('#callHostBtn');
      const email = normalizeContactValue(qs('#contactEmail')?.textContent);
      const phone = normalizeContactValue(qs('#contactPhone')?.textContent);

      if (!optionsBtn || !panel || !emailBtn || !callBtn) return { email, phone };

      emailBtn.disabled = !email;
      callBtn.disabled = !phone;

      const hasAny = !!email || !!phone;
      if (!hasAny) {
        optionsBtn.disabled = true;
        optionsBtn.textContent = 'Contact info unavailable';
        panel.hidden = true;
        optionsBtn.setAttribute('aria-expanded', 'false');
      } else {
        optionsBtn.disabled = false;
        if (optionsBtn.textContent.trim() === 'Contact info unavailable') optionsBtn.textContent = 'Contact Host';
      }
      return { email, phone };
    }

    async function ensureSafetyForContact() {
      try {
        if (window.CJF && typeof window.CJF.ensureSafetyAcknowledged === 'function') {
          return await window.CJF.ensureSafetyAcknowledged({ context: 'contact' });
        }
      } catch {}
      return true;
    }

    function formatInsurance(vehicle) {
      if (typeof vehicle?.insuranceIncluded === 'boolean') {
        return vehicle.insuranceIncluded ? 'Included' : 'Not included';
      }
      const raw = asTrimmedString(vehicle?.insurance);
      if (!raw) return '---';
      const low = raw.toLowerCase();
      if (low === 'yes' || low === 'included' || low === 'true') return 'Included';
      if (low === 'no' || low === 'not included' || low === 'false') return 'Not included';
      return raw;
    }

    function formatDrive(vehicle) {
      const raw = asTrimmedString(vehicle?.driveType || vehicle?.drive);
      return raw || '---';
    }

    function formatFuel(vehicle) {
      const raw = asTrimmedString(vehicle?.fuelType || vehicle?.fuel);
      return raw || '---';
    }

    function formatAvailability(vehicle) {
      const raw = asTrimmedString(vehicle?.availability);
      const low = raw.toLowerCase();
      if (!raw) return 'Available';
      if (low === 'rented') return 'Rented';
      return 'Available';
    }

    const placeholderImg = 'data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 400 300\"><rect fill=\"%23e5e7eb\" width=\"400\" height=\"300\"/><text x=\"200\" y=\"160\" text-anchor=\"middle\" fill=\"%23999\" font-size=\"20\" font-family=\"Arial\">No photo</text></svg>';

    let gallery = [];
    let currentIndex = 0;
    let currentHostId = null;
    let MAPS_EMBED_KEY_CACHE = '';

    async function getMapsKey() {
      if (MAPS_EMBED_KEY_CACHE) return MAPS_EMBED_KEY_CACHE;
      try {
        const res = await fetch('/.netlify/functions/map-key');
        if (!res.ok) throw new Error('Key fetch failed');
        const data = await res.json();
        MAPS_EMBED_KEY_CACHE = data.key || '';
      } catch (e) {
        console.warn('Map key fetch failed:', e.message);
        MAPS_EMBED_KEY_CACHE = '';
      }
      return MAPS_EMBED_KEY_CACHE;
    }

    function renderGallery(images) {
      gallery = images.length ? images : [placeholderImg];
      const main = qs('#mainPhoto');
      main.src = gallery[0];
      const thumbList = qs('#thumbList');
      thumbList.innerHTML = '';
      gallery.slice(0, 3).forEach((src, idx) => {
        const div = document.createElement('div');
        div.className = 'thumb';
        div.innerHTML = '<img alt=\"Thumbnail\" src=\"' + src + '\" />';
        div.addEventListener('click', () => openLightbox(idx));
        thumbList.appendChild(div);
      });
    }

    function openLightbox(idx = 0) {
      currentIndex = idx;
      qs('#lightbox').classList.add('show');
      document.body.style.overflow = 'hidden';
      renderLightbox();
    }
    function closeLightbox() {
      qs('#lightbox').classList.remove('show');
      document.body.style.overflow = '';
    }
    function renderLightbox() {
      qs('#lbImage').src = gallery[currentIndex];
      qs('#lbCounter').textContent = `${currentIndex + 1} of ${gallery.length}`;
    }
    function nextPhoto(dir = 1) {
      currentIndex = (currentIndex + dir + gallery.length) % gallery.length;
      renderLightbox();
    }

    async function loadHost(hostId, vehicle) {
      currentHostId = hostId;
      // reset avatar to placeholder before loading
      const avatarEl = qs('#hostAvatar');
      if (avatarEl) {
        avatarEl.style.backgroundImage = '';
        avatarEl.style.backgroundColor = '#0f172a';
        setText(avatarEl, 'HU');
      }
      let host = null;
      try {
        if (window.firebaseDb && hostId) {
          const snap = await firebaseDb.collection('users').doc(String(hostId)).get();
          if (snap.exists) {
            host = { id: hostId, ...snap.data() };
          }
        }
      } catch (e) {
        console.warn('Host fetch failed:', e.message);
      }

      // Best-effort vehicle count for this host
      let hostVehicleCount = 0;
      try {
        const all = await VehicleStore.getActiveVehicles();
        hostVehicleCount = all.filter(v => v.ownerId === hostId || v.hostId === hostId).length;
      } catch (e) {
        hostVehicleCount = host?.vehicleCount || 0;
      }

      const hostName =
        host?.displayName ||
        host?.name ||
        [host?.firstName, host?.lastName].filter(Boolean).join(' ') ||
        host?.firstName ||
        vehicle?.hostName ||
        'Host';
      setText(qs('#hostName'), hostName);
      const initials = hostName.split(' ').map(p => p[0]).join('').substring(0,2).toUpperCase() || 'HU';
      if (avatarEl) {
        if (host?.avatar) {
          avatarEl.style.backgroundImage = `url('${host.avatar}')`;
          avatarEl.style.backgroundSize = 'cover';
          avatarEl.style.backgroundPosition = 'center';
          avatarEl.style.backgroundColor = 'transparent';
          setText(avatarEl, '');
        } else {
          avatarEl.style.backgroundImage = '';
          avatarEl.style.backgroundColor = '#0f172a';
          setText(avatarEl, initials);
        }
      }
      setText(qs('#hostMeta'), `${host?.type || host?.role || 'Host'} - ${hostVehicleCount} vehicles - Joined ${host?.joined || 'recently'}`);
      if (host && host.verified === false) {
        qs('#hostBadge').style.display = 'none';
      }
      const fleetUrl = hostId ? `host-profile-public.html?id=${encodeURIComponent(hostId)}` : '#';
      qs('#hostAvatar').style.cursor = 'pointer';
      qs('#hostAvatar').onclick = () => { if (hostId) window.location.href = fleetUrl; };
      qs('#hostName').style.cursor = 'pointer';
      qs('#hostName').onclick = () => { if (hostId) window.location.href = fleetUrl; };
      qs('#viewFleetBtn').onclick = () => { if (hostId) window.location.href = fleetUrl; };
      qs('#messageHostBtn').onclick = () => {
        const optionsBtn = qs('#contactOptionsBtn');
        const panel = qs('#contactOptionsPanel');
        if (!optionsBtn || !panel || optionsBtn.disabled) return;
        ensureSafetyForContact().then((ok) => {
          if (!ok) return;
          panel.hidden = false;
          optionsBtn.setAttribute('aria-expanded', 'true');
          optionsBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
        });
      };

      // Contact: prefer live host profile values, fall back to listing-specific contact
      const resolvedEmail = (host?.email || '').toString().trim() || (vehicle?.contactEmail || '').toString().trim();
      const resolvedPhone = (host?.phone || '').toString().trim() || (vehicle?.contactPhone || '').toString().trim();
      setText(qs('#contactEmail'), resolvedEmail || '-');
      setText(qs('#contactPhone'), resolvedPhone || '-');
      updateContactControls();
    }

    function normalizeFeatureLabel(value) {
      return (value || '')
        .toString()
        .replace(/\s+/g, ' ')
        .trim();
    }

    function dedupeFeatures(list) {
      const seen = new Set();
      const out = [];
      safeList(list).forEach((raw) => {
        const label = normalizeFeatureLabel(raw);
        if (!label) return;
        const key = label.toLowerCase();
        if (seen.has(key)) return;
        seen.add(key);
        out.push(label);
      });
      return out;
    }

    function renderVehicleDetails(vehicle) {
      const allFeatures = dedupeFeatures([
        ...(safeList(vehicle?.featuresConvenience)),
        ...(safeList(vehicle?.featuresSafety)),
        ...(safeList(vehicle?.featuresTech))
      ]);

      const chipsEl = qs('#featureChips');
      const toggleBtn = qs('#toggleFeaturesBtn');
      const grid = qs('#detailsGrid');
      const notesBlock = qs('#hostNotesBlock');
      const notesText = qs('#hostNotesText');

      // Host notes: never highlight "nothing"
      const notes = (vehicle?.hostNotes || '').toString().trim();
      if (notes) {
        notesText.textContent = notes;
        notesBlock.hidden = false;
        grid.classList.add('has-notes');
      } else {
        notesText.textContent = '';
        notesBlock.hidden = true;
        grid.classList.remove('has-notes');
      }

      const MOBILE_MAX = 8;
      let expanded = false;

      const isMobile = () => window.matchMedia('(max-width: 767px)').matches;

      const renderChips = () => {
        chipsEl.innerHTML = '';

        const showAll = !isMobile() || expanded;
        const list = showAll ? allFeatures : allFeatures.slice(0, MOBILE_MAX);

        if (!list.length) {
          const span = document.createElement('span');
          span.className = 'muted';
          span.textContent = 'Features not listed.';
          chipsEl.appendChild(span);
        } else {
          list.forEach((label) => {
            const chip = document.createElement('span');
            chip.className = 'feature-chip';
            const icon = document.createElement('span');
            icon.className = 'feature-chip-icon';
            icon.setAttribute('aria-hidden', 'true');
            icon.textContent = '✓';
            const text = document.createElement('span');
            text.textContent = label;
            chip.appendChild(icon);
            chip.appendChild(text);
            chipsEl.appendChild(chip);
          });
        }

        const shouldToggle = isMobile() && allFeatures.length > MOBILE_MAX;
        toggleBtn.style.display = shouldToggle ? 'inline-flex' : 'none';
        if (shouldToggle) {
          toggleBtn.textContent = expanded ? 'Show fewer features' : 'Show all features';
        }
      };

      toggleBtn.onclick = () => {
        expanded = !expanded;
        renderChips();
      };

      window.addEventListener('resize', renderChips);
      renderChips();
    }

    function renderRules(rules) {
      const section = qs('#guidelinesSection');
      const chipsEl = qs('#guidelineChips');
      const toggleBtn = qs('#toggleGuidelinesBtn');

      const normalizeRule = (value) => (value || '').toString().replace(/\s+/g, ' ').trim();
      const dedupe = (list) => {
        const seen = new Set();
        const out = [];
        safeList(list).forEach((r) => {
          const label = normalizeRule(r?.text ?? r);
          if (!label) return;
          const key = label.toLowerCase();
          if (seen.has(key)) return;
          seen.add(key);
          out.push(label);
        });
        return out;
      };

      const allRules = dedupe(rules);
      if (!allRules.length) {
        section.hidden = true;
        return;
      }
      section.hidden = false;

      const MOBILE_MAX = 4;
      let expanded = false;
      const isMobile = () => window.matchMedia('(max-width: 767px)').matches;

      const render = () => {
        chipsEl.innerHTML = '';
        const showAll = !isMobile() || expanded;
        const list = showAll ? allRules : allRules.slice(0, MOBILE_MAX);

        list.forEach((label) => {
          const chip = document.createElement('span');
          chip.className = 'guideline-chip';
          const dot = document.createElement('span');
          dot.className = 'guideline-dot';
          dot.setAttribute('aria-hidden', 'true');
          dot.textContent = '•';
          const text = document.createElement('span');
          text.textContent = label;
          chip.appendChild(dot);
          chip.appendChild(text);
          chipsEl.appendChild(chip);
        });

        const shouldToggle = isMobile() && allRules.length > MOBILE_MAX;
        toggleBtn.style.display = shouldToggle ? 'inline-flex' : 'none';
        if (shouldToggle) toggleBtn.textContent = expanded ? 'Show fewer guidelines' : 'Show all guidelines';
      };

      toggleBtn.onclick = () => {
        expanded = !expanded;
        render();
      };

      window.addEventListener('resize', render);
      render();
    }

    function renderSimilar(category, excludeId) {
      VehicleStore.getActiveVehicles().then(list => {
        const grid = qs('#similarGrid');
        grid.innerHTML = '';
        list.filter(v => v.id !== excludeId && (!category || v.category === category)).slice(0,6).forEach(v => {
          const card = document.createElement('a');
          card.href = `vehicle.html?id=${v.id}`;
          card.className = 'card';
          card.innerHTML = `
            <img src="${(v.photos && v.photos[0]) || v.image || placeholderImg}" alt="${v.title || 'Vehicle'}" style="width:100%; height:160px; object-fit:cover; border-radius:12px;" />
            <div style="padding:10px;">
              <div style="font-weight:800;">${v.title || 'Vehicle'}</div>
              <div class="muted" style="font-size:13px;">${v.city || ''} ${v.state || ''}</div>
            </div>
          `;
          grid.appendChild(card);
        });
        if (!grid.childElementCount) {
          grid.innerHTML = '<div class=\"muted\">No similar vehicles right now.</div>';
        }
      });
    }

    function waitForFirebase(timeoutMs = 3000) {
      return new Promise((resolve) => {
        const start = Date.now();
        const check = () => {
          if (window.firebaseDb) return resolve(true);
          if (Date.now() - start > timeoutMs) return resolve(false);
          requestAnimationFrame(check);
        };
        check();
      });
    }

    async function loadVehicle() {
      const params = new URLSearchParams(window.location.search);
      const vehicleId = params.get('id');
      if (!vehicleId) {
        alert('Missing vehicle id');
        return;
      }
      try {
        await waitForFirebase(); // ensure firebaseDb is ready
        let vehicle = null;

        // Try direct Firestore doc first (works for guests)
        if (window.firebaseDb) {
          try {
            const snap = await firebaseDb.collection('vehicles').doc(String(vehicleId)).get();
            if (snap.exists) {
              vehicle = { id: vehicleId, ...snap.data() };
              console.log('Vehicle loaded via direct Firestore');
            }
          } catch (err) {
            console.warn('Direct Firestore fetch failed:', err.message);
          }
        }

        // Fallback to store
        if (!vehicle) {
          vehicle = await VehicleStore.getVehicleById(vehicleId);
          if (vehicle) {
            console.log('Vehicle loaded via VehicleStore');
          }
        }

        if (!vehicle) {
          setText(qs('#vehicleTitle'), 'Vehicle not found');
          setText(qs('#vehicleLocation'), '');
          qs('#quickSpecs').innerHTML = '';
          setText(qs('#priceBlock'), 'N/A');
        qs('#contactEmail').textContent = '-';
        qs('#contactPhone').textContent = '-';
        qs('#gallerySection').style.display = 'none';
        return;
      }

        // Gallery
        const photos = safeList(vehicle.photos || []).length ? vehicle.photos : [];
        renderGallery(photos);
        qs('#viewAllBtn').onclick = () => openLightbox(0);

        // Title and basics
        setText(qs('#vehicleTitle'), vehicle.title || [vehicle.make, vehicle.model, vehicle.year].filter(Boolean).join(' ') || 'Vehicle');
        setText(qs('#vehicleLocation'), [vehicle.city, vehicle.state, vehicle.country].filter(Boolean).join(', '));
        setText(qs('#priceBlock'), vehicle.price ? `$${vehicle.price}/day` : '$0/day');

        const specPairs = [
          ['Year', vehicle.year || '---'],
          ['Fuel', formatFuel(vehicle)],
          ['Transmission', vehicle.transmission || '---'],
          ['Seats', vehicle.seats || '---'],
          ['Category', vehicle.category || '---'],
          ['Availability', formatAvailability(vehicle)],
          ['Insurance', formatInsurance(vehicle)],
          ['Drive', formatDrive(vehicle)]
        ];
        const specBox = qs('#quickSpecs');
        specBox.innerHTML = '';
        specPairs.forEach(([label, value]) => {
          const div = document.createElement('div');
          div.className = 'spec';
          div.innerHTML = `<div class=\"muted\" style=\"font-weight:600; font-size:13px;\">${label}</div><div style=\"font-weight:800;\">${value}</div>`;
          specBox.appendChild(div);
        });

        const optionsBtn = qs('#contactOptionsBtn');
        const panel = qs('#contactOptionsPanel');
        const emailBtn = qs('#emailHostBtn');
        const callBtn = qs('#callHostBtn');

        const setPanelOpen = (open) => {
          panel.hidden = !open;
          optionsBtn.setAttribute('aria-expanded', open ? 'true' : 'false');
        };

        // Seed contact from listing (fast), then prefer host profile after loadHost()
        setText(qs('#contactEmail'), normalizeContactValue(vehicle.contactEmail) || '-');
        setText(qs('#contactPhone'), normalizeContactValue(vehicle.contactPhone) || '-');
        updateContactControls();

        optionsBtn.onclick = async () => {
          if (optionsBtn.disabled) return;
          const ok = await ensureSafetyForContact();
          if (!ok) return;
          setPanelOpen(panel.hidden);
        };
        setPanelOpen(false);

        emailBtn.onclick = async () => {
          const email = normalizeContactValue(qs('#contactEmail')?.textContent);
          if (!email) return;
          const ok = await ensureSafetyForContact();
          if (!ok) return;
          window.location.href = `mailto:${email}`;
        };
        callBtn.onclick = async () => {
          const phone = normalizeContactValue(qs('#contactPhone')?.textContent);
          if (!phone) return;
          const ok = await ensureSafetyForContact();
          if (!ok) return;
          window.location.href = `tel:${phone}`;
        };

        // Host (also resolves contact info from profile)
        await loadHost(vehicle.ownerId || vehicle.hostId, vehicle);
        updateContactControls();

        // Vehicle details (features + host notes)
        renderVehicleDetails(vehicle);

        // Rules
        renderRules(vehicle.rules || []);

        // Location
        const pickupParts = [vehicle.address, vehicle.city, vehicle.state, vehicle.country].filter(Boolean).join(', ');
        setText(qs('#pickupInfo'), pickupParts || 'Location not provided');
        setText(qs('#altPickup'), vehicle.pickupAlt || '');
        setText(qs('#deliveryInfo'), vehicle.deliveryRadius ? `Host will deliver within ${vehicle.deliveryRadius} miles` : '');

        // Map embed (Google Maps Embed API)
        const mapBox = qs('#mapBox');
        const MAPS_EMBED_KEY = await getMapsKey();
        if (pickupParts && MAPS_EMBED_KEY) {
          const q = encodeURIComponent(pickupParts);
          mapBox.innerHTML = `<iframe
            title="Pickup location map"
            width="100%"
            height="100%"
            style="border:0; border-radius: 12px;"
            loading="lazy"
            allowfullscreen
            referrerpolicy="no-referrer-when-downgrade"
            src="https://www.google.com/maps/embed/v1/place?key=${MAPS_EMBED_KEY}&q=${q}">
          </iframe>`;
        } else {
          mapBox.textContent = pickupParts ? 'Map disabled (no API key)' : 'Location not provided';
        }

        // Similar
        renderSimilar(vehicle.category, vehicle.id);
      } catch (e) {
        console.error('Error loading vehicle', e);
        alert('Failed to load vehicle details');
      }
    }

    // Lightbox events
    qs('#lbBackBtn').onclick = closeLightbox;
    qs('#lbCloseBtn').onclick = closeLightbox;
    qs('#lbPrev').onclick = () => nextPhoto(-1);
    qs('#lbNext').onclick = () => nextPhoto(1);

    // Mobile: swipe left/right to navigate photos (arrows are hidden via CSS).
    (function initLightboxSwipe() {
      const lightbox = qs('#lightbox');
      const body = qs('.lightbox-body') || qs('#lightbox');
      if (!lightbox || !body) return;

      let startX = 0;
      let startY = 0;
      let tracking = false;

      const onStart = (e) => {
        if (!lightbox.classList.contains('show')) return;
        if (!e.touches || e.touches.length !== 1) return;
        tracking = true;
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
      };

      const onMove = (e) => {
        if (!tracking) return;
        if (!e.touches || e.touches.length !== 1) return;
        const dx = e.touches[0].clientX - startX;
        const dy = e.touches[0].clientY - startY;
        if (Math.abs(dx) > 10 && Math.abs(dx) > Math.abs(dy)) {
          e.preventDefault();
        }
      };

      const onEnd = (e) => {
        if (!tracking) return;
        tracking = false;
        if (!e.changedTouches || e.changedTouches.length !== 1) return;
        if (!Array.isArray(gallery) || gallery.length <= 1) return;
        const dx = e.changedTouches[0].clientX - startX;
        const dy = e.changedTouches[0].clientY - startY;
        if (Math.abs(dx) < 50 || Math.abs(dx) <= Math.abs(dy)) return;
        nextPhoto(dx < 0 ? 1 : -1);
      };

      body.addEventListener('touchstart', onStart, { passive: true });
      body.addEventListener('touchmove', onMove, { passive: false });
      body.addEventListener('touchend', onEnd, { passive: true });
      body.addEventListener('touchcancel', () => { tracking = false; }, { passive: true });
    })();

    qs('#lightbox').addEventListener('click', (e) => { if (e.target === e.currentTarget) closeLightbox(); });
    document.addEventListener('keydown', (e) => {
      if (!qs('#lightbox').classList.contains('show')) return;
      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowRight') nextPhoto(1);
      if (e.key === 'ArrowLeft') nextPhoto(-1);
    });

    document.addEventListener('DOMContentLoaded', () => {
      const isAuthed = (window.AuthManager && typeof AuthManager.isAuthenticated === 'function')
        ? AuthManager.isAuthenticated()
        : false;
      NavBuilder.renderNav(isAuthed);
      if (window.AuthManager && typeof AuthManager.setupFirebaseAuthListener === 'function') {
        AuthManager.setupFirebaseAuthListener();
      }
      loadVehicle();
    });
  </script>
</body>
</html>









