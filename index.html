
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>CJF | Global Vehicle Rentals</title>
	<link rel="preconnect" href="https://fonts.googleapis.com" />
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
	<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&display=swap" rel="stylesheet" />
	<link rel="stylesheet" href="assets/style.css" />
	<script src="assets/countryStateData.js"></script>
</head>
<body>
	<header class="header">
		<div class="header-inner">
			<a class="brand" href="index.html">
				<span class="brand-mark">CJF</span>
				<span>CJF Rentals</span>
			</a>
			<button class="menu-button" id="menuToggle" aria-label="Open menu">☰</button>
		</div>
	</header>
	<div class="backdrop" id="backdrop"></div>
	<nav class="menu-panel" id="menuPanel" role="dialog" aria-label="Navigation">
		<div class="menu-header">
			<span class="menu-title">Navigation</span>
			<button class="menu-close" id="menuClose" aria-label="Close menu"></button>
		</div>
		<ul class="menu-list" id="nav-list">
			<!-- Menu items built dynamically by navBuilder.js -->
		</ul>
	</nav>

	<main class="page">
		<section class="hero">
			<div class="hero-inner">
				<div class="hero-card">
					<h1 class="hero-title">Browse premium vehicles, contact hosts directly, and rent worldwide.</h1>
					<p class="hero-subtitle">Search by location, pick a price frequency, and jump straight into the feed.</p>
					<div class="filters hero-filters">
						<div>
							<label for='country'>Country</label>
              <input id='country' class='input' list='countryList' value='Any' autocomplete='country-name' />
              <datalist id='countryList'></datalist>
            </div>
					<div>
						<label for="state">State</label>
                        <input id="state" class="input" list="stateList" value="Any" autocomplete="address-level1" />
                        <datalist id="stateList"><option value="Any">Any</option></datalist>
                        </div>
					<div>
						<label for="city">City</label>
						<input id="city" class="input" type="text" placeholder="Type a city" />
					</div>
					<div>
						<label for="frequency">Price frequency</label>
						<select id="frequency">
							<option value="Any" selected>Any</option>
							<option value="Daily">Daily</option>
							<option value="Weekly">Weekly</option>
							<option value="Monthly">Monthly</option>
						</select>
                    </div>
					</div>
					<div class="hero-actions">
						<a class="button" href="vehicles.html">Browse vehicles</a>
						<a class="button ghost" href="host-signup.html" data-hide-when-host>Become a host</a>
						<button class="button ghost location-btn" type="button" id="locationBtn" aria-label="Use my location">
							<svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
								<path d="M12 2a8 8 0 0 0-8 8c0 6 7.2 11.4 7.5 11.6a1 1 0 0 0 1 0C12.8 21.4 20 16 20 10a8 8 0 0 0-8-8Zm0 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6Z"></path>
							</svg>
						</button>
					</div>
				</div>
			</div>
		</section>

		<section class="category-filter-bar">
			<div class="categories">
				<span class="category-chip" data-category="All">All</span>
				<span class="category-chip" data-category="SUV">SUV</span>
				<span class="category-chip" data-category="Sedan">Sedan</span>
				<span class="category-chip" data-category="Coupe">Coupe</span>
				<span class="category-chip" data-category="Truck">Truck</span>
				<span class="category-chip" data-category="Bike">Bike</span>
				<span class="category-chip" data-category="Convertible">Convertible</span>
				<span class="category-chip" data-category="Minivan">Minivan</span>
				<span class="category-chip" data-category="Hatchback">Hatchback</span>
				<span class="category-chip" data-category="Station Wagon">Station Wagon</span>
				<span class="category-chip" data-category="Bus">Bus</span>
			</div>
		</section>

		<section>
			<div id="locationShelves" class="location-shelves"></div>
			<div id="filterEmptyMsg" class="empty-state" style="display:none; text-align:center; padding:32px 20px; grid-column:1 / -1;">
				<p style="font-size:16px; color:#666; margin:0;">No vehicles found for this location.</p>
				<p class="muted" style="margin-top:8px;">Try another country, state, or city.</p>
			</div>
		</section>
	</main>

	<!-- Footer with Legal Links -->
	<footer style="background: #f8f9fa; border-top: 1px solid #e5e7eb; padding: 32px 20px; margin-top: 48px;">
		<div style="max-width: 1200px; margin: 0 auto; text-align: center;">
			<p style="margin: 0 0 16px 0; font-size: 14px; color: #666; line-height: 1.6;">
				<strong>CJF is an advertising platform only.</strong> All rentals, payments, and agreements occur directly between Host and Renter. CJF is not responsible for scams, disputes, damages, or vehicle issues. Use safely and responsibly.
			</p>
			<div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 16px; margin-top: 16px;">
				<a href="terms.html" style="color: var(--accent); font-size: 14px;">Terms & Conditions</a>
				<a href="privacy.html" style="color: var(--accent); font-size: 14px;">Privacy Policy</a>
				<a href="host-agreement.html" style="color: var(--accent); font-size: 14px;">Host Agreement</a>
				<a href="safety.html" style="color: var(--accent); font-size: 14px;">Safety Guidelines</a>
				<a href="https://www.tiktok.com/@cjfrentals" target="_blank" rel="noopener" style="color: var(--accent); font-size: 14px;">TikTok</a>
				<a href="contact.html" style="color: var(--accent); font-size: 14px;">Contact Support</a>
			</div>
			<p style="margin: 16px 0 0 0; font-size: 13px; color: #999;">
				 2025 CJF. All rights reserved.
			</p>
		</div>
	</footer>

	<div class="toast" id="toast" role="status" aria-live="polite"></div>

	<script>
		const toTitleCase = (value) => {
			const s = (value ?? '').toString().trim();
			if (!s) return '';
			return s
				.split(/\s+/g)
				.map((w) => w ? (w[0].toUpperCase() + w.slice(1).toLowerCase()) : w)
				.join(' ');
		};

		const sanitizeYear = (year) => {
			const y = Number(year);
			if (!Number.isFinite(y)) return '';
			const max = new Date().getFullYear() + 1;
			if (y < 1985 || y > max) return '';
			return String(y);
		};

		const normalizeCategory = (value) => {
			const raw = (value ?? '').toString().trim();
			if (!raw) return 'Vehicle';
			const normalized = toTitleCase(raw);
			const allowed = new Set(['SUV','Sedan','Coupe','Truck','Bike','Convertible','Minivan','Hatchback','Station Wagon','Bus','Wagon']);
			if (allowed.has(normalized)) return normalized;
			if (normalized === 'Stationwagon') return 'Station Wagon';
			return 'Vehicle';
		};

		const normalizeFuel = (value) => {
			const raw = toTitleCase((value ?? '').toString().trim());
			const allowed = new Set(['Gas','Diesel','Hybrid','Electric']);
			return allowed.has(raw) ? raw : '';
		};

		const shouldHideMetaForMismatch = ({ make, model, category, fuel }) => {
			const m = (model || '').toString().toLowerCase();
			const mk = (make || '').toString().toLowerCase();
			const cat = (category || '').toString().toLowerCase();
			const fu = (fuel || '').toString().toLowerCase();

			// Common passenger-car model names; helps catch obvious “Accord → Truck” type issues.
			const looksPassenger = /(accord|civic|camry|corolla|altima|sentra|malibu|impala|elantra|sonata|fusion|focus|prius|model\s*3|model\s*s|model\s*y|model\s*x|a4|a6|c-?class|e-?class|3\s*series|5\s*series|golf|jetta)/.test(m);
			const looksElectricModel = /(model\s*3|model\s*s|model\s*y|model\s*x|leaf|bolt|ioniq|ev|mach-?e|id\.?4|taycan)/.test(m);
			const dieselUnlikelyMake = /^(honda|toyota|nissan|hyundai|kia)$/.test(mk);
			const dieselUnlikelyModel = /(accord|civic|camry|corolla|altima|sentra|elantra|sonata|prius)/.test(m);

			if ((cat === 'truck' || cat === 'bus' || cat === 'bike') && looksPassenger) return true;
			if (looksElectricModel && fu === 'diesel') return true;
			// Honda Accord/Civic etc are almost never trucks.
			if (mk === 'honda' && cat === 'truck' && looksPassenger) return true;
			// On a rental marketplace, showing "Accord • Diesel" hurts trust even if it's test data.
			if (fu === 'diesel' && (dieselUnlikelyMake || dieselUnlikelyModel)) return true;
			return false;
		};

		const normalizeFrequency = (value) => {
			const v = (value ?? '').toString().trim().toLowerCase();
			if (!v) return 'Daily';
			if (v.startsWith('day')) return 'Daily';
			if (v.startsWith('week')) return 'Weekly';
			if (v.startsWith('month')) return 'Monthly';
			return 'Daily';
		};

		const formatPrice = (price, frequency) => {
			const n = Number(price);
			const freq = normalizeFrequency(frequency);
			const unit = (freq === 'Weekly') ? 'week' : (freq === 'Monthly') ? 'month' : 'day';
			if (!Number.isFinite(n) || n <= 0) return `Contact for price / ${unit}`;
			return `$${n} / ${unit}`;
		};

		const normalizeVehicle = (v) => {
			const clean = (x) => (x ?? '').toString().trim();
			const make = toTitleCase(clean(v?.make));
			const model = toTitleCase(clean(v?.model));
			const country = toTitleCase(clean(v?.country));
			const state = toTitleCase(clean(v?.state));
			const city = toTitleCase(clean(v?.city));
			const category = normalizeCategory(v?.vehicleType || v?.category);
			const fuel = normalizeFuel(v?.fuelType || v?.fuel);
			const frequency = normalizeFrequency(v?.frequency || v?.priceFrequency);
			const year = sanitizeYear(v?.year || v?.modelYear);

			const hideMeta = shouldHideMetaForMismatch({ make, model, category, fuel });
			return {
				...v,
				make,
				model,
				country,
				state,
				city,
				category: hideMeta ? 'Vehicle' : category,
				fuel: hideMeta ? '' : fuel,
				frequency,
				year,
				price: (v?.price != null ? v.price : (v?.pricePerDay != null ? v.pricePerDay : v?.pricePerWeek != null ? v.pricePerWeek : v?.pricePerMonth != null ? v.pricePerMonth : 0)),
			};
		};

		// Use VehicleStore as single source of truth
		const getActiveVehicles = async () => {
			return await VehicleStore.getActiveVehicles();
		};

		const normalizeLocation = (value) => (value ?? '').toString().trim().toLowerCase();

		let homeVehiclesAll = [];

			const renderShelvesLoading = () => {
				const container = document.getElementById('locationShelves');
				if (!container) return;
				container.innerHTML = `
					<section class="location-shelf">
						<div class="location-shelf-header">
							<h3 class="location-shelf-title">Loading vehicles…</h3>
						</div>
						<div class="shelf-row" aria-hidden="true">
							${Array.from({ length: 8 }).map(() => {
								return `
									<article class="card vehicle-card">
										<div class="vehicle-card-link">
											<div class="vehicle-card-image skeleton"></div>
											<div class="vehicle-card-body">
												<div class="vehicle-spec skeleton skeleton-line sm" style="width: 58%;"></div>
												<div class="vehicle-title skeleton skeleton-line lg" style="width: 92%;"></div>
												<div class="vehicle-location skeleton skeleton-line md" style="width: 70%;"></div>
												<div class="vehicle-bottom" style="margin-top: 10px;">
													<div class="vehicle-price skeleton skeleton-line lg" style="width: 44%;"></div>
													<div class="badges" style="width: 40%;">
														<div class="badge skeleton" style="height: 26px; width: 100%; border-radius: 10px;"></div>
													</div>
												</div>
											</div>
										</div>
									</article>
								`;
							}).join('')}
						</div>
					</section>
				`;
			};

			// Render vehicle card HTML
		const createVehicleCardHtml = (vehicle) => {
			const clean = (value) => (value ?? '').toString().trim();
			const v = normalizeVehicle(vehicle);
			const insuranceIncluded = v.insuranceIncluded === true || clean(v.insurance || '').toLowerCase() === 'included' || clean(v.insurance || '').toLowerCase() === 'yes';
			const insuranceLabel = insuranceIncluded ? 'Insurance included' : 'Insurance not included';
			const insuranceClass = insuranceIncluded ? 'badge badge--success' : 'badge badge--danger';
			const availability = clean(v.availability || '').toLowerCase() === 'rented' ? 'rented' : 'available';
			const availabilityLabel = availability === 'rented' ? 'Rented' : 'Available';
			const availabilityClass = availability === 'rented' ? 'badge badge--rented' : 'badge badge--available';
			const specLine = [v.year, (v.category && v.category !== 'Vehicle') ? v.category : '', v.fuel].filter(Boolean).join(' • ');
			const locationLine = [v.city, v.state || v.country].filter(Boolean).join(' • ');
			const title = [v.make, v.model].filter(Boolean).join(' ').trim() || 'Vehicle';
			const priceLabel = formatPrice(v.price, v.frequency);
			
				// Create placeholder SVG for vehicles without photos
				const placeholderSvg = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 300"><defs><linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:%23e5e7eb;stop-opacity:1" /><stop offset="100%" style="stop-color:%23d1d5db;stop-opacity:1" /></linearGradient></defs><rect fill="url(%23grad)" width="400" height="300"/><g transform="translate(200, 80)"><circle cx="0" cy="0" r="35" fill="%23999" opacity="0.3"/></g><g transform="translate(200, 160)"><rect x="-60" y="0" width="120" height="70" rx="8" fill="none" stroke="%23999" stroke-width="3" opacity="0.3"/><rect x="-50" y="10" width="30" height="20" rx="4" fill="%23999" opacity="0.3"/><rect x="20" y="10" width="30" height="20" rx="4" fill="%23999" opacity="0.3"/><rect x="-35" y="50" width="70" height="8" rx="4" fill="%23999" opacity="0.3"/></g><text x="200" y="280" text-anchor="middle" font-family="Arial" font-size="16" fill="%23999" opacity="0.5">No photo</text></svg>';
			
				// Use image from vehicle, or fall back to placeholder
				// Note: vehicleStore already adds placeholder if missing, but we provide one here as well
				const image = v.image || (v.photos && v.photos[0]) || placeholderSvg;

				const badges = [];
				badges.push(`<span class="${availabilityClass}">${availabilityLabel}</span>`);
				badges.push(`<span class="${insuranceClass}">${insuranceLabel}</span>`);

				return `
					<article class="card vehicle-card" data-vehicle data-type="${clean(v.category)}" data-country="${clean(v.country)}" data-state="${clean(v.state)}" data-city="${clean(v.city)}" data-frequency="${clean(v.frequency)}" data-id="${v.id}" data-make="${clean(v.make)}" data-year="${clean(v.year)}" data-price="${v.price || ''}" data-transmission="${clean(v.transmission)}" data-fuel="${clean(v.fuel)}" data-seats="${v.seats || ''}">
						<a href="vehicle.html?id=${v.id}" class="vehicle-card-link">
							<div class="vehicle-card-image"><img src="${image}" alt="${title}" /></div>
							<div class="vehicle-card-body">
								<div class="vehicle-spec">${specLine || ''}</div>
								<div class="vehicle-title line-clamp-2">${title}</div>
								<div class="vehicle-location">${locationLine || ''}</div>
								<div class="vehicle-bottom">
									<div class="vehicle-price">${priceLabel}</div>
									<div class="badges">${badges.slice(0,2).join('')}</div>
								</div>
							</div>
						</a>
					</article>
				`;
			};
		const buildListingUrl = ({ country, state, city } = {}) => {
			const params = new URLSearchParams();
			if (country) params.set('country', country);
			if (state) params.set('state', state);
			if (city) params.set('city', city);
			const qs = params.toString();
			return qs ? `vehicles.html?${qs}` : 'vehicles.html';
		};

		const getLocationGroupInfo = (vehicle) => {
			const clean = (v) => (v ?? '').toString().trim();
			const country = clean(vehicle?.country);
			const state = clean(vehicle?.state);
			const city = clean(vehicle?.city);

			if (city) {
				const parts = [city, state, country].filter(Boolean);
				return { key: `city|${parts.join('|')}`, title: `Vehicles in ${parts.join(', ')}`, url: buildListingUrl({ country, state, city }) };
			}
			if (state) {
				const parts = [state, country].filter(Boolean);
				return { key: `state|${parts.join('|')}`, title: `Vehicles in ${parts.join(', ')}`, url: buildListingUrl({ country, state }) };
			}
			if (country) {
				return { key: `country|${country}`, title: `Vehicles in ${country}`, url: buildListingUrl({ country }) };
			}
			return { key: 'country|unknown', title: 'Vehicles near you', url: 'vehicles.html' };
		};

		const renderLocationShelves = (vehicles) => {
			const container = document.getElementById('locationShelves');
			if (!container) return;
			container.innerHTML = '';

			const list = Array.isArray(vehicles) ? vehicles : [];
			if (!list.length) return;

			const groups = new Map();
			list.forEach((v) => {
				const info = getLocationGroupInfo(v);
				const rec = groups.get(info.key) || { info, items: [] };
				rec.items.push(v);
				groups.set(info.key, rec);
			});

			const sorted = Array.from(groups.values()).sort((a, b) => b.items.length - a.items.length);
			sorted.slice(0, 10).forEach((group, idx) => {
				const section = document.createElement('section');
				section.className = 'location-shelf';
				const viewAll = (group.items || []).length > 8
					? `<a class="shelf-viewall" href="${group.info.url}">View all</a>`
					: '';
				section.innerHTML = `
					<div class="location-shelf-header">
						<a class="location-shelf-link" href="${group.info.url}">
							<h3 class="location-shelf-title">${group.info.title}</h3>
						</a>
						<div class="location-shelf-actions">${viewAll}</div>
					</div>
					<div class="shelf-row" id="shelfRow${idx}"></div>
				`;

				const row = section.querySelector(`#shelfRow${idx}`);
				const count = (group.items || []).length;
				if (row) {
					row.classList.toggle('shelf-row--single', count === 1);
					row.classList.toggle('shelf-row--pair', count === 2);
				}
				(group.items || []).slice(0, 12).forEach((veh) => {
					row.insertAdjacentHTML('beforeend', createVehicleCardHtml(veh));
				});


				if ((group.items || []).length > 0 && (group.items || []).length < 4) {
					const cta = document.createElement('div');
					cta.className = 'shelf-cta';
					const title = group.info.title.replace(/^Vehicles in\s+/i, '').split(',')[0] || 'this area';
					const helper = (group.items || []).length <= 2
						? `<div class="muted" style="margin-top:6px; font-size:13px;">More vehicles coming soon in this area.</div>`
						: '';
					cta.innerHTML = `<a href="${group.info.url}">Browse all vehicles in ${title}</a>${helper}`;
					section.appendChild(cta);
				}

				container.appendChild(section);
			});
		};

		// Initialize homepage with live fleet data
		const initializeFleetDisplay = async () => {
			console.log(' Initializing fleet display...');
			renderShelvesLoading();
			const activeVehicles = await getActiveVehicles();
			console.log(` Found ${activeVehicles.length} active vehicles to display`);

			homeVehiclesAll = (activeVehicles || []).map((vehicle) => normalizeVehicle(vehicle));

			populateMakeOptions(homeVehiclesAll);
			applyFilters();
		};

		// Wait for external scripts and DOMContentLoaded before initializing
			const initWhenReady = () => {
				// Menu wiring lives here to avoid hoist issues
				const menuPanel = document.getElementById('menuPanel');
				const backdrop = document.getElementById('backdrop');
				const openBtn = document.getElementById('menuToggle');
				const closeBtn = document.getElementById('menuClose');
				const openMenu = () => { menuPanel?.classList.add('open'); backdrop?.classList.add('show'); };
				const closeMenu = () => { menuPanel?.classList.remove('open'); backdrop?.classList.remove('show'); };
				openBtn?.addEventListener('click', openMenu);
				closeBtn?.addEventListener('click', closeMenu);
				backdrop?.addEventListener('click', closeMenu);

				if (!window.VehicleStore) {
					setTimeout(initWhenReady, 100);
					return;
				}
				console.log(' VehicleStore ready, initializing fleet display');
			initializeFleetDisplay();

			// Re-initialize when user returns to page (fixes stale data)
			document.addEventListener('visibilitychange', () => {
				if (document.visibilityState === 'visible') {
					console.log(' Page became visible - refreshing fleet display');
					initializeFleetDisplay();
				}
			});
		};

		if (document.readyState === 'loading') {
			document.addEventListener('DOMContentLoaded', initWhenReady);
		} else {
			initWhenReady();
		}

		const toastEl = document.getElementById('toast');
		const categoryChips = document.querySelectorAll('.category-chip');
		let vehicleCards = document.querySelectorAll('[data-vehicle]');
		const frequencySelect = document.getElementById('frequency');
		const countrySelect = document.getElementById('country');
        const countryList = document.getElementById('countryList');
		const stateSelect = document.getElementById('state');
        const stateList = document.getElementById('stateList');
		const cityInput = document.getElementById('city');
		// Homepage uses only the basic location + frequency filters
		const activeChips = null;
		const locationBtn = document.getElementById('locationBtn');
		const filterEmptyMsg = document.getElementById('filterEmptyMsg');
		const stateCache = new Map();

		// Populate full country list (195+) into the datalist
		if (countryList && window.populateCountryElement) {
			populateCountryElement(countryList);
		}

		const showToast = (message) => {
			if (!toastEl) return;
			toastEl.textContent = message;
			toastEl.classList.add('show');
			setTimeout(() => toastEl.classList.remove('show'), 2800);
		};

		const setStates = (states = [], preselect) => {
            if (!stateList || !stateSelect) return;
            stateList.innerHTML = '';
            const anyOpt = document.createElement('option');
            anyOpt.value = 'Any';
            anyOpt.textContent = 'Any';
            stateList.appendChild(anyOpt);
            states.forEach((stateName) => {
                const opt = document.createElement('option');
                opt.value = stateName;
                opt.textContent = stateName;
                stateList.appendChild(opt);
            });
            if (preselect && states.includes(preselect)) {
                stateSelect.value = preselect;
            } else {
                stateSelect.value = 'Any';
            }
        }; 

		const fetchStates = async (country, desiredState) => {
			if (!country || country === 'Any') {
				setStates([]);
				return;
			}
			if (stateCache.has(country)) {
				setStates(stateCache.get(country), desiredState);
				return;
			}
			try {
				const response = await fetch('https://countriesnow.space/api/v0.1/countries/states', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ country })
				});
				if (!response.ok) throw new Error('Request failed');
				const data = await response.json();
				const list = data?.data?.states?.map((s) => s?.name).filter(Boolean) || [];
				stateCache.set(country, list);
				setStates(list, desiredState);
			} catch (err) {
				console.error('Failed to load states', err);
				setStates([]);
			}
		};

		const highlightFields = () => {
			[countrySelect, stateSelect, cityInput].forEach((el) => {
				if (!el) return;
				el.classList.add('flash');
				setTimeout(() => el.classList.remove('flash'), 900);
			});
		};

		const ensureCountryOption = (countryName) => {
			if (!countryList) return;
			const exists = Array.from(countryList.options).some((opt) => opt.value === countryName);
			if (!exists) {
				const opt = document.createElement('option');
				opt.value = countryName;
				opt.textContent = countryName;
				countryList.appendChild(opt);
			}
		};

		const applyLocation = async ({ country, state, city }) => {
			if (!countrySelect) return;
			if (country) {
				ensureCountryOption(country);
				countrySelect.value = country;
			}
			await fetchStates(country, state);
			const stateExists = state && stateList && Array.from(stateList.options).some((o) => o.value === state);
            if (stateExists) { stateSelect.value = state; }
			if (city && cityInput) {
				cityInput.value = city;
			}
			highlightFields();
		};

		const reverseGeocode = async (coords) => {
			const { latitude, longitude } = coords;
			const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(latitude)}&lon=${encodeURIComponent(longitude)}`;
			const resp = await fetch(url, { headers: { 'Accept': 'application/json' } });
			if (!resp.ok) throw new Error('Reverse geocode failed');
			const data = await resp.json();
			const addr = data?.address || {};
			const country = addr.country;
			const state = addr.state || addr.region || addr.province;
			const city = addr.city || addr.town || addr.village || addr.hamlet;
			return { country, state, city };
		};

		const setLocationLoading = (loading) => {
			if (!locationBtn) return;
			locationBtn.classList.toggle('is-loading', loading);
			locationBtn.disabled = loading;
		};

		const populateMakeOptions = () => {};

		const handleLocationError = () => {
			showToast("We couldn't access your location. Please select your country, state and city manually.");
		};

		const requestLocation = () => {
			if (!navigator.geolocation) {
				handleLocationError();
				return;
			}
			setLocationLoading(true);
			navigator.geolocation.getCurrentPosition(async (pos) => {
				try {
					const location = await reverseGeocode(pos.coords);
					if (!location?.country) throw new Error('Missing country');
					await applyLocation(location);
					showToast('Location detected and applied.');
				} catch (err) {
					console.error(err);
					handleLocationError();
				} finally {
					setLocationLoading(false);
				}
			}, () => {
				handleLocationError();
				setLocationLoading(false);
			}, { timeout: 8000 });
		};

		locationBtn?.addEventListener('click', requestLocation);

		const renderActiveChips = (chips) => {
			if (!activeChips) return;
			activeChips.innerHTML = '';
			chips.forEach(({ label, clear }) => {
				const chip = document.createElement('span');
				chip.className = 'active-chip';
				chip.innerHTML = `${label} &times;`;
				chip.onclick = clear;
				activeChips.appendChild(chip);
			});
		};

		const applyFilters = async () => {
			const shelves = document.getElementById('locationShelves');
			if (!homeVehiclesAll || homeVehiclesAll.length === 0) {
				if (shelves) {
					shelves.innerHTML = `
					<div class="empty-block">
						<div class="empty-icon" aria-hidden="true">
							<svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 7h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M5 7l1 13h12l1-13" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/><path d="M9 7V5a3 3 0 0 1 6 0v2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
						</div>
						<div class="empty-title">No vehicles found</div>
						<p class="muted">Vehicles will appear here once hosts publish listings.</p>
						<div class="empty-actions">
							<a class="button" href="vehicles.html">Browse all vehicles</a>
							<a class="button ghost" href="host-signup.html" data-hide-when-host>Become a host</a>
						</div>
					</div>
				`;
				}
				if (filterEmptyMsg) filterEmptyMsg.style.display = 'none';
				return;
			}

			const activeCategory = document.querySelector('.category-chip.active')?.dataset.category || 'All';
			const countryValue = (countrySelect?.value || 'Any').trim();
			const stateValue = (stateSelect?.value || 'Any').trim();
			const cityValue = (cityInput?.value || '').trim();
			const frequencyValue = (frequencySelect?.value || 'Any').trim();

			const country = countryValue === 'Any' ? '' : countryValue;
			const state = stateValue === 'Any' ? '' : stateValue;
			const city = cityValue;
			const frequency = frequencyValue === 'Any' ? '' : frequencyValue;

			const countryNorm = normalizeLocation(country);
			const stateNorm = normalizeLocation(state);
			const cityNorm = normalizeLocation(city);
			const freqNorm = normalizeLocation(frequency);

			const filtered = (homeVehiclesAll || []).filter((vehicle) => {
				if (!vehicle) return false;
				if (vehicle.status && String(vehicle.status).toLowerCase() === 'hidden') return false;

				const type = normalizeLocation(vehicle.category || vehicle.vehicleType || '');
				const vCountry = normalizeLocation(vehicle.country);
				const vState = normalizeLocation(vehicle.state);
				const vCity = normalizeLocation(vehicle.city);
				const vFreq = normalizeLocation(vehicle.frequency || vehicle.priceFrequency);

				if (countryNorm && !vCountry) return false;
				if (stateNorm && !vState) return false;
				if (cityNorm && !vCity) return false;

				const categoryOk = activeCategory === 'All' || type === normalizeLocation(activeCategory);
				const countryOk = !countryNorm || vCountry === countryNorm;
				const stateOk = !stateNorm || (vState === stateNorm && (!countryNorm || vCountry === countryNorm));
				const cityOk = !cityNorm || (vCity === cityNorm && (!countryNorm || vCountry === countryNorm));
				const freqOk = !freqNorm || vFreq === freqNorm;

				return categoryOk && countryOk && stateOk && cityOk && freqOk;
			});

			renderLocationShelves(filtered);

			if (filterEmptyMsg) {
				filterEmptyMsg.style.display = 'none';
			}

			if (filtered.length === 0 && shelves) {
				shelves.innerHTML = `
					<div class="empty-block">
						<div class="empty-icon" aria-hidden="true">
							<svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 21H3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M7 14l3-3 4 4 3-3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M7 10h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round"/></svg>
						</div>
						<div class="empty-title">No vehicles found</div>
						<p class="muted">Try removing a filter, choosing a nearby city, or switching price frequency.</p>
						<div class="empty-actions">
							<button class="button ghost" type="button" id="emptyClearFilters">Clear filters</button>
							<a class="button" href="vehicles.html">Browse all vehicles</a>
						</div>
					</div>
				`;
				setTimeout(() => {
					document.getElementById('emptyClearFilters')?.addEventListener('click', clearFilters);
				}, 0);
			}
		};

		const setActiveCategory = (chip) => {
			categoryChips.forEach((c) => c.classList.remove('active'));
			chip.classList.add('active');
			applyFilters();
		};

		categoryChips.forEach((chip) => {
			chip.addEventListener('click', () => setActiveCategory(chip));
		});

		[stateSelect, cityInput, frequencySelect].forEach((el) => {
			el?.addEventListener('change', () => { applyFilters(); });
			if (el === cityInput) {
				el?.addEventListener('input', () => { applyFilters(); });
			}
		});

		const clearFilters = () => {
			if (countrySelect) countrySelect.value = 'Any';
			if (stateSelect) stateSelect.value = 'Any';
			if (cityInput) cityInput.value = '';
			if (frequencySelect) frequencySelect.value = 'Any';
			if (stateList) stateList.innerHTML = '<option value="Any">Any</option>';
			const allChip = document.querySelector('.category-chip[data-category="All"]');
			if (allChip) setActiveCategory(allChip);
			applyFilters();
		};

		// Double-click the category bar to reset filters quickly
		document.querySelector('.category-filter-bar')?.addEventListener('dblclick', clearFilters);

		const activateDefaultCategory = () => {
			const allChip = document.querySelector('.category-chip[data-category="All"]');
			if (allChip) {
				allChip.classList.add('active');
			}
		};

		// Only activate and apply filters if VehicleStore is ready
		if (window.VehicleStore) {
			activateDefaultCategory();
			applyFilters();

			countrySelect?.addEventListener('change', (e) => {
				if (cityInput) {
					cityInput.value = '';
				}
				fetchStates(e.target.value);
				applyFilters();
			});
			if (countrySelect) fetchStates(countrySelect.value);
		} else {
			// Defer until VehicleStore loads
			const deferredInit = setInterval(() => {
				if (window.VehicleStore) {
					clearInterval(deferredInit);
					activateDefaultCategory();
					applyFilters();
					countrySelect?.addEventListener('change', (e) => {
						if (cityInput) {
							cityInput.value = '';
						}
						fetchStates(e.target.value);
						applyFilters();
					});
					if (countrySelect) fetchStates(countrySelect.value);
				}
			}, 100);
		}

		// ========== DEMO AUTH CONTROLS REMOVED FOR PRODUCTION ==========
		// All demo/test authentication shortcuts have been removed.
		// Users must go through proper sign-in/sign-up flow.
		// ========== END DEMO AUTH CONTROLS ==========

		// Safety popup is now shown on-demand (e.g., when contacting a host).
	</script>

<!-- Firebase SDKs and initializer (must load before firebase.js logic) -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-analytics-compat.js"></script>
<script src="assets/firebase.js?v=3"></script>
<script src="assets/auth.js?v=3"></script>
<script src="assets/navBuilder.js?v=3"></script>
<script src="assets/vehicleStore.js?v=3"></script>

</body>
</html>




