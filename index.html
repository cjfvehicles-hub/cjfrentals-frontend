
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>CCR | Global Vehicle Rentals</title>
	<link rel="preconnect" href="https://fonts.googleapis.com" />
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
	<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&display=swap" rel="stylesheet" />
	<link rel="stylesheet" href="assets/style.css" />
	<script src="assets/countryStateData.js"></script>
</head>
<body>
	<header class="header">
		<div class="header-inner">
			<a class="brand" href="index.html">
				<span class="brand-mark">CJF</span>
				<span>CJF Rentals</span>
			</a>
			<button class="menu-button" id="menuToggle" aria-label="Open menu">Menu</button>
		</div>
	</header>
	<div class="backdrop" id="backdrop"></div>
	<nav class="menu-panel" id="menuPanel" role="dialog" aria-label="Navigation">
		<div class="menu-header">
			<span class="menu-title">Navigation</span>
			<button class="menu-close" aria-label="Close menu">Close</button>
		</div>
		<ul class="menu-list" id="nav-list">
			<!-- Menu items built dynamically by navBuilder.js -->
		</ul>
	</nav>

	<main class="page">
		<section class="hero">
			<div class="hero-inner">
				<div class="hero-card">
					<h1 class="hero-title">Browse premium vehicles, contact hosts directly, and rent worldwide.</h1>
					<p class="hero-subtitle">Search by location, pick a price frequency, and jump straight into the feed.</p>
					<div class="filters hero-filters">
						<div>
							<label for='country'>Country</label>
              <input id='country' class='input' list='countryList' value='Any' autocomplete='country-name' />
              <datalist id='countryList'></datalist>
            </div>
					<div>
						<label for="state">State</label>
                        <input id="state" class="input" list="stateList" value="Any" autocomplete="address-level1" />
                        <datalist id="stateList"><option value="Any">Any</option></datalist>
                        </div>
					<div>
						<label for="city">City</label>
						<input id="city" class="input" type="text" placeholder="Type a city" />
					</div>
					<div>
						<label for="frequency">Price frequency</label>
						<select id="frequency">
							<option value="Any" selected>Any</option>
							<option value="Daily">Daily</option>
							<option value="Weekly">Weekly</option>
							<option value="Monthly">Monthly</option>
						</select>
                    </div>
					</div>
					<div class="hero-actions">
						<a class="button" href="vehicles.html">Browse vehicles</a>
						<a class="button ghost" href="host-signup.html">Become a host</a>
						<button class="button ghost location-btn" type="button" id="locationBtn" aria-label="Use my location">
							<svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
								<path d="M12 2a8 8 0 0 0-8 8c0 6 7.2 11.4 7.5 11.6a1 1 0 0 0 1 0C12.8 21.4 20 16 20 10a8 8 0 0 0-8-8Zm0 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6Z"></path>
							</svg>
						</button>
					</div>
				</div>
			</div>
		</section>

		<section class="category-filter-bar">
			<div class="categories">
				<span class="category-chip" data-category="All">All</span>
				<span class="category-chip" data-category="SUV">SUV</span>
				<span class="category-chip" data-category="Sedan">Sedan</span>
				<span class="category-chip" data-category="Coupe">Coupe</span>
				<span class="category-chip" data-category="Truck">Truck</span>
				<span class="category-chip" data-category="Bike">Bike</span>
				<span class="category-chip" data-category="Convertible">Convertible</span>
				<span class="category-chip" data-category="Minivan">Minivan</span>
				<span class="category-chip" data-category="Hatchback">Hatchback</span>
				<span class="category-chip" data-category="Station Wagon">Station Wagon</span>
				<span class="category-chip" data-category="Bus">Bus</span>
			</div>
		</section>

		

		<section>
			<div class="grid" style="gap:8px;">
				<div class="pill">Main fleet  shuffled</div>
				<h2>All vehicles</h2>
			</div>
			<div class="grid three" id="allVehiclesGrid">
				<article style="grid-column: 1 / -1; text-align: center; padding: 40px; border: 2px dashed #ddd; border-radius: 8px;">
					<p style="color: #999; margin: 0;">No vehicles available yet. <a href="host-signup.html" style="color: #667eea;">Become a host</a> and add the first listing!</p>
				</article>
			</div>
			<div id="filterEmptyMsg" class="empty-state" style="display:none; text-align:center; padding:32px 20px; grid-column:1 / -1;">
				<p style="font-size:16px; color:#666; margin:0;">No vehicles found for this location.</p>
				<p class="muted" style="margin-top:8px;">Try another country, state, or city.</p>
			</div>
	</main>

	<!-- Footer with Legal Links -->
	<footer style="background: #f8f9fa; border-top: 1px solid #e5e7eb; padding: 32px 20px; margin-top: 48px;">
		<div style="max-width: 1200px; margin: 0 auto; text-align: center;">
			<p style="margin: 0 0 16px 0; font-size: 14px; color: #666; line-height: 1.6;">
				<strong>CJF is an advertising platform only.</strong> All rentals, payments, and agreements occur directly between Host and Renter. CJF is not responsible for scams, disputes, damages, or vehicle issues. Use safely and responsibly.
			</p>
			<div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 16px; margin-top: 16px;">
				<a href="terms.html" style="color: var(--accent); font-size: 14px;">Terms & Conditions</a>
				<a href="privacy.html" style="color: var(--accent); font-size: 14px;">Privacy Policy</a>
				<a href="host-agreement.html" style="color: var(--accent); font-size: 14px;">Host Agreement</a>
				<a href="safety.html" style="color: var(--accent); font-size: 14px;">Safety Guidelines</a>
				<a href="contact.html" style="color: var(--accent); font-size: 14px;">Contact Support</a>
			</div>
			<p style="margin: 16px 0 0 0; font-size: 13px; color: #999;">
				 2025 CJF. All rights reserved.
			</p>
		</div>
	</footer>

	<div class="toast" id="toast" role="status" aria-live="polite"></div>

	<script>
		// Use VehicleStore as single source of truth
		const getActiveVehicles = async () => {
			return await VehicleStore.getActiveVehicles();
		};

		const normalizeLocation = (value) => (value ?? '').toString().trim().toLowerCase();

			// Render vehicle card HTML
		const createVehicleCardHtml = (vehicle) => {
			const clean = (value) => (value ?? '').toString().trim();
			// Normalize legacy/new field names to avoid runtime errors
			const category = vehicle.category || vehicle.vehicleType || 'Vehicle';
			const fuel = vehicle.fuel || vehicle.fuelType || 'Unknown';
			const transmission = vehicle.transmission || '';
			const frequency = vehicle.frequency || vehicle.priceFrequency || 'Daily';
			const country = clean(vehicle.country || '');
			const state = clean(vehicle.state || '');
			const city = clean(vehicle.city || '');
			const insurance = clean(vehicle.insurance || '').toLowerCase() === 'included' ? 'Insurance included' : 'No insurance';
			const specLine = [vehicle.year || '', category, fuel].filter(Boolean).join(' &bull; ');
			const locationLine = [city, state || country].filter(Boolean).join(' &bull; ');
			
				// Create placeholder SVG for vehicles without photos
				const placeholderSvg = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 300"><defs><linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:%23e5e7eb;stop-opacity:1" /><stop offset="100%" style="stop-color:%23d1d5db;stop-opacity:1" /></linearGradient></defs><rect fill="url(%23grad)" width="400" height="300"/><g transform="translate(200, 80)"><circle cx="0" cy="0" r="35" fill="%23999" opacity="0.3"/></g><g transform="translate(200, 160)"><rect x="-60" y="0" width="120" height="70" rx="8" fill="none" stroke="%23999" stroke-width="3" opacity="0.3"/><rect x="-50" y="10" width="30" height="20" rx="4" fill="%23999" opacity="0.3"/><rect x="20" y="10" width="30" height="20" rx="4" fill="%23999" opacity="0.3"/><rect x="-35" y="50" width="70" height="8" rx="4" fill="%23999" opacity="0.3"/></g><text x="200" y="280" text-anchor="middle" font-family="Arial" font-size="16" fill="%23999" opacity="0.5">No photo</text></svg>';
			
				// Use image from vehicle, or fall back to placeholder
				// Note: vehicleStore already adds placeholder if missing, but we provide one here as well
				const image = vehicle.image || (vehicle.photos && vehicle.photos[0]) || placeholderSvg;

				return `
					<article class="card vehicle-card" data-vehicle data-type="${clean(category)}" data-country="${country}" data-state="${state}" data-city="${city}" data-frequency="${frequency}" data-id="${vehicle.id}" data-make="${clean(vehicle.make)}" data-year="${vehicle.year || ''}" data-price="${vehicle.price || ''}" data-transmission="${clean(transmission)}" data-fuel="${clean(fuel)}" data-seats="${vehicle.seats || ''}">
						<a href="vehicle.html?id=${vehicle.id}" class="vehicle-card-link">
							<img src="${image}" alt="${vehicle.make || ''} ${vehicle.model || ''}" style="background: #f0f0f0;" />
							<div class="vehicle-meta">${specLine}</div>
							<strong>${vehicle.make || ''} ${vehicle.model || ''}</strong>
							<div class="vehicle-meta">${locationLine}</div>
							<div class="vehicle-price">$${vehicle.price || 0} / ${frequency.toLowerCase()}</div>
							<div class="vehicle-meta" style="display:flex; gap:6px; flex-wrap:wrap;">
								<span class="badge">${insurance}</span>
							</div>
						</a>
					</article>
				`;
			};

		// Initialize homepage with live fleet data
		const initializeFleetDisplay = async () => {
			console.log(' Initializing fleet display...');
			const activeVehicles = await getActiveVehicles();
			console.log(` Found ${activeVehicles.length} active vehicles to display`);
			
			// Get the "All vehicles" grid container
			const allVehiclesGrid = document.querySelector('#allVehiclesGrid') || document.querySelector('.grid.three');
			if (!allVehiclesGrid) return;

			if (activeVehicles.length > 0) {
				// Remove empty-state placeholder
				const emptyPlaceholder = allVehiclesGrid.querySelector('article:not([data-vehicle])');
				if (emptyPlaceholder) emptyPlaceholder.remove();
				
				populateMakeOptions(activeVehicles);

				// Clear existing vehicle cards
				const vehicleCards = allVehiclesGrid.querySelectorAll('[data-vehicle]');
				vehicleCards.forEach(card => card.remove());
				
				// Render all active vehicles
				activeVehicles.forEach(vehicle => {
					const normalized = {
						...vehicle,
						category: vehicle.category || vehicle.vehicleType || 'Vehicle',
						fuel: vehicle.fuel || vehicle.fuelType || 'Unknown',
						frequency: vehicle.frequency || vehicle.priceFrequency || 'Daily',
						image: vehicle.image || (vehicle.photos && vehicle.photos[0]) || null,
						price: vehicle.price != null ? vehicle.price : (vehicle.pricePerDay != null ? vehicle.pricePerDay : 0),
						year: vehicle.year || vehicle.modelYear || ''
					};
					allVehiclesGrid.innerHTML += createVehicleCardHtml(normalized);
				});
				applyFilters();
			} else {
				// No active vehicles - clear cards and ensure placeholder
				const vehicleCards = allVehiclesGrid.querySelectorAll('[data-vehicle]');
				vehicleCards.forEach(card => card.remove());
				const existingPlaceholder = allVehiclesGrid.querySelector('article:not([data-vehicle])');
				if (!existingPlaceholder) {
					const placeholder = document.createElement('article');
					placeholder.style.cssText = 'grid-column: 1 / -1; text-align: center; padding: 40px; border: 2px dashed #ddd; border-radius: 8px;';
					placeholder.innerHTML = '<p style="color: #999; margin: 0;">No vehicles available yet. <a href="host-signup.html" style="color: #667eea;">Become a host</a> and add the first listing!</p>';
					allVehiclesGrid.appendChild(placeholder);
				}
			}
		};

		// Update vehicle cards dynamically if new vehicles were added or existing ones changed
		const updateFleetDisplay = async () => {
			const activeVehicles = await getActiveVehicles();
			if (activeVehicles.length > 0) {
				const allVehiclesGrid = document.querySelector('#allVehiclesGrid') || document.querySelector('.grid.three');
				if (!allVehiclesGrid) return;
				
				// Get existing vehicle IDs in the DOM
				const existingCards = Array.from(allVehiclesGrid.querySelectorAll('[data-vehicle][data-id]'));
				const existingIds = new Set(existingCards.map(el => String(el.dataset.id)));
				
				// Check for UPDATED existing vehicles (data changed but same ID)
				const vehiclesById = new Map(activeVehicles.map(v => [String(v.id), v]));
				let hasUpdates = false;
				
				existingCards.forEach(card => {
					const vehicleId = String(card.dataset.id);
					const vehicle = vehiclesById.get(vehicleId);
					
					if (vehicle) {
						// Check if any critical data has changed
						const cardCountry = card.dataset.country || '';
						const cardState = card.dataset.state || '';
						const cardCity = card.dataset.city || '';
						const cardType = card.dataset.type || '';
						const cardFreq = card.dataset.frequency || '';
						
						const countryChanged = cardCountry.toLowerCase() !== (vehicle.country || '').toLowerCase();
						const stateChanged = cardState.toLowerCase() !== (vehicle.state || '').toLowerCase();
						const cityChanged = cardCity.toLowerCase() !== (vehicle.city || '').toLowerCase();
						const typeChanged = cardType.toLowerCase() !== (vehicle.category || '').toLowerCase();
						const freqChanged = cardFreq.toLowerCase() !== (vehicle.frequency || '').toLowerCase();
						
						if (countryChanged || stateChanged || cityChanged || typeChanged || freqChanged) {
							console.log(` Vehicle ${vehicleId} data changed - updating card`);
							// Update data attributes
							card.dataset.country = vehicle.country || '';
							card.dataset.state = vehicle.state || '';
							card.dataset.city = vehicle.city || '';
							card.dataset.type = vehicle.category || '';
							card.dataset.frequency = vehicle.frequency || '';
							hasUpdates = true;
						}
					}
				});
				
				if (hasUpdates) {
					console.log(' Reapplying filters after vehicle updates');
					applyFilters();
				}
				
				// Add new vehicles that aren't already in the DOM
				const newVehicles = activeVehicles.filter(v => !existingIds.has(String(v.id)));
				
				if (newVehicles.length > 0) {
					console.log(` Adding ${newVehicles.length} new vehicles to fleet`);
					newVehicles.forEach(vehicle => {
						const cardHtml = createVehicleCardHtml(vehicle);
						allVehiclesGrid.innerHTML += cardHtml;
					});
					
					populateMakeOptions(activeVehicles);

					// Re-apply filters to new vehicles
					applyFilters();
				}
			}
			};

			// Wait for external scripts and DOMContentLoaded before initializing
			const initWhenReady = () => {
				// Menu wiring lives here to avoid hoist issues
				const menuPanel = document.getElementById('menuPanel');
				const backdrop = document.getElementById('backdrop');
				const openBtn = document.getElementById('menuToggle');
				const closeBtn = document.getElementById('menuClose');
				const openMenu = () => { menuPanel?.classList.add('open'); backdrop?.classList.add('show'); };
				const closeMenu = () => { menuPanel?.classList.remove('open'); backdrop?.classList.remove('show'); };
				openBtn?.addEventListener('click', openMenu);
				closeBtn?.addEventListener('click', closeMenu);
				backdrop?.addEventListener('click', closeMenu);

				if (!window.VehicleStore) {
					setTimeout(initWhenReady, 100);
					return;
				}
				console.log(' VehicleStore ready, initializing fleet display');
			initializeFleetDisplay();

			// Re-initialize when user returns to page (fixes stale data)
			document.addEventListener('visibilitychange', () => {
				if (document.visibilityState === 'visible') {
					console.log(' Page became visible - refreshing fleet display');
					initializeFleetDisplay();
				}
			});
		};

		if (document.readyState === 'loading') {
			document.addEventListener('DOMContentLoaded', initWhenReady);
		} else {
			initWhenReady();
		}

		const toastEl = document.getElementById('toast');
		const categoryChips = document.querySelectorAll('.category-chip');
		let vehicleCards = document.querySelectorAll('[data-vehicle]');
		const frequencySelect = document.getElementById('frequency');
		const countrySelect = document.getElementById('country');
        const countryList = document.getElementById('countryList');
		const stateSelect = document.getElementById('state');
        const stateList = document.getElementById('stateList');
		const cityInput = document.getElementById('city');
		// Homepage uses only the basic location + frequency filters
		const activeChips = null;
		const locationBtn = document.getElementById('locationBtn');
		const filterEmptyMsg = document.getElementById('filterEmptyMsg');
		const stateCache = new Map();

		// Populate full country list (195+) into the datalist
		if (countryList && window.populateCountryElement) {
			populateCountryElement(countryList);
		}

		const showToast = (message) => {
			if (!toastEl) return;
			toastEl.textContent = message;
			toastEl.classList.add('show');
			setTimeout(() => toastEl.classList.remove('show'), 2800);
		};

		const setStates = (states = [], preselect) => {
            if (!stateList || !stateSelect) return;
            stateList.innerHTML = '';
            const anyOpt = document.createElement('option');
            anyOpt.value = 'Any';
            anyOpt.textContent = 'Any';
            stateList.appendChild(anyOpt);
            states.forEach((stateName) => {
                const opt = document.createElement('option');
                opt.value = stateName;
                opt.textContent = stateName;
                stateList.appendChild(opt);
            });
            if (preselect && states.includes(preselect)) {
                stateSelect.value = preselect;
            } else {
                stateSelect.value = 'Any';
            }
        }; 

		const fetchStates = async (country, desiredState) => {
			if (!country || country === 'Any') {
				setStates([]);
				return;
			}
			if (stateCache.has(country)) {
				setStates(stateCache.get(country), desiredState);
				return;
			}
			try {
				const response = await fetch('https://countriesnow.space/api/v0.1/countries/states', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ country })
				});
				if (!response.ok) throw new Error('Request failed');
				const data = await response.json();
				const list = data?.data?.states?.map((s) => s?.name).filter(Boolean) || [];
				stateCache.set(country, list);
				setStates(list, desiredState);
			} catch (err) {
				console.error('Failed to load states', err);
				setStates([]);
			}
		};

		const highlightFields = () => {
			[countrySelect, stateSelect, cityInput].forEach((el) => {
				if (!el) return;
				el.classList.add('flash');
				setTimeout(() => el.classList.remove('flash'), 900);
			});
		};

		const ensureCountryOption = (countryName) => {
			if (!countryList) return;
			const exists = Array.from(countryList.options).some((opt) => opt.value === countryName);
			if (!exists) {
				const opt = document.createElement('option');
				opt.value = countryName;
				opt.textContent = countryName;
				countryList.appendChild(opt);
			}
		};

		const applyLocation = async ({ country, state, city }) => {
			if (!countrySelect) return;
			if (country) {
				ensureCountryOption(country);
				countrySelect.value = country;
			}
			await fetchStates(country, state);
			const stateExists = state && stateList && Array.from(stateList.options).some((o) => o.value === state);
            if (stateExists) { stateSelect.value = state; }
			if (city && cityInput) {
				cityInput.value = city;
			}
			highlightFields();
		};

		const reverseGeocode = async (coords) => {
			const { latitude, longitude } = coords;
			const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(latitude)}&lon=${encodeURIComponent(longitude)}`;
			const resp = await fetch(url, { headers: { 'Accept': 'application/json' } });
			if (!resp.ok) throw new Error('Reverse geocode failed');
			const data = await resp.json();
			const addr = data?.address || {};
			const country = addr.country;
			const state = addr.state || addr.region || addr.province;
			const city = addr.city || addr.town || addr.village || addr.hamlet;
			return { country, state, city };
		};

		const setLocationLoading = (loading) => {
			if (!locationBtn) return;
			locationBtn.classList.toggle('is-loading', loading);
			locationBtn.disabled = loading;
		};

		const populateMakeOptions = () => {};

		const handleLocationError = () => {
			showToast("We couldn't access your location. Please select your country, state and city manually.");
		};

		const requestLocation = () => {
			if (!navigator.geolocation) {
				handleLocationError();
				return;
			}
			setLocationLoading(true);
			navigator.geolocation.getCurrentPosition(async (pos) => {
				try {
					const location = await reverseGeocode(pos.coords);
					if (!location?.country) throw new Error('Missing country');
					await applyLocation(location);
					showToast('Location detected and applied.');
				} catch (err) {
					console.error(err);
					handleLocationError();
				} finally {
					setLocationLoading(false);
				}
			}, () => {
				handleLocationError();
				setLocationLoading(false);
			}, { timeout: 8000 });
		};

		locationBtn?.addEventListener('click', requestLocation);

		const renderActiveChips = (chips) => {
			if (!activeChips) return;
			activeChips.innerHTML = '';
			chips.forEach(({ label, clear }) => {
				const chip = document.createElement('span');
				chip.className = 'active-chip';
				chip.innerHTML = `${label} &times;`;
				chip.onclick = clear;
				activeChips.appendChild(chip);
			});
		};

		const applyFilters = async () => {
			vehicleCards = document.querySelectorAll('[data-vehicle]');
			const activeCategory = document.querySelector('.category-chip.active')?.dataset.category || 'All';
			const countryValue = (countrySelect?.value || 'Any').trim();
			const stateValue = (stateSelect?.value || 'Any').trim();
			const cityValue = (cityInput?.value || '').trim();
			const frequencyValue = (frequencySelect?.value || 'Any').trim();

			const country = countryValue === 'Any' ? '' : countryValue;
			const state = stateValue === 'Any' ? '' : stateValue;
			const city = cityValue;
			const frequency = frequencyValue === 'Any' ? '' : frequencyValue;

			const countryNorm = normalizeLocation(country);
			const stateNorm = normalizeLocation(state);
			const cityNorm = normalizeLocation(city);
			const freqNorm = normalizeLocation(frequency);
			
			// Load current vehicles from VehicleStore (Firebase/cache)
			const allVehicles = await VehicleStore.getAllVehicles();
			const vehiclesById = new Map(allVehicles.map(v => [String(v.id), v]));
			let visibleCount = 0;
			const chips = [];

			if (countryNorm) chips.push({ label: country, clear: () => { countrySelect.value = 'Any'; applyFilters(); }});
			if (stateNorm) chips.push({ label: state, clear: () => { stateSelect.value = 'Any'; applyFilters(); }});
			if (cityNorm) chips.push({ label: city, clear: () => { cityInput.value = ''; applyFilters(); }});
			if (frequency) chips.push({ label: frequency, clear: () => { frequencySelect.value = 'Any'; applyFilters(); }});
			if (activeCategory && activeCategory !== 'All') chips.push({ label: activeCategory, clear: () => { setActiveCategory(document.querySelector('.category-chip[data-category="All"]')); }});
			renderActiveChips(chips);

			vehicleCards.forEach((card) => {
				const id = card.dataset.id;
				const vehicle = vehiclesById.get(id);
				
				// Hide if vehicle is marked as hidden
				if (vehicle && vehicle.status === 'hidden') {
					card.style.display = 'none';
					return;
				}
				
				const type = normalizeLocation(vehicle?.category || vehicle?.vehicleType || card.dataset.type);
				const vCountry = normalizeLocation(vehicle?.country ?? card.dataset.country);
				const vState = normalizeLocation(vehicle?.state ?? card.dataset.state);
				const vCity = normalizeLocation(vehicle?.city ?? card.dataset.city);
				const vFreq = normalizeLocation(vehicle?.frequency || vehicle?.priceFrequency || card.dataset.frequency);

				// Enforce required data when a corresponding filter is set
				if (countryNorm && !vCountry) { card.style.display = 'none'; return; }
				if (stateNorm && !vState) { card.style.display = 'none'; return; }
				if (cityNorm && !vCity) { card.style.display = 'none'; return; }

				const categoryOk = activeCategory === 'All' || type === normalizeLocation(activeCategory);
				const countryOk = !countryNorm || vCountry === countryNorm;
				const stateOk = !stateNorm || (vState === stateNorm && (!countryNorm || vCountry === countryNorm));
				const cityOk = !cityNorm || (vCity === cityNorm && (!countryNorm || vCountry === countryNorm));
				const freqOk = !freqNorm || vFreq === freqNorm;

				const showCard = categoryOk && countryOk && stateOk && cityOk && freqOk;
				card.style.display = showCard ? '' : 'none';
				if (showCard) visibleCount += 1;
			});

			if (filterEmptyMsg) {
				const hasCards = vehicleCards.length > 0;
				filterEmptyMsg.style.display = hasCards && visibleCount === 0 ? 'block' : 'none';
			}
			const countEl = document.getElementById('vehicleCount');
			if (countEl) {
				countEl.textContent = `${visibleCount} vehicle${visibleCount === 1 ? '' : 's'} available`;
			}
		};

		const setActiveCategory = (chip) => {
			categoryChips.forEach((c) => c.classList.remove('active'));
			chip.classList.add('active');
			applyFilters();
		};

		categoryChips.forEach((chip) => {
			chip.addEventListener('click', () => setActiveCategory(chip));
		});

		[stateSelect, cityInput, frequencySelect].forEach((el) => {
			el?.addEventListener('change', () => { applyFilters(); });
			if (el === cityInput) {
				el?.addEventListener('input', () => { applyFilters(); });
			}
		});

		const clearFilters = () => {
			if (countrySelect) countrySelect.value = 'Any';
			if (stateSelect) stateSelect.value = 'Any';
			if (cityInput) cityInput.value = '';
			if (frequencySelect) frequencySelect.value = 'Any';
			if (stateList) stateList.innerHTML = '<option value="Any">Any</option>';
			const allChip = document.querySelector('.category-chip[data-category="All"]');
			if (allChip) setActiveCategory(allChip);
			applyFilters();
		};

		// Double-click the category bar to reset filters quickly
		document.querySelector('.category-filter-bar')?.addEventListener('dblclick', clearFilters);

		const activateDefaultCategory = () => {
			const allChip = document.querySelector('.category-chip[data-category="All"]');
			if (allChip) {
				allChip.classList.add('active');
			}
		};

		// Only activate and apply filters if VehicleStore is ready
		if (window.VehicleStore) {
			activateDefaultCategory();
			applyFilters();

			countrySelect?.addEventListener('change', (e) => {
				if (cityInput) {
					cityInput.value = '';
				}
				fetchStates(e.target.value);
				applyFilters();
			});
			if (countrySelect) fetchStates(countrySelect.value);
		} else {
			// Defer until VehicleStore loads
			const deferredInit = setInterval(() => {
				if (window.VehicleStore) {
					clearInterval(deferredInit);
					activateDefaultCategory();
					applyFilters();
					countrySelect?.addEventListener('change', (e) => {
						if (cityInput) {
							cityInput.value = '';
						}
						fetchStates(e.target.value);
						applyFilters();
					});
					if (countrySelect) fetchStates(countrySelect.value);
				}
			}, 100);
		}

		// ========== DEMO AUTH CONTROLS REMOVED FOR PRODUCTION ==========
		// All demo/test authentication shortcuts have been removed.
		// Users must go through proper sign-in/sign-up flow.
		// ========== END DEMO AUTH CONTROLS ==========

		// ========== SAFETY POPUP ==========
		// Show safety warning popup on first visit
		const SAFETY_POPUP_KEY = 'CJF_SAFETY_POPUP_SHOWN';
		
		function showSafetyPopup() {
			// Check if user has already seen the popup
			const hasSeenPopup = localStorage.getItem(SAFETY_POPUP_KEY);
			if (hasSeenPopup) return;
			
			// Create popup
			const popup = document.createElement('div');
			popup.id = 'safetyPopup';
			popup.style.cssText = `
				position: fixed;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background: rgba(0, 0, 0, 0.85);
				z-index: 99999;
				display: flex;
				align-items: center;
				justify-content: center;
				padding: 20px;
			`;
			
			popup.innerHTML = `
				<div style="
					background: white;
					border-radius: 12px;
					max-width: 600px;
					width: 100%;
					padding: 32px;
					box-shadow: 0 20px 50px rgba(0,0,0,0.3);
					max-height: 90vh;
					overflow-y: auto;
				">
					<div style="text-align: center; margin-bottom: 24px;">
						<div style="font-size: 48px; margin-bottom: 12px;"></div>
						<h2 style="font-size: 24px; margin: 0 0 8px 0; color: #dc3545;">SAFETY WARNING  PLEASE READ</h2>
						<p style="color: #666; margin: 0;">Protect yourself from scams</p>
					</div>
					
					<div style="background: #ffe6e6; border-left: 4px solid #dc3545; padding: 16px; border-radius: 4px; margin-bottom: 20px;">
						<p style="margin: 0; font-weight: 600; font-size: 15px; color: #dc3545;">
							To protect yourself from scams:
						</p>
					</div>
					
					<ul style="margin: 0 0 20px 0; padding-left: 24px; line-height: 2;">
						<li><strong>Only pay after seeing the vehicle IN PERSON</strong></li>
						<li>Inspect the vehicle before giving any money</li>
						<li>Meet Hosts in public places</li>
						<li>Do not trust online-only transactions</li>
					</ul>
					
					<div style="background: #f8f9fa; border: 2px solid #6c757d; padding: 16px; border-radius: 8px; margin-bottom: 24px;">
						<p style="margin: 0; font-size: 14px; line-height: 1.6; color: #333;">
							<strong>CJF is not responsible for:</strong><br/>
							Scams  Fraud  Damages  False listings  Vehicle problems  Financial loss
						</p>
						<p style="margin: 12px 0 0 0; font-size: 13px; color: #666;">
							CJF is an advertising platform only. All transactions are between you and the Host.
						</p>
					</div>
					
					<div style="text-align: center;">
						<button id="safetyPopupAgree" style="
							background: #0066cc;
							color: white;
							border: none;
							padding: 14px 32px;
							border-radius: 8px;
							font-size: 16px;
							font-weight: 600;
							cursor: pointer;
							width: 100%;
							transition: all 0.2s ease;
						">I AGREE & CONTINUE</button>
						<p style="margin: 12px 0 0 0; font-size: 13px; color: #666;">
							<a href="safety.html" target="_blank" style="color: var(--accent);">Read full Safety Guidelines </a>
						</p>
					</div>
				</div>
			`;
			
			document.body.appendChild(popup);
			
			// Prevent body scroll
			document.body.style.overflow = 'hidden';
			
			// Close popup and save preference
			document.getElementById('safetyPopupAgree').addEventListener('click', () => {
				localStorage.setItem(SAFETY_POPUP_KEY, 'true');
				popup.remove();
				document.body.style.overflow = '';
			});
			
			// Hover effect for button
			const btn = document.getElementById('safetyPopupAgree');
			btn.addEventListener('mouseenter', () => {
				btn.style.background = '#0052a3';
				btn.style.transform = 'scale(1.02)';
			});
			btn.addEventListener('mouseleave', () => {
				btn.style.background = '#0066cc';
				btn.style.transform = 'scale(1)';
			});
		}
		
		// Show popup after short delay for better UX
		setTimeout(showSafetyPopup, 800);
		// ========== END SAFETY POPUP ==========
	</script>

<!-- Firebase SDKs and initializer (must load before firebase.js logic) -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-analytics-compat.js"></script>
<script src="assets/firebase.js?v=3"></script>
<script src="assets/auth.js?v=3"></script>
<script src="assets/navBuilder.js?v=3"></script>
<script src="assets/vehicleStore.js?v=3"></script>

</body>
</html>
