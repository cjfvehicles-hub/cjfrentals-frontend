<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vehicles | CJF</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="assets/style.css" />
  <style>
    .results-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
    }
    .filters-trigger {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: #0c1b3a;
      color: #fff;
      padding: 10px 14px;
      border-radius: 12px;
      border: none;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    }
    .filters-trigger .badge {
      background: #fff;
      color: #0c1b3a;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 12px;
      font-weight: 700;
      border: 1px solid rgba(12,27,58,0.15);
    }
    .active-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }
    .active-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: #f6f8fb;
      font-weight: 600;
      cursor: pointer;
    }
    .active-chip small {
      font-weight: 700;
      color: #111;
    }
    .filters-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      z-index: 9000;
    }
    .filters-overlay.show {
      opacity: 1;
      pointer-events: auto;
    }
    .filters-drawer {
      position: fixed;
      top: 0;
      right: 0;
      width: 360px;
      max-width: 92vw;
      height: 100vh;
      background: #fff;
      box-shadow: -10px 0 40px rgba(0,0,0,0.18);
      border-top-left-radius: 18px;
      border-bottom-left-radius: 18px;
      transform: translateX(105%);
      transition: transform 0.25s ease;
      z-index: 9010;
      display: flex;
      flex-direction: column;
    }
    .filters-drawer.open { transform: translateX(0); }
    .filters-drawer__header {
      padding: 14px 16px;
      border-bottom: 1px solid var(--stroke);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      position: sticky;
      top: 0;
      background: #fff;
      z-index: 1;
    }
    .filters-drawer__body {
      padding: 14px;
      overflow-y: auto;
      display: grid;
      gap: 12px;
    }
    .filters-drawer__footer {
      padding: 12px 16px 16px;
      border-top: 1px solid var(--stroke);
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      position: sticky;
      bottom: 0;
      background: #fff;
    }
    .filter-group {
      border: 1px solid var(--stroke);
      border-radius: 14px;
      padding: 12px;
      display: grid;
      gap: 10px;
      background: #f8fafc;
    }
    .filter-group h3 {
      margin: 0;
      font-size: 15px;
    }
    .filter-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
    }
    .filters-close {
      background: none;
      border: 1px solid var(--stroke);
      border-radius: 10px;
      padding: 6px 10px;
      cursor: pointer;
      font-weight: 700;
    }
    @media (max-width: 768px) {
      .filters-drawer {
        left: 0;
        right: 0;
        width: 100%;
        max-width: none;
        height: 82vh;
        top: auto;
        bottom: 0;
        border-radius: 18px 18px 0 0;
        transform: translateY(110%);
      }
      .filters-drawer.open { transform: translateY(0); }
    }
  </style>
  <script src="assets/countryStateData.js"></script>
  <script src="assets/safetyPopup.js"></script>
</head>
<body>
  <header class="header">
    <div class="header-inner">
      <a class="brand" href="index.html">
        <span class="brand-mark">CJF</span><span>CJF Rentals</span>
      </a>
      <button class="menu-button" id="menuToggle" aria-label="Open menu">☰</button>
    </div>
  </header>
  <div class="backdrop" id="backdrop"></div>
  <nav class="menu-panel" id="menuPanel" role="dialog" aria-label="Navigation">
    <div class="menu-header">
      <span class="menu-title">Navigation</span>
      <button class="menu-close" id="menuClose" aria-label="Close menu"></button>
    </div>
    <ul class="menu-list" id="nav-list">
      <!-- Menu items built dynamically by navBuilder.js -->
    </ul>
  </nav>

  <main class="page">
    <!-- Hero removed per request -->

    <section>
      <div class="grid" style="gap:6px;">
        <div class="pill">Results</div>
        <h2>All Vehicles</h2>
        <p class="muted" id="vehicleCount">Loading vehicles...</p>
      </div>
      <div class="results-header">
        <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
          <button class="filters-trigger" id="filtersToggle" type="button" aria-expanded="false">
            <span>Filters</span>
            <span class="badge" id="filterCountBadge">0</span>
          </button>
          <div class="active-chips" id="activeChips"></div>
        </div>
        <button class="button ghost" id="clearFiltersQuick" type="button">Clear all</button>
      </div>

      <div class="vehicles-grid" id="vehiclesGrid">
        <!-- Vehicles will be loaded from shared storage -->
      </div>
      <div id="noVehiclesMsg" class="empty-state" style="display:none; text-align:center; padding:60px 20px;">
        <p style="font-size:18px; color:#999;">No vehicles available at the moment.</p>
        <p class="muted">Check back later or try adjusting your search filters.</p>
      </div>
      <div id="filterVehiclesMsg" class="empty-state" style="display:none; text-align:center; padding:32px 20px;">
        <p style="font-size:16px; color:#666; margin:0;">No vehicles found for this location.</p>
        <p class="muted" style="margin-top:8px;">Try another country, state, or city.</p>
      </div>
    </section>
  </main>

  <div class="filters-overlay" id="filtersOverlay"></div>
  <aside class="filters-drawer" id="filtersDrawer" aria-hidden="true">
    <div class="filters-drawer__header">
      <button class="filters-close" id="filtersClose" type="button">Close</button>
      <strong>Filters</strong>
      <button class="button ghost" id="clearFiltersBtn" type="button" style="min-width:96px;">Clear</button>
    </div>
    <div class="filters-drawer__body">
      <div class="filter-group">
        <h3>Location</h3>
        <label for="filterCountry">Country</label>
        <select id="filterCountry" class="input">
          <option value="">Any</option>
        </select>
        <label for="filterState">State/Region</label>
        <select id="filterState" class="input">
          <option value="">Any</option>
        </select>
        <label for="filterCity">City</label>
        <input id="filterCity" class="input" list="filterCityList" placeholder="Type a city" />
        <datalist id="filterCityList"></datalist>
      </div>
      <div class="filter-group">
        <h3>Price</h3>
        <div class="filter-row">
          <div>
            <label for="priceMin">Min</label>
            <input id="priceMin" class="input" type="number" min="0" placeholder="0" />
          </div>
          <div>
            <label for="priceMax">Max</label>
            <input id="priceMax" class="input" type="number" min="0" placeholder="500" />
          </div>
        </div>
      </div>
      <div class="filter-group">
        <h3>Vehicle</h3>
        <div class="filter-row">
          <div>
            <label for="yearMin">Year from</label>
            <input id="yearMin" class="input" type="number" min="1980" max="2100" />
          </div>
          <div>
            <label for="yearMax">Year to</label>
            <input id="yearMax" class="input" type="number" min="1980" max="2100" />
          </div>
        </div>
        <label for="makeFilter">Make/Brand</label>
        <input id="makeFilter" class="input" list="makeFilterList" placeholder="Any brand" />
        <datalist id="makeFilterList"></datalist>
        <label for="transmission">Transmission</label>
        <select id="transmission" class="input">
          <option value="">Any</option>
          <option value="Automatic">Automatic</option>
          <option value="Manual">Manual</option>
          <option value="CVT">CVT</option>
        </select>
        <label for="fuel">Fuel</label>
        <select id="fuel" class="input">
          <option value="">Any</option>
          <option value="Gas">Gas</option>
          <option value="Diesel">Diesel</option>
          <option value="Hybrid">Hybrid</option>
          <option value="Electric">Electric</option>
        </select>
        <label for="seats">Seats</label>
        <select id="seats" class="input">
          <option value="">Any</option>
          <option value="2">2</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
          <option value="7">7</option>
          <option value="8">8+</option>
        </select>
        <label for="frequency">Price frequency</label>
        <select id="frequency" class="input">
          <option value="">Any</option>
          <option value="Daily">Daily</option>
          <option value="Weekly">Weekly</option>
          <option value="Monthly">Monthly</option>
        </select>
      </div>
    </div>
    <div class="filters-drawer__footer">
      <button class="button ghost" id="drawerClear" type="button">Clear all</button>
      <button class="button" id="applyFiltersBtn" type="button">Apply</button>
    </div>
  </aside>

            <script>
    const menuPanel = document.getElementById("menuPanel");
    const backdrop = document.getElementById("backdrop");
    const openBtn = document.getElementById("menuToggle");
    const closeBtn = document.getElementById("menuClose");
    const openMenu = () => { menuPanel.classList.add("open"); backdrop.classList.add("show"); };
    const closeMenu = () => { menuPanel.classList.remove("open"); backdrop.classList.remove("show"); };
    const syncAuth = () => AuthManager.updateUIForRole();
    document.addEventListener("ccr:signedOut", syncAuth);
    document.addEventListener("ccr:signedIn", syncAuth);
    document.addEventListener("DOMContentLoaded", syncAuth);
    if (document.readyState !== "loading") syncAuth();
    
    // Wire menu Sign In click handler to open login UI (no auto-login)
    const menuSignIn = document.querySelector(".menu-signin");
    if (menuSignIn) {
      menuSignIn.addEventListener("click", (e) => {
        e.preventDefault();
        window.location.href = "account.html#signin";
        closeMenu();
      });
    }
    openBtn?.addEventListener("click", openMenu);
    closeBtn?.addEventListener("click", closeMenu);
    backdrop?.addEventListener("click", closeMenu);

    const normalizeLocation = (value) => (value ?? "").toString().trim().toLowerCase();
    const clean = (value) => (value ?? "").toString().trim();
    const matchesFilter = (value, filter) => {
      if (!filter) return true;
      if (!value) return false;
      return value.includes(filter);
    };

    const toTitleCase = (value) => {
      const s = clean(value);
      if (!s) return '';
      return s
        .split(/\s+/g)
        .map((w) => w ? (w[0].toUpperCase() + w.slice(1).toLowerCase()) : w)
        .join(' ');
    };

    const sanitizeYear = (year) => {
      const y = Number(year);
      if (!Number.isFinite(y)) return '';
      const max = new Date().getFullYear() + 1;
      if (y < 1985 || y > max) return '';
      return String(y);
    };

    const normalizeCategory = (value) => {
      const raw = clean(value);
      if (!raw) return 'Vehicle';
      const normalized = toTitleCase(raw);
      const allowed = new Set(['SUV','Sedan','Coupe','Truck','Bike','Convertible','Minivan','Hatchback','Station Wagon','Bus','Wagon']);
      if (allowed.has(normalized)) return normalized;
      if (normalized === 'Stationwagon') return 'Station Wagon';
      return 'Vehicle';
    };

    const normalizeFuel = (value) => {
      const raw = toTitleCase((value ?? '').toString().trim());
      const allowed = new Set(['Gas','Diesel','Hybrid','Electric']);
      return allowed.has(raw) ? raw : '';
    };

    const shouldHideMetaForMismatch = ({ make, model, category, fuel }) => {
      const m = (model || '').toString().toLowerCase();
      const mk = (make || '').toString().toLowerCase();
      const cat = (category || '').toString().toLowerCase();
      const fu = (fuel || '').toString().toLowerCase();

      const looksPassenger = /(accord|civic|camry|corolla|altima|sentra|malibu|impala|elantra|sonata|fusion|focus|prius|model\s*3|model\s*s|model\s*y|model\s*x|a4|a6|c-?class|e-?class|3\s*series|5\s*series|golf|jetta)/.test(m);
      const looksElectricModel = /(model\s*3|model\s*s|model\s*y|model\s*x|leaf|bolt|ioniq|ev|mach-?e|id\.?4|taycan)/.test(m);

      const dieselUnlikelyMake = /^(honda|toyota|nissan|hyundai|kia)$/.test(mk);
      const dieselUnlikelyModel = /(accord|civic|camry|corolla|altima|sentra|elantra|sonata|prius)/.test(m);

      if ((cat === 'truck' || cat === 'bus' || cat === 'bike') && looksPassenger) return true;
      if (looksElectricModel && fu === 'diesel') return true;
      if (mk === 'honda' && cat === 'truck' && looksPassenger) return true;

      if (fu === 'diesel' && (dieselUnlikelyMake || dieselUnlikelyModel)) return true;
      return false;
    };

    const normalizeFrequency = (value) => {
      const v = clean(value).toLowerCase();
      if (!v) return 'Daily';
      if (v.startsWith('day')) return 'Daily';
      if (v.startsWith('week')) return 'Weekly';
      if (v.startsWith('month')) return 'Monthly';
      return 'Daily';
    };

    const formatPrice = (price, frequency) => {
      const n = Number(price);
      const freq = normalizeFrequency(frequency);
      const unit = (freq === 'Weekly') ? 'week' : (freq === 'Monthly') ? 'month' : 'day';
      if (!Number.isFinite(n) || n <= 0) return `Contact for price / ${unit}`;
      return `$${n} / ${unit}`;
    };

    const normalizeVehicle = (v) => {
      const make = toTitleCase(v?.make);
      const model = toTitleCase(v?.model);
      const country = toTitleCase(v?.country);
      const state = toTitleCase(v?.state);
      const city = toTitleCase(v?.city);
      const category = normalizeCategory(v?.vehicleType || v?.category);
      const fuel = normalizeFuel(v?.fuelType || v?.fuel);
      const frequency = normalizeFrequency(v?.frequency || v?.priceFrequency);
      const year = sanitizeYear(v?.year || v?.modelYear);
      const price = (v?.price != null ? v.price : (v?.pricePerDay != null ? v.pricePerDay : v?.pricePerWeek != null ? v.pricePerWeek : v?.pricePerMonth != null ? v.pricePerMonth : 0));

      const hideMeta = shouldHideMetaForMismatch({ make, model, category, fuel });
      return {
        ...v,
        make,
        model,
        country,
        state,
        city,
        category: hideMeta ? 'Vehicle' : category,
        fuel: hideMeta ? '' : fuel,
        frequency,
        year,
        price
      };
    };

    const renderGridLoading = () => {
      if (!vehiclesGrid) return;
      if (noVehiclesMsg) noVehiclesMsg.style.display = 'none';
      if (filterVehiclesMsg) filterVehiclesMsg.style.display = 'none';
      if (vehicleCount) vehicleCount.textContent = 'Loading vehicles…';
      vehiclesGrid.innerHTML = Array.from({ length: 8 }).map(() => {
        return `
          <article class="card vehicle-card" aria-hidden="true">
            <div class="vehicle-card-link">
              <div class="vehicle-card-image skeleton"></div>
              <div class="vehicle-card-body">
                <div class="vehicle-spec skeleton skeleton-line sm" style="width: 58%;"></div>
                <div class="vehicle-title skeleton skeleton-line lg" style="width: 92%;"></div>
                <div class="vehicle-location skeleton skeleton-line md" style="width: 70%;"></div>
                <div class="vehicle-bottom" style="margin-top: 10px;">
                  <div class="vehicle-price skeleton skeleton-line lg" style="width: 44%;"></div>
                  <div class="badges" style="width: 40%;">
                    <div class="badge skeleton" style="height: 26px; width: 100%; border-radius: 10px;"></div>
                  </div>
                </div>
              </div>
            </div>
          </article>
        `;
      }).join('');
    };

    const vehiclesGrid = document.getElementById("vehiclesGrid");
    const noVehiclesMsg = document.getElementById("noVehiclesMsg");
    const filterVehiclesMsg = document.getElementById("filterVehiclesMsg");
    const vehicleCount = document.getElementById("vehicleCount");
    const filterCountry = document.getElementById("filterCountry");
    const filterState = document.getElementById("filterState");
    const filterCity = document.getElementById("filterCity");
    const filterCityList = document.getElementById("filterCityList");
    const priceMinInput = document.getElementById("priceMin");
    const priceMaxInput = document.getElementById("priceMax");
    const yearMinInput = document.getElementById("yearMin");
    const yearMaxInput = document.getElementById("yearMax");
    const makeFilter = document.getElementById("makeFilter");
    const makeFilterList = document.getElementById("makeFilterList");
    const transmissionSelect = document.getElementById("transmission");
    const fuelSelect = document.getElementById("fuel");
    const seatsSelect = document.getElementById("seats");
    const frequencySelect = document.getElementById("frequency");
    const applyFiltersBtn = document.getElementById("applyFiltersBtn");
    const clearFiltersBtn = document.getElementById("clearFiltersBtn");
    const clearFiltersQuick = document.getElementById("clearFiltersQuick");
    const filtersToggle = document.getElementById("filtersToggle");
    const filtersOverlay = document.getElementById("filtersOverlay");
    const filtersDrawer = document.getElementById("filtersDrawer");
    const filtersClose = document.getElementById("filtersClose");
    const drawerClear = document.getElementById("drawerClear");
    const filterCountBadge = document.getElementById("filterCountBadge");
    const activeChips = document.getElementById("activeChips");

    let allVehicles = [];
    const stateCache = new Map();
    let drawerOpen = false;

    const setBadgeCount = (count) => {
      if (!filterCountBadge) return;
      filterCountBadge.textContent = count;
    };
    setBadgeCount(0);

    const openFilters = () => {
      filtersDrawer?.classList.add("open");
      filtersOverlay?.classList.add("show");
      filtersDrawer?.setAttribute("aria-hidden", "false");
      filtersToggle?.setAttribute("aria-expanded", "true");
      drawerOpen = true;
    };

    const closeFilters = () => {
      filtersDrawer?.classList.remove("open");
      filtersOverlay?.classList.remove("show");
      filtersDrawer?.setAttribute("aria-hidden", "true");
      filtersToggle?.setAttribute("aria-expanded", "false");
      drawerOpen = false;
    };

    const fetchStates = async (country) => {
      if (!country) {
        populateSelect(filterState, []);
        if (filterCity) filterCity.value = '';
        if (filterCityList) filterCityList.innerHTML = '';
        return;
      }
      if (stateCache.has(country)) {
        populateSelect(filterState, stateCache.get(country));
        if (filterCity) filterCity.value = '';
        if (filterCityList) filterCityList.innerHTML = '';
        return;
      }
      try {
        const resp = await fetch('https://countriesnow.space/api/v0.1/countries/states', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ country })
        });
        if (!resp.ok) throw new Error('Failed to load states');
        const data = await resp.json();
        const list = (data?.data?.states || []).map((s) => s?.name).filter(Boolean);
        stateCache.set(country, list);
        populateSelect(filterState, list);
        if (filterCity) filterCity.value = '';
        if (filterCityList) filterCityList.innerHTML = '';
      } catch (e) {
        console.warn('State lookup failed', e.message);
        populateSelect(filterState, []);
        if (filterCity) filterCity.value = '';
        if (filterCityList) filterCityList.innerHTML = '';
      }
    };

    const hasMinimumFields = (vehicle) => {
      if (!vehicle) return false;
      // Keep the UI resilient: allow missing price/image/year/etc and fall back gracefully
      const make = clean(vehicle.make);
      const model = clean(vehicle.model);
      return Boolean(make || model || clean(vehicle.category || vehicle.vehicleType));
    };

    const renderVehicles = (list, { isFiltered = false } = {}) => {
      if (!vehiclesGrid) return;
      const validList = (Array.isArray(list) ? list : []).filter(hasMinimumFields).map(normalizeVehicle);

      if (validList.length === 0) {
        vehiclesGrid.innerHTML = "";
        if (noVehiclesMsg) noVehiclesMsg.style.display = "none";
        if (filterVehiclesMsg) filterVehiclesMsg.style.display = "none";

        const showEmptyBlock = (target) => {
          if (!target) return;
          target.innerHTML = `
            <div class="empty-block">
              <div class="empty-icon" aria-hidden="true">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 21H3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M7 14l3-3 4 4 3-3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M7 10h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round"/></svg>
              </div>
              <div class="empty-title">No vehicles found</div>
              <p class="muted">Try removing a filter, choosing a nearby city, or switching price frequency.</p>
              <div class="empty-actions">
                <button class="button ghost" type="button" id="clearFiltersCta">Clear filters</button>
                <a class="button" href="vehicles.html">Browse all vehicles</a>
              </div>
            </div>
          `;
          setTimeout(() => {
            document.getElementById('clearFiltersCta')?.addEventListener('click', clearFilters);
          }, 0);
        };

        if (allVehicles.length === 0) {
          if (vehicleCount) vehicleCount.textContent = "No vehicles found";
          if (noVehiclesMsg) {
            noVehiclesMsg.style.display = "block";
            showEmptyBlock(noVehiclesMsg);
          }
        } else {
          if (vehicleCount) vehicleCount.textContent = isFiltered ? "0 vehicles match filters" : "No vehicles found";
          if (filterVehiclesMsg) {
            filterVehiclesMsg.style.display = "block";
            showEmptyBlock(filterVehiclesMsg);
          }
        }
        return;
      }

      if (noVehiclesMsg) noVehiclesMsg.style.display = "none";
      if (filterVehiclesMsg) filterVehiclesMsg.style.display = "none";
      if (vehicleCount) vehicleCount.textContent = `${validList.length} vehicle${validList.length === 1 ? "" : "s"} available`;

      vehiclesGrid.innerHTML = validList.map(vehicle => {
        const placeholderSvg = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 300"><defs><linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:%23e5e7eb;stop-opacity:1" /><stop offset="100%" style="stop-color:%23d1d5db;stop-opacity:1" /></linearGradient></defs><rect fill="url(%23grad)" width="400" height="300"/><g transform="translate(200, 80)"><circle cx="0" cy="0" r="35" fill="%23999" opacity="0.3"/></g><g transform="translate(200, 160)"><rect x="-60" y="0" width="120" height="70" rx="8" fill="none" stroke="%23999" stroke-width="3" opacity="0.3"/><rect x="-50" y="10" width="30" height="20" rx="4" fill="%23999" opacity="0.3"/><rect x="20" y="10" width="30" height="20" rx="4" fill="%23999" opacity="0.3"/><rect x="-35" y="50" width="70" height="8" rx="4" fill="%23999" opacity="0.3"/></g><text x="200" y="280" text-anchor="middle" font-family="Arial" font-size="16" fill="%23999" opacity="0.5">No photo</text></svg>';
        const image = vehicle.image || (vehicle.photos && vehicle.photos[0]) || placeholderSvg;

        const insuranceIncluded = vehicle.insuranceIncluded === true || clean(vehicle.insurance || '').toLowerCase() === 'included' || clean(vehicle.insurance || '').toLowerCase() === 'yes';
        const insuranceLabel = insuranceIncluded ? 'Insurance included' : 'Insurance not included';
        const insuranceClass = insuranceIncluded ? 'badge badge--success' : 'badge badge--danger';
        const availability = clean(vehicle.availability || '').toLowerCase() === 'rented' ? 'rented' : 'available';

        const specLine = [vehicle.year, (vehicle.category && vehicle.category !== 'Vehicle') ? vehicle.category : '', vehicle.fuel].filter(Boolean).join(' • ');
        const locationLine = [vehicle.city, vehicle.state || vehicle.country].filter(Boolean).join(' • ');
        const title = [vehicle.make, vehicle.model].filter(Boolean).join(' ').trim() || 'Vehicle';
        const priceLabel = formatPrice(vehicle.price, vehicle.frequency);

        const badges = [];
        if (availability === 'rented') badges.push('<span class="badge badge--danger">Rented</span>');
        badges.push(`<span class="${insuranceClass}">${insuranceLabel}</span>`);
        const isInstant = vehicle.instantBook === true || clean(vehicle.instantBook || '').toLowerCase() === 'yes';
        const isPopular = vehicle.popular === true || clean(vehicle.popular || '').toLowerCase() === 'yes';
        if (badges.length < 2 && isInstant) badges.push('<span class="badge">Instant book</span>');
        else if (badges.length < 2 && isPopular) badges.push('<span class="badge">Popular</span>');

        return `
          <article class="card vehicle-card"
            data-vehicle-id="${vehicle.id}"
            data-type="${clean(vehicle.category)}"
            data-country="${clean(vehicle.country)}"
            data-state="${clean(vehicle.state)}"
            data-city="${clean(vehicle.city)}"
            data-price="${vehicle.price || ''}"
            data-year="${clean(vehicle.year)}"
            data-make="${clean(vehicle.make)}"
            data-transmission="${clean(vehicle.transmission)}"
            data-fuel="${clean(vehicle.fuel)}"
            data-seats="${vehicle.seats || ''}"
            data-frequency="${clean(vehicle.frequency)}">
            <a href="vehicle.html?id=${vehicle.id}" class="vehicle-card-link">
              <div class="vehicle-card-image"><img src="${image}" alt="${title}" /></div>
              <div class="vehicle-card-body">
                <div class="vehicle-spec">${specLine || ''}</div>
                <div class="vehicle-title line-clamp-2">${title}</div>
                <div class="vehicle-location">${locationLine || ''}</div>
                <div class="vehicle-bottom">
                  <div class="vehicle-price">${priceLabel}</div>
                  <div class="badges">${badges.slice(0,2).join('')}</div>
                </div>
              </div>
            </a>
          </article>
        `;
      }).join("");

      console.log("? Vehicles rendered successfully");
    };

    const populateSelect = (selectEl, values) => {
      if (!selectEl) return;
      selectEl.innerHTML = '<option value="">Any</option>';
      values.forEach((value) => {
        const opt = document.createElement("option");
        opt.value = value;
        opt.textContent = value;
        selectEl.appendChild(opt);
      });
    };

    const populateMakeOptions = (vehicles = []) => {
      if (!makeFilterList) return;
      makeFilterList.innerHTML = '';
      const makes = [...new Set(
        (vehicles || [])
          .map((veh) => clean(veh.make))
          .filter(Boolean)
      )];
      makes.sort((a, b) => a.localeCompare(b, undefined, { sensitivity: 'base' }));
      makes.forEach((make) => {
        const option = document.createElement("option");
        option.value = make;
        makeFilterList.appendChild(option);
      });
    };

    const buildFilterOptions = () => {
      if (filterCountry && window.populateCountryElement) {
        populateCountryElement(filterCountry);
      }
      // States are populated on demand after country selection; city is typed
      populateSelect(filterState, []);
      if (filterCity) filterCity.value = '';
      if (filterCityList) filterCityList.innerHTML = '';
    };

    const renderActiveChips = (chips) => {
      if (!activeChips) return;
      activeChips.innerHTML = '';
      chips.forEach(({ label, clear }) => {
        const chip = document.createElement('span');
        chip.className = 'active-chip';
        chip.innerHTML = `${label} x`;
        chip.onclick = clear;
        activeChips.appendChild(chip);
      });
      setBadgeCount(chips.length);
    };

    const renderDefaultView = () => {
      renderActiveChips([]);
      renderVehicles(allVehicles, { isFiltered: false });
    };

    const applyFilters = () => {
      const countryNorm = normalizeLocation(filterCountry?.value || "");
      const stateNorm = normalizeLocation(filterState?.value || "");
      const cityNorm = normalizeLocation(filterCity?.value || "");
      const priceMin = Number(priceMinInput?.value || '');
      const priceMax = Number(priceMaxInput?.value || '');
      const yearMin = Number(yearMinInput?.value || '');
      const yearMax = Number(yearMaxInput?.value || '');
      const makeValue = (makeFilter?.value || '').trim();
      const transmissionValue = (transmissionSelect?.value || '').trim();
      const fuelValue = (fuelSelect?.value || '').trim();
      const seatsValue = (seatsSelect?.value || '').trim();
      const frequencyValue = (frequencySelect?.value || '').trim();

      const freqNorm = normalizeLocation(frequencyValue);
      const makeNorm = normalizeLocation(makeValue);
      const transmissionNorm = normalizeLocation(transmissionValue);
      const fuelNorm = normalizeLocation(fuelValue);

      const filtered = allVehicles.filter((vehicle) => {
        if (!hasMinimumFields(vehicle)) return false;
        const vCountry = normalizeLocation(vehicle.country);
        const vState = normalizeLocation(vehicle.state);
        const vCity = normalizeLocation(vehicle.city);
        const vPrice = Number(vehicle.price || 0);
        const vYear = Number(vehicle.year || 0);
        const vMake = normalizeLocation(vehicle.make);
        const vTrans = normalizeLocation(vehicle.transmission);
        const vFuel = normalizeLocation(vehicle.fuel || vehicle.fuelType);
        const vSeats = Number(vehicle.seats || 0);
        const vFreq = normalizeLocation(vehicle.frequency || vehicle.priceFrequency);

        if (!matchesFilter(vCountry, countryNorm)) return false;
        if (!matchesFilter(vState, stateNorm)) return false;
        if (!matchesFilter(vCity, cityNorm)) return false;

        if (priceMin && vPrice < priceMin) return false;
        if (priceMax && vPrice > priceMax) return false;
        if (yearMin && vYear < yearMin) return false;
        if (yearMax && vYear > yearMax) return false;
        if (makeNorm && vMake !== makeNorm) return false;
        if (transmissionNorm && vTrans !== transmissionNorm) return false;
        if (fuelNorm && vFuel !== fuelNorm) return false;
        if (seatsValue) {
          if (seatsValue === '8+') {
            if (vSeats < 8) return false;
          } else if (vSeats !== Number(seatsValue)) {
            return false;
          }
        }
        if (freqNorm && vFreq !== freqNorm) return false;

        return true;
      });

      const chips = [];
      if (countryNorm) chips.push({ label: filterCountry.value, clear: () => { filterCountry.value=''; applyFilters(); }});
      if (stateNorm) chips.push({ label: filterState.value, clear: () => { filterState.value=''; applyFilters(); }});
      if (cityNorm) chips.push({ label: filterCity.value, clear: () => { filterCity.value=''; applyFilters(); }});
      if (priceMin) chips.push({ label: `Min $${priceMin}`, clear: () => { priceMinInput.value=''; applyFilters(); }});
      if (priceMax) chips.push({ label: `Max $${priceMax}`, clear: () => { priceMaxInput.value=''; applyFilters(); }});
      if (yearMin) chips.push({ label: `Year >= ${yearMin}`, clear: () => { yearMinInput.value=''; applyFilters(); }});
      if (yearMax) chips.push({ label: `Year <= ${yearMax}`, clear: () => { yearMaxInput.value=''; applyFilters(); }});
      if (makeNorm) chips.push({ label: makeFilter.value, clear: () => { makeFilter.value=''; applyFilters(); }});
      if (transmissionNorm) chips.push({ label: transmissionValue, clear: () => { transmissionSelect.value=''; applyFilters(); }});
      if (fuelNorm) chips.push({ label: fuelValue, clear: () => { fuelSelect.value=''; applyFilters(); }});
      if (seatsValue) chips.push({ label: `${seatsValue}+ seats`, clear: () => { seatsSelect.value=''; applyFilters(); }});
      if (frequencyValue) chips.push({ label: frequencyValue, clear: () => { frequencySelect.value=''; applyFilters(); }});
      renderActiveChips(chips);

      renderVehicles(filtered, { isFiltered: true });
      if (drawerOpen) closeFilters();
    };

    // Load vehicles from VehicleStore (single source of truth)
    const loadVehicles = async () => {
      console.log("Loading vehicles from VehicleStore...");

      renderGridLoading();
      
      // Get only ACTIVE vehicles for public display
      const activeVehicles = await VehicleStore.getActiveVehicles();
      allVehicles = (activeVehicles || []).map((v) => normalizeVehicle(v));

      populateMakeOptions(allVehicles);
      buildFilterOptions();

      const params = new URLSearchParams(window.location.search);
      const urlCountry = (params.get('country') || '').trim();
      const urlState = (params.get('state') || '').trim();
      const urlCity = (params.get('city') || '').trim();

      let used = false;
      if (urlCountry && filterCountry) {
        filterCountry.value = urlCountry;
        await fetchStates(urlCountry);
        used = true;
      } else if (filterCountry) {
        await fetchStates(filterCountry.value);
      }

      if (urlState && filterState) {
        filterState.value = urlState;
        used = true;
      }
      if (urlCity && filterCity) {
        filterCity.value = urlCity;
        used = true;
      }

      if (used) {
        applyFilters();
      } else {
        renderDefaultView();
      }
    };

    // Wait for VehicleStore to be available before loading
    const initWhenReady = () => {
      if (!window.VehicleStore) {
        setTimeout(initWhenReady, 100);
        return;
      }
      console.log("? VehicleStore ready, loading vehicles");
      loadVehicles();

      // Reload when page becomes visible (e.g., when user returns from adding a vehicle)
      document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === "visible") {
          console.log("Page visible - reloading vehicles");
          loadVehicles();
        }
      });
    };

    // Hook up filter events
    filterCountry?.addEventListener("change", () => {
      // Reset child filters when parent changes
      if (filterState) filterState.value = "";
      if (filterCity) filterCity.value = "";
      fetchStates(filterCountry.value);
    });

    filterState?.addEventListener("change", () => {
      if (filterCity) filterCity.value = "";
    });

    filterCity?.addEventListener("input", () => {}); // keep input responsive without auto-applying

    const clearFilters = () => {
      if (filterCountry) filterCountry.value = "";
      if (filterState) filterState.value = "";
      if (filterCity) filterCity.value = "";
      if (priceMinInput) priceMinInput.value = "";
      if (priceMaxInput) priceMaxInput.value = "";
      if (yearMinInput) yearMinInput.value = "";
      if (yearMaxInput) yearMaxInput.value = "";
      if (makeFilter) makeFilter.value = "";
      if (transmissionSelect) transmissionSelect.value = "";
      if (fuelSelect) fuelSelect.value = "";
      if (seatsSelect) seatsSelect.value = "";
      if (frequencySelect) frequencySelect.value = "";
      if (filterCountry) fetchStates('');
      renderDefaultView();
    };

    filtersToggle?.addEventListener("click", () => {
      drawerOpen ? closeFilters() : openFilters();
    });
    filtersOverlay?.addEventListener("click", closeFilters);
    filtersClose?.addEventListener("click", closeFilters);
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && drawerOpen) closeFilters();
    });

    applyFiltersBtn?.addEventListener("click", applyFilters);
    clearFiltersBtn?.addEventListener("click", clearFilters);
    drawerClear?.addEventListener("click", clearFilters);
    clearFiltersQuick?.addEventListener("click", clearFilters);

    // Start once ready
    initWhenReady();
  </script>

  <!-- Footer with Legal Links -->
  <footer style="background: #f8f9fa; border-top: 1px solid #e5e7eb; padding: 32px 20px; margin-top: 48px;">
    <div style="max-width: 1200px; margin: 0 auto; text-align: center;">
      <p style="margin: 0 0 16px 0; font-size: 14px; color: #666; line-height: 1.6;">
        <strong>CJF is an advertising platform only.</strong> All rentals, payments, and agreements occur directly between Host and Renter. CJF is not responsible for scams, disputes, damages, or vehicle issues.
      </p>
      <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 16px; margin-top: 16px;">
        <a href="terms.html" style="color: var(--accent); font-size: 14px;">Terms & Conditions</a>
        <a href="privacy.html" style="color: var(--accent); font-size: 14px;">Privacy Policy</a>
        <a href="host-agreement.html" style="color: var(--accent); font-size: 14px;">Host Agreement</a>
        <a href="safety.html" style="color: var(--accent); font-size: 14px;">Safety Guidelines</a>
        <a href="https://www.tiktok.com/@cjfrentals" target="_blank" rel="noopener" style="color: var(--accent); font-size: 14px;">TikTok</a>
        <a href="contact.html" style="color: var(--accent); font-size: 14px;">Contact Support</a>
      </div>
      <p style="margin: 16px 0 0 0; font-size: 13px; color: #999;">Â© 2025 CJF. All rights reserved.</p>
    </div>
  </footer>

  <!-- Firebase and Auth Scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="assets/firebase.js?v=3"></script>
  <script src="assets/auth.js?v=3"></script>
  <script src="assets/vehicleStore.js?v=3"></script>
  <script src="assets/navBuilder.js?v=3"></script>
</body>
</html>
